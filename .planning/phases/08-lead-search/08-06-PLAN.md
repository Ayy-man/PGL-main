---
phase: 08-lead-search
plan: "06"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/[orgId]/search/hooks/use-search.ts
  - src/app/[orgId]/search/components/search-content.tsx
autonomous: true
gap_closure: true
requirements: [SRCH-05]

must_haves:
  truths:
    - "Advanced filter fields (titles, locations, industries, seniorities) pass through to Apollo API when applied"
    - "Applying filters with titles like 'CEO, CFO' narrows search results via Apollo person_titles parameter"
    - "Clearing filters removes overrides and re-executes search with persona-only filters"
  artifacts:
    - path: "src/app/[orgId]/search/hooks/use-search.ts"
      provides: "filterOverrides parameter accepted and included in API fetch body"
      contains: "filterOverrides"
    - path: "src/app/[orgId]/search/components/search-content.tsx"
      provides: "handleApplyFilters stores all filter fields, not just keywords"
      contains: "filterOverrides"
  key_links:
    - from: "src/app/[orgId]/search/components/search-content.tsx"
      to: "src/app/[orgId]/search/hooks/use-search.ts"
      via: "filterOverrides state passed to useSearch or included in fetch body"
      pattern: "filterOverrides"
    - from: "src/app/[orgId]/search/hooks/use-search.ts"
      to: "/api/search/apollo"
      via: "filterOverrides in fetch body JSON"
      pattern: "filterOverrides.*titles|locations|industries|seniorities"
---

<objective>
Wire advanced filter fields (titles, locations, industries, seniorities) from AdvancedFiltersPanel through SearchContent and useSearch to the Apollo API.

Purpose: Close Gap 1 from 08-VERIFICATION.md — AdvancedFiltersPanel collects 4 filter fields but handleApplyFilters only forwards keywords, silently dropping titles/locations/industries/seniorities. The API route and schema already support full filterOverrides.

Output: Advanced filters fully functional — applying title/location/industry/seniority filters reaches Apollo API via the existing filterOverrides mechanism.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/08-lead-search/08-VERIFICATION.md
@.planning/phases/08-lead-search/08-04-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/lib/apollo/schemas.ts:
```typescript
export const PersonaFilters = z.object({
  titles: z.array(z.string()).optional(),
  seniorities: z.array(z.string()).optional(),
  industries: z.array(z.string()).optional(),
  locations: z.array(z.string()).optional(),
  companySize: z.array(z.string()).optional(),
  keywords: z.string().optional(),
});

export const searchRequestSchema = z.object({
  personaId: z.string().uuid(),
  page: z.number().int().min(1).max(500).default(1),
  pageSize: z.number().int().min(1).max(10).default(10),
  filterOverrides: PersonaFilters.optional(),
});

export type PersonaFiltersType = z.infer<typeof PersonaFilters>;
```

From src/lib/personas/types.ts:
```typescript
export interface PersonaFilters {
  titles?: string[];
  seniorities?: string[];
  industries?: string[];
  locations?: string[];
  companySize?: string[];
  keywords?: string;
}
```

From src/app/api/search/apollo/route.ts (lines 49, 82-84):
```typescript
const { personaId, page, pageSize, filterOverrides } = validationResult.data;
// ...
const mergedFilters = filterOverrides
  ? { ...persona.filters, ...filterOverrides }
  : persona.filters;
```

From src/app/[orgId]/search/components/advanced-filters-panel.tsx:
```typescript
interface AdvancedFiltersPanelProps {
  onApplyFilters: (filters: Partial<PersonaFilters>) => void;
  initialFilters?: Partial<PersonaFilters>;
}
// handleApply builds: { titles?: string[], locations?: string[], industries?: string[], seniorities?: string[] }
```

From src/app/[orgId]/search/hooks/use-search.ts (current fetch body, line 96-101):
```typescript
body: JSON.stringify({
  personaId: searchState.persona,
  page: searchState.page,
  pageSize: 10,
  ...(searchState.keywords ? { filterOverrides: { keywords: searchState.keywords } } : {}),
}),
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add filterOverrides support to useSearch hook and wire SearchContent</name>
  <files>src/app/[orgId]/search/hooks/use-search.ts, src/app/[orgId]/search/components/search-content.tsx</files>
  <action>
  **In `use-search.ts`:**

  1. Add a `filterOverrides` ref or state that can be set externally. The cleanest approach: add an `externalFilterOverrides` parameter to the `useSearch` return interface and accept it via a `setFilterOverrides` function. Specifically:
     - Add `const [filterOverrides, setFilterOverrides] = useState<Partial<PersonaFiltersType>>({})` at the top of the hook (import `PersonaFiltersType` from `@/lib/apollo/schemas`)
     - Expose `filterOverrides` and `setFilterOverrides` in the return object
     - Add `filterOverrides` to the `SearchResult` interface return type

  2. Update the fetch body construction (around line 96-101) to merge `filterOverrides` with `keywords`:
     ```typescript
     const hasKeywords = searchState.keywords;
     const hasFilterOverrides = Object.keys(filterOverrides).length > 0;
     const mergedOverrides = {
       ...(hasKeywords ? { keywords: searchState.keywords } : {}),
       ...filterOverrides,
     };
     // In fetch body:
     body: JSON.stringify({
       personaId: searchState.persona,
       page: searchState.page,
       pageSize: 10,
       ...(Object.keys(mergedOverrides).length > 0 ? { filterOverrides: mergedOverrides } : {}),
     }),
     ```

  3. Add `filterOverrides` to the `useCallback` dependency array of `executeSearch` (currently: `[searchState.persona, searchState.page, searchState.keywords]`). Use `JSON.stringify(filterOverrides)` as a stable dependency key, or use a ref to avoid excessive re-renders. Recommended: use a ref (`filterOverridesRef`) for the fetch body but trigger re-execution via a counter state that increments when `setFilterOverrides` is called.

     Actually, the simplest correct approach: keep `filterOverrides` as state, add it to the dependency array. Since it's an object, use a stringified version for stable comparison. The `useEffect` with 100ms debounce already handles rapid changes.

  **In `search-content.tsx`:**

  1. Destructure `filterOverrides` and `setFilterOverrides` from `useSearch()` return

  2. Rewrite `handleApplyFilters` (lines 122-128) to store ALL filter fields, not just keywords:
     ```typescript
     const handleApplyFilters = (filters: Partial<PersonaFiltersType>) => {
       // Extract keywords separately — it goes to URL state
       if (filters.keywords !== undefined) {
         setSearchState({ keywords: filters.keywords });
       }
       // Store non-keyword overrides for API passthrough
       const { keywords, ...nonKeywordOverrides } = filters;
       setFilterOverrides(nonKeywordOverrides);
     };
     ```

  3. Also add a handler for when AdvancedFiltersPanel calls clear (currently handleClear in the panel sets fields to empty and calls onApplyFilters with an empty object). When an empty object is received, clear filterOverrides:
     - This is already handled by the logic above: if `filters` is `{}`, `nonKeywordOverrides` will be `{}`, and `setFilterOverrides({})` clears them.

  4. Reset `filterOverrides` when persona changes (add to the existing `useEffect` that resets `selectedIds`):
     ```typescript
     useEffect(() => {
       setSelectedIds(new Set());
       setFilterOverrides({});
     }, [searchState.persona]);
     ```

  Do NOT change the AdvancedFiltersPanel component — it already correctly produces the filter object with all 4 fields.
  Do NOT change the API route — it already accepts and merges filterOverrides.
  Do NOT change schemas.ts — PersonaFilters already includes all fields.
  </action>
  <verify>
    <automated>cd /Users/aymanbaig/Desktop/Manual\ Library/Phronesis-main && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
  - handleApplyFilters in SearchContent stores titles, locations, industries, seniorities (not just keywords)
  - useSearch includes all filterOverrides fields in the fetch body sent to /api/search/apollo
  - filterOverrides reset when persona changes
  - TypeScript compiles clean
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Grep `search-content.tsx` for `setFilterOverrides` — confirms non-keyword filters are stored
3. Grep `use-search.ts` for `filterOverrides` in the fetch body — confirms all filter fields reach the API
4. The API route already merges filterOverrides with persona.filters via spread — no API change needed
</verification>

<success_criteria>
- Advanced filter fields (titles, locations, industries, seniorities) from AdvancedFiltersPanel reach the Apollo API via filterOverrides in the search request body
- Keywords continue to work via URL state as before
- Filter overrides reset when switching personas
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-lead-search/08-06-SUMMARY.md`
</output>
