---
phase: 08-lead-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/[orgId]/search/hooks/use-search.ts
  - src/app/api/search/apollo/route.ts
  - src/lib/apollo/schemas.ts
  - src/app/[orgId]/search/components/persona-pills.tsx
autonomous: true
requirements: [SRCH-01, SRCH-04, SRCH-06]

must_haves:
  truths:
    - "URL contains ?prospect=<id> param when managed by useSearch hook"
    - "Persona pills render horizontally with design-system-compliant gold states"
    - "Apollo search API accepts optional filterOverrides body param"
  artifacts:
    - path: "src/app/[orgId]/search/hooks/use-search.ts"
      provides: "Extended useSearch hook with prospect + keywords URL params"
      exports: ["useSearch"]
    - path: "src/app/[orgId]/search/components/persona-pills.tsx"
      provides: "Horizontal persona pill row with active/hover states"
      exports: ["PersonaPills"]
    - path: "src/app/api/search/apollo/route.ts"
      provides: "Extended API accepting filterOverrides"
      exports: ["POST"]
    - path: "src/lib/apollo/schemas.ts"
      provides: "Extended schema with optional filterOverrides"
      exports: ["searchRequestSchema", "PersonaFilters"]
  key_links:
    - from: "use-search.ts"
      to: "nuqs useQueryStates"
      via: "prospect + keywords params added to existing call"
      pattern: "prospect.*parseAsString"
    - from: "route.ts"
      to: "searchApollo()"
      via: "merged persona.filters + filterOverrides"
      pattern: "filterOverrides.*spread"
---

<objective>
Extend the search hook with URL params for slide-over and keywords, extend the Apollo API to accept filter overrides, and create the PersonaPills component.

Purpose: Foundation for unified search layout — the hook manages all URL state, the API supports ad-hoc filters, and persona pills replace the full-page card grid in results context.
Output: Extended useSearch hook, extended API route, PersonaPills component
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/08-lead-search/08-RESEARCH.md
@design-system/MASTER.md
@design-system/pages/search.md

<interfaces>
<!-- Key types and contracts the executor needs. -->

From src/app/[orgId]/search/hooks/use-search.ts:
```typescript
// Current useQueryStates call — ADD prospect + keywords params here
const [searchState, setSearchState] = useQueryStates({
  persona: parseAsString.withDefault(""),
  page: parseAsInteger.withDefault(1),
  sortBy: parseAsString.withDefault("name"),
  sortOrder: parseAsString.withDefault("asc"),
  // ADD: prospect: parseAsString.withDefault(""),
  // ADD: keywords: parseAsString.withDefault(""),
});
```

From src/lib/apollo/schemas.ts:
```typescript
export const searchRequestSchema = z.object({
  personaId: z.string().uuid(),
  page: z.number().int().min(1).max(500).default(1),
  pageSize: z.number().int().min(1).max(10).default(10),
  // ADD: filterOverrides (optional)
});

export const PersonaFilters = z.object({
  titles: z.array(z.string()).optional(),
  seniorities: z.array(z.string()).optional(),
  industries: z.array(z.string()).optional(),
  locations: z.array(z.string()).optional(),
  companySize: z.array(z.string()).optional(),
  keywords: z.string().optional(),
});
```

From src/lib/personas/types.ts:
```typescript
export interface Persona {
  id: string;
  tenant_id: string;
  name: string;
  description: string | null;
  filters: PersonaFilters;
  is_starter: boolean;
  created_by: string;
  last_used_at: string | null;
  created_at: string;
  updated_at: string;
}
```

From src/lib/apollo/types.ts:
```typescript
export interface ApolloPerson {
  id: string;
  first_name: string;
  last_name: string;
  name: string;
  title: string;
  headline?: string;
  organization_name?: string;
  // ... full type in file
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend useSearch hook with prospect, keywords, and filterOverrides URL params</name>
  <files>src/app/[orgId]/search/hooks/use-search.ts</files>
  <action>
  Modify the existing `useSearch` hook:

  1. Add `prospect` and `keywords` to the existing `useQueryStates` call:
     ```typescript
     const [searchState, setSearchState] = useQueryStates({
       persona: parseAsString.withDefault(""),
       page: parseAsInteger.withDefault(1),
       sortBy: parseAsString.withDefault("name"),
       sortOrder: parseAsString.withDefault("asc"),
       prospect: parseAsString.withDefault(""),   // NEW — slide-over URL sync
       keywords: parseAsString.withDefault(""),    // NEW — NL search bar passthrough
     });
     ```

  2. Update the `SearchResult` interface to include the new params in `searchState` type and `setSearchState` update type. Add `prospect: string` and `keywords: string` to both.

  3. In `executeSearch`, include `keywords` in the fetch body if non-empty:
     ```typescript
     body: JSON.stringify({
       personaId: searchState.persona,
       page: searchState.page,
       pageSize: 10,
       ...(searchState.keywords ? { filterOverrides: { keywords: searchState.keywords } } : {}),
     }),
     ```

  4. In the `handleSetSearchState` wrapper, also reset page when `keywords` changes (same pattern as persona change).

  5. Clear `selectedIds` concept is not in this hook (it will be local state in SearchContent), so no action needed there.

  IMPORTANT: Do NOT create a second `useQueryStates` call — add params to the EXISTING one to avoid nuqs param collision (see Pitfall 5 in RESEARCH.md).
  </action>
  <verify>
    <automated>cd /Users/aymanbaig/Desktop/Manual\ Library/Phronesis-main && grep -c "prospect.*parseAsString" src/app/\[orgId\]/search/hooks/use-search.ts && grep -c "keywords.*parseAsString" src/app/\[orgId\]/search/hooks/use-search.ts && grep -c "filterOverrides" src/app/\[orgId\]/search/hooks/use-search.ts</automated>
  </verify>
  <done>useSearch hook returns searchState with prospect and keywords fields, sends filterOverrides in fetch body when keywords present, resets page on keywords change</done>
</task>

<task type="auto">
  <name>Task 2: Extend Apollo search API route to accept optional filterOverrides</name>
  <files>src/app/api/search/apollo/route.ts, src/lib/apollo/schemas.ts</files>
  <action>
  1. In `src/lib/apollo/schemas.ts`, extend `searchRequestSchema` to accept optional `filterOverrides`:
     ```typescript
     export const searchRequestSchema = z.object({
       personaId: z.string().uuid(),
       page: z.number().int().min(1).max(500).default(1),
       pageSize: z.number().int().min(1).max(10).default(10),
       filterOverrides: PersonaFilters.optional(),  // NEW
     });
     ```

  2. In `src/app/api/search/apollo/route.ts`, after fetching persona filters, merge with filterOverrides:
     ```typescript
     const { personaId, page, pageSize, filterOverrides } = validationResult.data;
     // ... fetch persona ...

     // Merge persona filters with ad-hoc overrides
     const mergedFilters = filterOverrides
       ? { ...persona.filters, ...filterOverrides }
       : persona.filters;

     // Pass mergedFilters instead of persona.filters
     const result = await searchApollo(
       tenantId,
       personaId,
       mergedFilters,
       page,
       pageSize
     );
     ```

  The merge uses spread so filterOverrides fields replace persona filter fields where present. If filterOverrides has `keywords: "real estate"`, it replaces the persona's keywords field. Other persona fields remain untouched.

  IMPORTANT: `filterOverrides` is optional — existing API calls without it work exactly as before.
  </action>
  <verify>
    <automated>cd /Users/aymanbaig/Desktop/Manual\ Library/Phronesis-main && grep -c "filterOverrides" src/lib/apollo/schemas.ts && grep -c "filterOverrides" src/app/api/search/apollo/route.ts && grep -c "mergedFilters" src/app/api/search/apollo/route.ts</automated>
  </verify>
  <done>API route accepts optional filterOverrides body param, merges with persona filters, passes merged filters to searchApollo. Existing callers unaffected.</done>
</task>

<task type="auto">
  <name>Task 3: Create PersonaPills horizontal scrollable pill row component</name>
  <files>src/app/[orgId]/search/components/persona-pills.tsx</files>
  <action>
  Create a new file `src/app/[orgId]/search/components/persona-pills.tsx`:

  1. Import `Persona` type from `@/lib/personas/types`.
  2. Import `Plus` icon from `lucide-react`.

  3. Create `PersonaPills` component with props:
     ```typescript
     interface PersonaPillsProps {
       personas: Persona[];
       selectedId: string;
       onSelect: (id: string) => void;
       onCreateNew: () => void;
     }
     ```

  4. Render a horizontal scrollable row (`flex items-center gap-2 overflow-x-auto pb-1`). For each persona, render a `<button>` pill:
     - Shape: `rounded-full px-4 py-1.5 text-[13px] font-medium transition-all duration-200 cursor-pointer shrink-0`
     - Active state (when persona.id === selectedId):
       ```
       style={{ background: "var(--gold-bg)", border: "1px solid var(--border-gold)", color: "var(--gold-primary)" }}
       ```
     - Rest state:
       ```
       style={{ background: "var(--bg-elevated)", border: "1px solid var(--border-default)", color: "var(--text-secondary-ds)" }}
       ```
     - Hover state using onMouseEnter/onMouseLeave (ONLY when not active):
       ```
       onMouseEnter: borderColor = "var(--border-hover)", background = "var(--gold-bg)"
       onMouseLeave: borderColor = "var(--border-default)", background = "var(--bg-elevated)"
       ```
     - Content: colored dot (`h-2 w-2 rounded-full shrink-0`) + persona name. Dot color derived from persona ID hash:
       ```typescript
       function getPersonaColor(id: string): string {
         const hue = id.split("").reduce((acc, c) => acc + c.charCodeAt(0), 0) % 360;
         return `hsl(${hue}, 60%, 50%)`;
       }
       ```

  5. At the end of the row, render a "New Persona" pill with dashed border:
     - `border: "1px dashed var(--border-default)"`, background transparent
     - Plus icon (`h-3 w-3`) + "New Persona" text
     - onClick calls `onCreateNew`
     - Hover: `borderColor = "var(--border-hover)"`, `color = "var(--gold-primary)"`

  6. Add "SAVED PERSONAS" label above the pills row: `text-[10px] uppercase tracking-wider font-semibold mb-2` with color `var(--text-tertiary)`.

  IMPORTANT: Use CSS variable hover pattern (onMouseEnter/Leave), NOT Tailwind hover: classes — per established codebase pattern and design system rule.
  </action>
  <verify>
    <automated>cd /Users/aymanbaig/Desktop/Manual\ Library/Phronesis-main && test -f src/app/\[orgId\]/search/components/persona-pills.tsx && grep -c "PersonaPills" src/app/\[orgId\]/search/components/persona-pills.tsx && grep -c "onMouseEnter" src/app/\[orgId\]/search/components/persona-pills.tsx && grep -c "var(--gold-bg)" src/app/\[orgId\]/search/components/persona-pills.tsx</automated>
  </verify>
  <done>PersonaPills component renders horizontal scrollable pill row with colored dots, gold active state, CSS-variable hover transitions, and "New Persona" dashed pill at end</done>
</task>

</tasks>

<verification>
- `grep -c "prospect" src/app/[orgId]/search/hooks/use-search.ts` returns 3+ (param, type, usage)
- `grep -c "filterOverrides" src/app/api/search/apollo/route.ts` returns 2+ (destructure, merge)
- `test -f src/app/[orgId]/search/components/persona-pills.tsx` passes
- No new npm packages needed — all dependencies already installed
</verification>

<success_criteria>
1. useSearch hook manages prospect, keywords, and all existing URL params in a single useQueryStates call
2. Apollo API route accepts optional filterOverrides and merges with persona filters
3. PersonaPills component renders with design-system-compliant styling (CSS variables, no raw Tailwind colors)
4. All existing search functionality remains unchanged (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/08-lead-search/08-01-SUMMARY.md`
</output>
