---
phase: 08-lead-search
plan: 04
type: execute
wave: 2
depends_on: [08-01, 08-02, 08-03]
files_modified:
  - src/app/[orgId]/search/components/search-content.tsx
  - src/app/[orgId]/search/components/wealth-tier-badge.tsx
autonomous: true
requirements: [SRCH-01, SRCH-02, SRCH-03, SRCH-05, SRCH-06, PROF-01, UI-04, UI-05]

must_haves:
  truths:
    - "Search page shows NL bar + persona pills + results in a unified single-screen layout (no full-page view swap)"
    - "Clicking a persona pill triggers search and shows results below"
    - "Clicking a prospect card opens the ProspectSlideOver panel with URL sync (?prospect=<id>)"
    - "Bulk select checkboxes appear on result cards, bulk actions bar shows when items selected"
    - "Advanced filters toggle expands/collapses filter panel"
    - "NL search bar keywords pass through to Apollo API"
    - "Pagination works with gold active page styling"
  artifacts:
    - path: "src/app/[orgId]/search/components/search-content.tsx"
      provides: "Unified single-screen search layout wiring all components"
      exports: ["SearchContent"]
  key_links:
    - from: "search-content.tsx"
      to: "PersonaPills"
      via: "import and render with selectedId={searchState.persona}"
      pattern: "PersonaPills.*selectedId"
    - from: "search-content.tsx"
      to: "NLSearchBar"
      via: "import and render with onSearch callback"
      pattern: "NLSearchBar.*onSearch"
    - from: "search-content.tsx"
      to: "AdvancedFiltersPanel"
      via: "import and render with onApplyFilters callback"
      pattern: "AdvancedFiltersPanel.*onApplyFilters"
    - from: "search-content.tsx"
      to: "BulkActionsBar"
      via: "import and render with selectedCount and action callbacks"
      pattern: "BulkActionsBar.*selectedCount"
    - from: "search-content.tsx"
      to: "ProspectSlideOver"
      via: "import and render with open={Boolean(searchState.prospect)}"
      pattern: "ProspectSlideOver.*open.*searchState.prospect"
    - from: "search-content.tsx"
      to: "useSearch hook"
      via: "prospect param for slide-over, keywords param for NL bar"
      pattern: "searchState.prospect|searchState.keywords"
---

<objective>
Major rewrite of SearchContent to unified single-screen layout wiring all new components from Plans 01-03, and delete the local WealthTierBadge duplicate.

Purpose: This is the integration plan that transforms the search page from a two-view swap (persona grid vs results) into the mockup's unified layout: NL bar + persona pills always visible, results below, slide-over panel triggered by card click.
Output: Fully functional search page matching the stitch mockup layout
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/08-lead-search/08-RESEARCH.md
@design-system/MASTER.md
@design-system/pages/search.md

# Prior plan context needed for wiring
@.planning/phases/08-lead-search/08-01-SUMMARY.md
@.planning/phases/08-lead-search/08-02-SUMMARY.md
@.planning/phases/08-lead-search/08-03-SUMMARY.md

<interfaces>
<!-- Components created in Plans 01-03 that this plan wires together -->

From src/app/[orgId]/search/hooks/use-search.ts (Plan 01):
```typescript
// searchState now includes prospect and keywords
interface SearchResult {
  searchState: {
    persona: string;
    page: number;
    sortBy: string;
    sortOrder: string;
    prospect: string;    // slide-over URL sync
    keywords: string;    // NL bar passthrough
  };
  setSearchState: (update: Partial<...>) => void;
  results: ApolloPerson[];
  pagination: PaginationState;
  isLoading: boolean;
  error: string | null;
  cached: boolean;
  executeSearch: () => void;
}
```

From src/app/[orgId]/search/components/persona-pills.tsx (Plan 01):
```typescript
interface PersonaPillsProps {
  personas: Persona[];
  selectedId: string;
  onSelect: (id: string) => void;
  onCreateNew: () => void;
}
export function PersonaPills({ personas, selectedId, onSelect, onCreateNew }: PersonaPillsProps);
```

From src/app/[orgId]/search/components/nl-search-bar.tsx (Plan 02):
```typescript
interface NLSearchBarProps {
  initialValue?: string;
  onSearch: (keywords: string) => void;
  isLoading?: boolean;
}
export function NLSearchBar({ initialValue, onSearch, isLoading }: NLSearchBarProps);
```

From src/app/[orgId]/search/components/advanced-filters-panel.tsx (Plan 02):
```typescript
interface AdvancedFiltersPanelProps {
  onApplyFilters: (filters: Partial<PersonaFilters>) => void;
  initialFilters?: Partial<PersonaFilters>;
}
export function AdvancedFiltersPanel({ onApplyFilters, initialFilters }: AdvancedFiltersPanelProps);
```

From src/app/[orgId]/search/components/bulk-actions-bar.tsx (Plan 03):
```typescript
interface BulkActionsBarProps {
  selectedCount: number;
  totalCount: number;
  allSelected: boolean;
  onSelectAll: () => void;
  onAddToList: () => void;
  onExport: () => void;
  onEnrich: () => void;
}
export function BulkActionsBar(props: BulkActionsBarProps);
```

From src/app/[orgId]/search/components/prospect-result-card.tsx (Plan 03):
```typescript
interface ProspectResultCardProps {
  prospect: ApolloPerson;
  lists: List[];
  orgId: string;
  onClick: () => void;
  selected?: boolean;
  onSelect?: () => void;
}
export function ProspectResultCard(props: ProspectResultCardProps);
```

From src/components/prospect/prospect-slide-over.tsx:
```typescript
interface ProspectSlideOverProps {
  open: boolean;
  onClose: () => void;
  prospectId: string | null;
  prospect?: Prospect | null;
  listMemberships?: ListMembership[];
  notes?: Note[];
  orgId?: string;
}
export function ProspectSlideOver(props: ProspectSlideOverProps);
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite SearchContent to unified single-screen layout</name>
  <files>src/app/[orgId]/search/components/search-content.tsx</files>
  <action>
  MAJOR REWRITE of `src/app/[orgId]/search/components/search-content.tsx`. Replace the current two-view swap (persona grid vs results) with a unified single-screen layout.

  1. **Imports:** Add new component imports:
     ```typescript
     import { PersonaPills } from "./persona-pills";
     import { NLSearchBar } from "./nl-search-bar";
     import { AdvancedFiltersPanel } from "./advanced-filters-panel";
     import { BulkActionsBar } from "./bulk-actions-bar";
     import { ProspectSlideOver } from "@/components/prospect/prospect-slide-over";
     ```
     Keep existing: `useSearch`, `ProspectResultCard`, `Search`, `AlertCircle`, `RefreshCw`, `Button`, `EmptyState`, `useRouter`.
     Remove: `PersonaCard`, `CreatePersonaCard` imports (no longer needed in results view).

  2. **Local state for bulk selection:**
     ```typescript
     const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
     ```
     Reset `selectedIds` to empty when `searchState.persona` changes (useEffect).

  3. **Selection handlers:**
     ```typescript
     const handleSelect = (id: string) => {
       setSelectedIds(prev => {
         const next = new Set(prev);
         next.has(id) ? next.delete(id) : next.add(id);
         return next;
       });
     };

     const handleSelectAll = () => {
       if (selectedIds.size === results.length) {
         setSelectedIds(new Set());
       } else {
         setSelectedIds(new Set(results.map(r => r.id)));
       }
     };
     ```

  4. **Slide-over handlers:**
     ```typescript
     const handleProspectClick = (prospectId: string) => {
       setSearchState({ prospect: prospectId });
     };

     const handleSlideOverClose = () => {
       setSearchState({ prospect: "" });
     };
     ```

  5. **NL search handler:**
     ```typescript
     const handleNLSearch = (keywords: string) => {
       setSearchState({ keywords });
     };
     ```

  6. **Filter override handler:**
     ```typescript
     const handleApplyFilters = (filters: Partial<PersonaFilters>) => {
       // Store filter overrides — triggers re-search through useSearch
       // The hook already sends filterOverrides when keywords change
       // For other filters, we need to store them and pass to the next search
       // For now, extract keywords from filters and set via hook
       if (filters.keywords) {
         setSearchState({ keywords: filters.keywords });
       }
       // Advanced filter overrides beyond keywords are a future enhancement
       // The API route already supports them — just needs state management wiring
     };
     ```

  7. **Bulk action handlers (stubs for now — full implementations in later phases):**
     ```typescript
     const handleBulkAddToList = () => {
       // TODO: Open AddToListDialog for bulk selection
       // For now, show a toast or no-op
     };

     const handleBulkExport = () => {
       // TODO: Trigger CSV export for selected prospects
     };

     const handleBulkEnrich = () => {
       // TODO: Save selected to list then trigger enrichment
     };
     ```

  8. **Find the selected prospect data for slide-over:**
     ```typescript
     const selectedProspect = searchState.prospect
       ? results.find(r => r.id === searchState.prospect) ?? null
       : null;

     // Map ApolloPerson to Prospect shape for slide-over
     const slideOverProspect = selectedProspect ? {
       id: selectedProspect.id,
       full_name: selectedProspect.name || `${selectedProspect.first_name} ${selectedProspect.last_name}`,
       first_name: selectedProspect.first_name,
       last_name: selectedProspect.last_name,
       title: selectedProspect.title || null,
       company: selectedProspect.organization_name || selectedProspect.organization?.name || null,
       location: [selectedProspect.city, selectedProspect.state, selectedProspect.country].filter(Boolean).join(", ") || null,
       work_email: selectedProspect.email || null,
       ai_summary: selectedProspect.headline || null,
       enrichment_source_status: null,
       insider_data: null,
     } : null;
     ```

  9. **Render the UNIFIED layout (single return, no conditional view swap):**

     ```tsx
     return (
       <div className="page-enter flex flex-col">
         {/* Error state — full replacement */}
         {error ? (
           <EmptyState icon={AlertCircle} title={error} variant="error">
             <Button variant="outline" size="sm" onClick={executeSearch}>
               <RefreshCw className="h-4 w-4 mr-2" /> Try Again
             </Button>
           </EmptyState>
         ) : (
           <>
             {/* HEADER SECTION — always visible */}
             <div className="pt-8 pb-6 flex flex-col gap-5">
               {/* Page title */}
               <div>
                 <h1
                   className="font-serif text-[38px] font-medium"
                   style={{ letterSpacing: "-0.5px", color: "var(--text-primary-ds)" }}
                 >
                   Lead Discovery
                 </h1>
                 <p className="mt-1 text-[14px] font-light" style={{ color: "var(--text-tertiary)" }}>
                   Use natural language to discover high-net-worth individuals and properties
                 </p>
               </div>

               {/* NL Search Bar */}
               <NLSearchBar
                 initialValue={searchState.keywords}
                 onSearch={handleNLSearch}
                 isLoading={isLoading}
               />

               {/* Persona Pills */}
               <PersonaPills
                 personas={personas}
                 selectedId={searchState.persona}
                 onSelect={(id) => setSearchState({ persona: id })}
                 onCreateNew={() => router.push(`/${orgId}/personas/new`)}
               />

               {/* Advanced Filters toggle */}
               <AdvancedFiltersPanel onApplyFilters={handleApplyFilters} />
             </div>

             {/* RESULTS SECTION — conditional on persona selected */}
             {hasPersonaSelected ? (
               <div>
                 {/* Results header row */}
                 <div className="flex items-center justify-between mb-4">
                   <p className="text-[13px]" style={{ color: "var(--text-secondary-ds)" }}>
                     {pagination.totalEntries > 0
                       ? `${pagination.totalEntries.toLocaleString()} results`
                       : isLoading
                         ? "Searching..."
                         : "No results"}
                   </p>
                 </div>

                 {/* Bulk actions bar */}
                 {results.length > 0 && (
                   <BulkActionsBar
                     selectedCount={selectedIds.size}
                     totalCount={results.length}
                     allSelected={selectedIds.size === results.length && results.length > 0}
                     onSelectAll={handleSelectAll}
                     onAddToList={handleBulkAddToList}
                     onExport={handleBulkExport}
                     onEnrich={handleBulkEnrich}
                   />
                 )}

                 {/* Loading state: skeleton cards */}
                 {isLoading && results.length === 0 && (
                   <div className="flex flex-col gap-3">
                     {[1, 2, 3, 4].map((n) => (
                       <SkeletonCard key={n} />
                     ))}
                   </div>
                 )}

                 {/* Empty state: no results */}
                 {!isLoading && results.length === 0 && (
                   <EmptyState
                     icon={Search}
                     title="No matching prospects"
                     description="Try broadening the persona filters or adjusting your search keywords."
                   />
                 )}

                 {/* Prospect result card stack */}
                 {results.length > 0 && (
                   <div className="flex flex-col gap-3">
                     {results.map((prospect) => (
                       <ProspectResultCard
                         key={prospect.id}
                         prospect={prospect}
                         lists={lists}
                         orgId={orgId}
                         onClick={() => handleProspectClick(prospect.id)}
                         selected={selectedIds.has(prospect.id)}
                         onSelect={() => handleSelect(prospect.id)}
                       />
                     ))}
                   </div>
                 )}

                 {/* Pagination */}
                 {pagination.totalPages > 1 && (
                   <div className="flex justify-center items-center gap-2 mt-8">
                     <Button
                       variant="ghost"
                       size="sm"
                       disabled={searchState.page <= 1 || isLoading}
                       onClick={() => setSearchState({ page: searchState.page - 1 })}
                     >
                       Previous
                     </Button>
                     {Array.from({ length: Math.min(pagination.totalPages, 7) }, (_, i) => {
                       const pageNum = i + 1;
                       const isActive = pageNum === searchState.page;
                       return (
                         <button
                           key={pageNum}
                           onClick={() => setSearchState({ page: pageNum })}
                           disabled={isLoading}
                           className="h-8 w-8 rounded-[6px] text-xs font-medium transition-all duration-200 cursor-pointer"
                           style={
                             isActive
                               ? {
                                   background: "var(--gold-bg-strong)",
                                   border: "1px solid var(--border-gold)",
                                   color: "var(--gold-primary)",
                                 }
                               : {
                                   background: "rgba(255,255,255,0.02)",
                                   border: "1px solid var(--border-subtle)",
                                   color: "rgba(255,255,255,0.5)",
                                 }
                           }
                         >
                           {pageNum}
                         </button>
                       );
                     })}
                     <Button
                       variant="ghost"
                       size="sm"
                       disabled={searchState.page >= pagination.totalPages || isLoading}
                       onClick={() => setSearchState({ page: searchState.page + 1 })}
                     >
                       Next
                     </Button>
                   </div>
                 )}
               </div>
             ) : (
               /* Empty state when no persona selected — show persona card grid */
               <div className="mt-4">
                 <EmptyState
                   icon={Search}
                   title="Select a persona to search"
                   description="Choose a saved persona above or type a natural language query to discover matching prospects."
                 />
               </div>
             )}
           </>
         )}

         {/* ProspectSlideOver — always rendered, controlled by URL param */}
         <ProspectSlideOver
           open={Boolean(searchState.prospect)}
           onClose={handleSlideOverClose}
           prospectId={searchState.prospect || null}
           prospect={slideOverProspect}
           orgId={orgId}
         />
       </div>
     );
     ```

  10. **Keep the SkeletonCard** function component as-is (it's design-system compliant).

  CRITICAL NOTES:
  - The unified layout ALWAYS shows NL bar + persona pills at top. Results appear below when persona is selected.
  - No "Back to personas" button — persona pills are always visible for easy switching.
  - The `page-enter` class on the root div adds the fade-in animation per design system.
  - The ProspectSlideOver receives Apollo data mapped to the Prospect shape — Phase 9 will add full enrichment.
  - Bulk action handlers are stubs — the UI is wired but the server-side bulk operations need more infrastructure.
  </action>
  <verify>
    <automated>cd /Users/aymanbaig/Desktop/Manual\ Library/Phronesis-main && grep -c "PersonaPills" src/app/\[orgId\]/search/components/search-content.tsx && grep -c "NLSearchBar" src/app/\[orgId\]/search/components/search-content.tsx && grep -c "AdvancedFiltersPanel" src/app/\[orgId\]/search/components/search-content.tsx && grep -c "BulkActionsBar" src/app/\[orgId\]/search/components/search-content.tsx && grep -c "ProspectSlideOver" src/app/\[orgId\]/search/components/search-content.tsx && grep -c "searchState.prospect" src/app/\[orgId\]/search/components/search-content.tsx</automated>
  </verify>
  <done>SearchContent renders unified single-screen layout with NL bar, persona pills, advanced filters, bulk actions, result cards with checkboxes, pagination, and slide-over panel — no full-page view swap</done>
</task>

<task type="auto">
  <name>Task 2: Delete local WealthTierBadge duplicate</name>
  <files>src/app/[orgId]/search/components/wealth-tier-badge.tsx</files>
  <action>
  Delete the file `src/app/[orgId]/search/components/wealth-tier-badge.tsx`.

  This file is a local duplicate of the canonical Phase 6 shared component at `src/components/ui/wealth-tier-badge.tsx`. Plan 03 already updated `prospect-result-card.tsx` to import from the shared location.

  Verify no other files in the search directory import from this local copy:
  ```bash
  grep -r "from.*\./wealth-tier-badge" src/app/[orgId]/search/
  ```
  If any other file imports from the local copy, update that import to `@/components/ui/wealth-tier-badge` before deleting.

  Delete command: `rm src/app/[orgId]/search/components/wealth-tier-badge.tsx`
  </action>
  <verify>
    <automated>cd /Users/aymanbaig/Desktop/Manual\ Library/Phronesis-main && test ! -f src/app/\[orgId\]/search/components/wealth-tier-badge.tsx && echo "DELETED"</automated>
  </verify>
  <done>Local WealthTierBadge duplicate deleted. Only the canonical shared version at src/components/ui/wealth-tier-badge.tsx remains.</done>
</task>

</tasks>

<verification>
- SearchContent imports and renders all 5 new components (PersonaPills, NLSearchBar, AdvancedFiltersPanel, BulkActionsBar, ProspectSlideOver)
- No "Back to personas" button — unified layout with pills always visible
- `searchState.prospect` controls ProspectSlideOver open/close
- Bulk selection state resets when persona changes
- Local wealth-tier-badge.tsx is deleted
- No raw Tailwind color classes in SearchContent
</verification>

<success_criteria>
1. Search page renders unified layout: NL bar + persona pills always at top, results below
2. Clicking persona pill triggers search, results appear below
3. Clicking prospect card opens slide-over panel with URL sync (?prospect=<id>)
4. Checkboxes appear on result cards, bulk actions bar shows when items selected
5. NL search bar keywords pass through to API via filterOverrides
6. Pagination works with gold active page
7. Local WealthTierBadge duplicate is deleted
8. No raw Tailwind color classes used
</success_criteria>

<output>
After completion, create `.planning/phases/08-lead-search/08-04-SUMMARY.md`
</output>
