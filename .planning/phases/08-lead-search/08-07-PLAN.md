---
phase: 08-lead-search
plan: "07"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/[orgId]/search/components/search-content.tsx
autonomous: true
gap_closure: true
requirements: [SRCH-01, LIST-03, EXP-01]

must_haves:
  truths:
    - "Bulk 'Add to List' button opens AddToListDialog for all selected prospects"
    - "Bulk 'Export CSV' button downloads a CSV file containing selected prospect data"
    - "Bulk 'Enrich Selection' button opens AddToListDialog with enrichment-first messaging"
  artifacts:
    - path: "src/app/[orgId]/search/components/search-content.tsx"
      provides: "Three functional bulk action handlers replacing stubs"
      contains: "handleBulkAddToList|handleBulkExport|handleBulkEnrich"
  key_links:
    - from: "src/app/[orgId]/search/components/search-content.tsx"
      to: "AddToListDialog"
      via: "Bulk add opens dialog with first selected prospect"
      pattern: "bulkAddOpen|showBulkAddDialog"
    - from: "src/app/[orgId]/search/components/search-content.tsx"
      to: "CSV download"
      via: "Client-side CSV generation from Apollo results"
      pattern: "Blob|download|csv"
---

<objective>
Implement the three bulk action handlers in SearchContent: Add to List, Export CSV, and Enrich Selection.

Purpose: Close Gap 2 from 08-VERIFICATION.md — all three bulk action handlers (handleBulkAddToList, handleBulkExport, handleBulkEnrich) are empty stubs with TODO comments. The BulkActionsBar UI renders correctly and checkboxes work, but clicking any action button does nothing.

Output: All three bulk action buttons perform real operations when clicked.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/08-lead-search/08-VERIFICATION.md
@.planning/phases/08-lead-search/08-04-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/app/[orgId]/search/components/add-to-list-dialog.tsx:
```typescript
interface AddToListDialogProps {
  prospect: ApolloPerson;
  lists: List[];
  trigger: React.ReactNode;
  orgId: string;
}
// Uses Dialog from shadcn with DialogTrigger
// Calls POST /api/prospects/upsert with { prospect, listIds }
```

From src/lib/apollo/types.ts (ApolloPerson shape — key fields):
```typescript
// ApolloPerson has: id, name, first_name, last_name, title, email,
// organization_name, organization?.name, city, state, country,
// linkedin_url, headline, phone_numbers
```

From src/app/[orgId]/search/components/search-content.tsx (current stubs, lines 131-143):
```typescript
const handleBulkAddToList = () => {
  // TODO: Open AddToListDialog for bulk selection
};
const handleBulkExport = () => {
  // TODO: Trigger CSV export for selected prospects
};
const handleBulkEnrich = () => {
  // TODO: Save selected to list then trigger enrichment
};
```

From src/app/[orgId]/search/components/bulk-actions-bar.tsx:
```typescript
interface BulkActionsBarProps {
  selectedCount: number;
  totalCount: number;
  allSelected: boolean;
  onSelectAll: () => void;
  onAddToList: () => void;
  onExport: () => void;
  onEnrich: () => void;
}
```

From hooks/use-toast (already imported pattern in codebase):
```typescript
import { useToast } from "@/hooks/use-toast";
const { toast } = useToast();
toast({ title: "...", description: "..." });
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement bulk Add to List via batch API calls</name>
  <files>src/app/[orgId]/search/components/search-content.tsx</files>
  <action>
  Implement `handleBulkAddToList` to add all selected prospects to lists. The challenge is that `AddToListDialog` accepts a single `prospect: ApolloPerson` and uses a `DialogTrigger`. For bulk operations, we need a different approach.

  **Implementation strategy:** Add a state-controlled Dialog (not trigger-based) for bulk list selection. This avoids modifying AddToListDialog.

  1. Add state at the top of SearchContent:
     ```typescript
     const [bulkListDialogOpen, setBulkListDialogOpen] = useState(false);
     const [bulkMode, setBulkMode] = useState<"add" | "enrich">("add");
     const [isBulkSubmitting, setIsBulkSubmitting] = useState(false);
     const [bulkSelectedListIds, setBulkSelectedListIds] = useState<string[]>([]);
     const { toast } = useToast();
     ```
     Import `useToast` from `@/hooks/use-toast`, `Dialog/DialogContent/DialogHeader/DialogTitle/DialogDescription/DialogFooter` from `@/components/ui/dialog`, `Checkbox` from `@/components/ui/checkbox`, `Label` from `@/components/ui/label`, `Loader2` from `lucide-react`.

  2. Implement `handleBulkAddToList`:
     ```typescript
     const handleBulkAddToList = () => {
       if (selectedIds.size === 0) return;
       setBulkMode("add");
       setBulkSelectedListIds([]);
       setBulkListDialogOpen(true);
     };
     ```

  3. Implement `handleBulkListSubmit` — the dialog's submit handler:
     ```typescript
     const handleBulkListSubmit = async () => {
       if (bulkSelectedListIds.length === 0 || selectedIds.size === 0) return;
       setIsBulkSubmitting(true);
       const selectedProspects = results.filter(r => selectedIds.has(r.id));
       let successCount = 0;
       let failCount = 0;

       // Process each selected prospect via the existing upsert endpoint
       const promises = selectedProspects.map(async (prospect) => {
         try {
           const response = await fetch("/api/prospects/upsert", {
             method: "POST",
             headers: { "Content-Type": "application/json" },
             body: JSON.stringify({ prospect, listIds: bulkSelectedListIds }),
           });
           if (response.ok) { successCount++; } else { failCount++; }
         } catch { failCount++; }
       });

       await Promise.allSettled(promises);
       setIsBulkSubmitting(false);
       setBulkListDialogOpen(false);

       toast({
         title: failCount === 0 ? "Success" : "Partial success",
         description: `Added ${successCount} prospect${successCount !== 1 ? "s" : ""} to ${bulkSelectedListIds.length} list${bulkSelectedListIds.length !== 1 ? "s" : ""}${failCount > 0 ? `. ${failCount} failed.` : ""}`,
         variant: failCount > 0 ? "destructive" : "default",
       });

       // Clear selection after successful bulk add
       if (failCount === 0) setSelectedIds(new Set());
     };
     ```

  4. Add the bulk list selection Dialog JSX right before the ProspectSlideOver at the bottom of the return. Use the same visual pattern as AddToListDialog but controlled by state:
     ```tsx
     <Dialog open={bulkListDialogOpen} onOpenChange={setBulkListDialogOpen}>
       <DialogContent className="sm:max-w-[425px]">
         <DialogHeader>
           <DialogTitle>{bulkMode === "enrich" ? "Enrich Selection" : "Add to List"}</DialogTitle>
           <DialogDescription>
             {bulkMode === "enrich"
               ? `Save ${selectedIds.size} prospect${selectedIds.size !== 1 ? "s" : ""} to a list to begin enrichment`
               : `Add ${selectedIds.size} prospect${selectedIds.size !== 1 ? "s" : ""} to one or more lists`}
           </DialogDescription>
         </DialogHeader>
         <div className="py-4">
           {lists.length === 0 ? (
             <div className="text-center py-8 border-2 border-dashed rounded-lg">
               <p className="text-sm text-muted-foreground mb-3">No lists yet</p>
               <Button size="sm" asChild>
                 <Link href={`/${orgId}/lists`}>Create your first list</Link>
               </Button>
             </div>
           ) : (
             <div className="space-y-3 max-h-[300px] overflow-y-auto">
               {lists.map((list) => (
                 <div key={list.id} className="flex items-start space-x-3 p-3 rounded-lg hover:bg-accent/50 transition-colors">
                   <Checkbox
                     id={`bulk-list-${list.id}`}
                     checked={bulkSelectedListIds.includes(list.id)}
                     onCheckedChange={() => {
                       setBulkSelectedListIds(prev =>
                         prev.includes(list.id) ? prev.filter(id => id !== list.id) : [...prev, list.id]
                       );
                     }}
                   />
                   <div className="flex-1 cursor-pointer" onClick={() => {
                     setBulkSelectedListIds(prev =>
                       prev.includes(list.id) ? prev.filter(id => id !== list.id) : [...prev, list.id]
                     );
                   }}>
                     <Label htmlFor={`bulk-list-${list.id}`} className="font-medium cursor-pointer">
                       {list.name}
                     </Label>
                     {list.description && <p className="text-xs text-muted-foreground mt-0.5">{list.description}</p>}
                     <p className="text-xs text-muted-foreground mt-0.5">
                       {list.member_count} {list.member_count === 1 ? "member" : "members"}
                     </p>
                   </div>
                 </div>
               ))}
             </div>
           )}
         </div>
         {lists.length > 0 && (
           <DialogFooter>
             <Button variant="outline" onClick={() => setBulkListDialogOpen(false)} disabled={isBulkSubmitting}>
               Cancel
             </Button>
             <Button onClick={handleBulkListSubmit} disabled={bulkSelectedListIds.length === 0 || isBulkSubmitting}>
               {isBulkSubmitting && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
               {bulkMode === "enrich" ? "Save & Enrich" : `Add to ${bulkSelectedListIds.length} List${bulkSelectedListIds.length !== 1 ? "s" : ""}`}
             </Button>
           </DialogFooter>
         )}
       </DialogContent>
     </Dialog>
     ```

  5. Import `Link` from `next/link` if not already imported.
  </action>
  <verify>
    <automated>cd /Users/aymanbaig/Desktop/Manual\ Library/Phronesis-main && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
  - handleBulkAddToList opens a controlled Dialog with list selection checkboxes
  - Dialog uses Promise.allSettled to add all selected prospects to selected lists via /api/prospects/upsert
  - Success/failure toast displayed with counts
  - Selection cleared on full success
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement bulk Export CSV and Enrich Selection handlers</name>
  <files>src/app/[orgId]/search/components/search-content.tsx</files>
  <action>
  **Implement `handleBulkExport` — client-side CSV download from selected Apollo results:**

  Apollo search results are ephemeral (not in the database), so we generate the CSV client-side from the in-memory `results` array. Do NOT use the server-side `/api/export/csv` route (that requires a `listId` and reads from the prospects table).

  1. Implement `handleBulkExport`:
     ```typescript
     const handleBulkExport = () => {
       if (selectedIds.size === 0) return;
       const selectedProspects = results.filter(r => selectedIds.has(r.id));

       // CSV header
       const headers = ["Name", "Title", "Company", "Location", "Email", "LinkedIn URL"];

       // CSV rows
       const rows = selectedProspects.map(p => [
         p.name || `${p.first_name || ""} ${p.last_name || ""}`.trim(),
         p.title || "",
         p.organization_name || p.organization?.name || "",
         [p.city, p.state, p.country].filter(Boolean).join(", "),
         p.email || "",
         p.linkedin_url || "",
       ]);

       // Escape CSV fields (handle commas, quotes, newlines)
       const escapeField = (field: string) => {
         if (field.includes(",") || field.includes('"') || field.includes("\n")) {
           return `"${field.replace(/"/g, '""')}"`;
         }
         return field;
       };

       const csvContent = [
         headers.map(escapeField).join(","),
         ...rows.map(row => row.map(escapeField).join(",")),
       ].join("\n");

       // Add UTF-8 BOM for Excel compatibility
       const bom = "\uFEFF";
       const blob = new Blob([bom + csvContent], { type: "text/csv;charset=utf-8;" });
       const url = URL.createObjectURL(blob);

       // Trigger download
       const link = document.createElement("a");
       link.href = url;
       link.download = `prospects-export-${new Date().toISOString().slice(0, 10)}.csv`;
       document.body.appendChild(link);
       link.click();
       document.body.removeChild(link);
       URL.revokeObjectURL(url);

       toast({
         title: "Export complete",
         description: `Downloaded ${selectedProspects.length} prospect${selectedProspects.length !== 1 ? "s" : ""} as CSV`,
       });
     };
     ```

  **Implement `handleBulkEnrich` — reuse the bulk list dialog with enrichment mode:**

  Enrichment requires prospects to be saved to the database first (the Inngest enrichment pipeline reads from the prospects table). So "Enrich Selection" should prompt the user to save to a list first, then enrichment happens automatically via the existing lazy enrichment triggers.

  2. Implement `handleBulkEnrich`:
     ```typescript
     const handleBulkEnrich = () => {
       if (selectedIds.size === 0) return;
       setBulkMode("enrich");
       setBulkSelectedListIds([]);
       setBulkListDialogOpen(true);
     };
     ```

  This reuses the exact same bulk list dialog from Task 1 but with `bulkMode="enrich"`. The dialog title changes to "Enrich Selection", the description says "Save to a list to begin enrichment", and the submit button says "Save & Enrich". The actual enrichment is triggered automatically by the existing lazy enrichment pipeline when prospects are viewed after being saved to the database — no additional API call needed from the client.

  3. Verify that `handleBulkListSubmit` (from Task 1) already handles both modes correctly. The only difference is the UI text; the underlying operation (upsert to list) is the same for both modes because enrichment is triggered on profile view, not on list add.
  </action>
  <verify>
    <automated>cd /Users/aymanbaig/Desktop/Manual\ Library/Phronesis-main && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
  - handleBulkExport generates a client-side CSV from selected Apollo results and triggers browser download
  - CSV includes UTF-8 BOM, proper field escaping, and columns: Name, Title, Company, Location, Email, LinkedIn URL
  - handleBulkEnrich opens the same bulk list dialog in "enrich" mode with different messaging
  - Toast notifications confirm each operation
  - No empty stub handlers remain in SearchContent
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Grep `search-content.tsx` for `TODO:` — should return zero matches (all stubs replaced)
3. Grep `search-content.tsx` for `handleBulkAddToList|handleBulkExport|handleBulkEnrich` — all three have real implementations
4. Grep `search-content.tsx` for `bulkListDialogOpen` — Dialog state management exists
5. Grep `search-content.tsx` for `Blob.*csv` — CSV export generates downloadable file
</verification>

<success_criteria>
- All three bulk action buttons execute real operations (no empty stubs remain)
- "Add to List" opens a list selection dialog and adds all selected prospects to chosen lists
- "Export CSV" downloads a CSV file with selected prospect data
- "Enrich Selection" opens the same dialog with enrichment-focused messaging
- Toast notifications confirm operation success/failure
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-lead-search/08-07-SUMMARY.md`
</output>
