---
phase: 02-persona-search-lists
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - src/lib/lists/types.ts
  - src/lib/lists/queries.ts
  - src/app/(dashboard)/[orgId]/lists/page.tsx
  - src/app/(dashboard)/[orgId]/lists/[listId]/page.tsx
  - src/app/(dashboard)/[orgId]/lists/components/list-grid.tsx
  - src/app/(dashboard)/[orgId]/lists/components/create-list-dialog.tsx
  - src/app/(dashboard)/[orgId]/lists/components/list-member-table.tsx
  - src/app/(dashboard)/[orgId]/lists/components/member-status-select.tsx
  - src/app/(dashboard)/[orgId]/lists/components/member-notes-cell.tsx
  - src/app/(dashboard)/[orgId]/lists/actions.ts
autonomous: true

must_haves:
  truths:
    - "User can create a named list with optional description"
    - "User can view all lists with member count and last updated date"
    - "User can view list members in a table with prospect data columns"
    - "User can update member status (New, Contacted, Responded, Not Interested)"
    - "User can add inline notes on list members"
    - "User can remove prospects from lists"
    - "Lists are tenant-scoped (RLS enforced)"
  artifacts:
    - path: "src/lib/lists/types.ts"
      provides: "List and ListMember TypeScript types"
      exports: ["List", "ListMember", "ListMemberStatus", "CreateListInput"]
    - path: "src/lib/lists/queries.ts"
      provides: "List CRUD and member management database operations"
      exports: ["getLists", "getListById", "createList", "deleteList", "getListMembers", "addProspectToList", "removeFromList", "updateMemberStatus", "updateMemberNotes"]
    - path: "src/app/(dashboard)/[orgId]/lists/page.tsx"
      provides: "Lists overview page"
    - path: "src/app/(dashboard)/[orgId]/lists/[listId]/page.tsx"
      provides: "List detail page with member table"
    - path: "src/app/(dashboard)/[orgId]/lists/actions.ts"
      provides: "Server actions for list and member operations"
      exports: ["createListAction", "deleteListAction", "updateMemberStatusAction", "updateMemberNotesAction", "removeFromListAction"]
  key_links:
    - from: "src/app/(dashboard)/[orgId]/lists/actions.ts"
      to: "src/lib/lists/queries.ts"
      via: "Server actions call query functions"
      pattern: "import.*from.*lists/queries"
    - from: "src/app/(dashboard)/[orgId]/lists/[listId]/page.tsx"
      to: "src/lib/lists/queries.ts"
      via: "Page fetches list and members"
      pattern: "getListById|getListMembers"
    - from: "src/app/(dashboard)/[orgId]/lists/components/list-member-table.tsx"
      to: "src/app/(dashboard)/[orgId]/lists/actions.ts"
      via: "Table actions call server actions"
      pattern: "updateMemberStatusAction|updateMemberNotesAction"
---

<objective>
Build the List Management System: create, view, and delete lists; manage list members with status tracking and inline notes; list detail view with member data table.

Purpose: Lists are how users organize prospects for outreach. After finding prospects via search, they add them to lists, track contact status, and add notes. This is the primary organizational tool in the platform.

Output: List types, database queries, server actions, list overview page, list detail page with member table, and all supporting UI components.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create list types, database queries, and server actions</name>
  <files>
    src/lib/lists/types.ts
    src/lib/lists/queries.ts
    src/app/(dashboard)/[orgId]/lists/actions.ts
  </files>
  <action>
Create `src/lib/lists/types.ts`:
- Export `ListMemberStatus` type: `"new" | "contacted" | "responded" | "not_interested"`
- Export `List` interface: `{ id: string; tenant_id: string; name: string; description: string | null; member_count: number; created_at: string; updated_at: string }`
- Export `ListMember` interface: `{ id: string; list_id: string; prospect_id: string; status: ListMemberStatus; notes: string | null; added_at: string; updated_at: string; prospect: { id: string; name: string; title: string | null; company: string | null; location: string | null; email: string | null; email_status: string | null; phone: string | null; linkedin_url: string | null } }`
- Export `CreateListInput`: `{ name: string; description?: string }`

Create `src/lib/lists/queries.ts`:
- Import `createClient` from `@/lib/supabase/server`
- Import types from `./types`

Export functions:
- `getLists(tenantId: string): Promise<List[]>` — query `lists` table where `tenant_id = tenantId`, order by `updated_at DESC`. Use Supabase `.select("*, list_members(count)")` to get member count via aggregation, or use a computed column / separate count query.
- `getListById(id: string, tenantId: string): Promise<List | null>` — query by id and tenant_id
- `createList(tenantId: string, input: CreateListInput): Promise<List>` — insert into `lists` with `tenant_id`, return created list
- `deleteList(id: string, tenantId: string): Promise<void>` — delete where `id = id AND tenant_id = tenantId`. This cascades to list_members (assumes ON DELETE CASCADE in schema).
- `getListMembers(listId: string, tenantId: string): Promise<ListMember[]>` — query `list_members` JOIN `prospects` where `list_id = listId`. Join prospect data (name, title, company, location, email, phone, linkedin_url). Order by `added_at DESC`. Tenant scoping via RLS on both tables.
- `addProspectToList(listId: string, prospectId: string): Promise<ListMember>` — insert into `list_members` with `status: "new"`. Use ON CONFLICT DO NOTHING (idempotent — don't error if already in list).
- `removeFromList(memberId: string): Promise<void>` — delete from `list_members` where `id = memberId`. RLS ensures tenant scoping.
- `updateMemberStatus(memberId: string, status: ListMemberStatus): Promise<void>` — update `list_members.status` and `updated_at` where `id = memberId`
- `updateMemberNotes(memberId: string, notes: string): Promise<void>` — update `list_members.notes` and `updated_at` where `id = memberId`
- `getListsForProspect(prospectId: string, tenantId: string): Promise<{ id: string; name: string }[]>` — query lists that contain a given prospect (for "Add to List" dropdown to show existing membership)

Create `src/app/(dashboard)/[orgId]/lists/actions.ts`:
- Add `"use server"` directive
- Import query functions from `@/lib/lists/queries`
- Import `createClient` from `@/lib/supabase/server`
- Import `revalidatePath` from `next/cache`
- Each action: authenticate -> extract tenant_id from session -> validate -> call query -> revalidate

Export:
- `createListAction(formData: FormData)` — parse name, description -> createList -> revalidatePath `/[orgId]/lists`
- `deleteListAction(listId: string)` — deleteList -> revalidatePath `/[orgId]/lists`
- `updateMemberStatusAction(memberId: string, status: ListMemberStatus)` — updateMemberStatus -> revalidatePath
- `updateMemberNotesAction(memberId: string, notes: string)` — updateMemberNotes -> revalidatePath
- `removeFromListAction(memberId: string, listId: string)` — removeFromList -> revalidatePath `/[orgId]/lists/[listId]`
- `addToListAction(listId: string, prospectId: string)` — addProspectToList -> revalidatePath

All actions extract tenant_id from session. NEVER from client params.
  </action>
  <verify>
Run `pnpm tsc --noEmit` — no type errors. Verify:
- `ListMemberStatus` has exactly 4 values
- All query functions exist with correct signatures
- Server actions use `"use server"` directive
- Actions extract tenant_id from session (grep for `app_metadata.tenant_id`)
  </verify>
  <done>
List and ListMember types defined with 4 status values. CRUD queries for lists and member management. Server actions with session-based auth and path revalidation. All operations tenant-scoped.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create list pages and UI components</name>
  <files>
    src/app/(dashboard)/[orgId]/lists/page.tsx
    src/app/(dashboard)/[orgId]/lists/[listId]/page.tsx
    src/app/(dashboard)/[orgId]/lists/components/list-grid.tsx
    src/app/(dashboard)/[orgId]/lists/components/create-list-dialog.tsx
    src/app/(dashboard)/[orgId]/lists/components/list-member-table.tsx
    src/app/(dashboard)/[orgId]/lists/components/member-status-select.tsx
    src/app/(dashboard)/[orgId]/lists/components/member-notes-cell.tsx
  </files>
  <action>
Install additional shadcn/ui components if not already added:
```bash
npx shadcn@latest add table select dropdown-menu tooltip
```

Create `src/app/(dashboard)/[orgId]/lists/page.tsx` (Server Component):
- Authenticate and get tenant_id from session
- Fetch lists: `const lists = await getLists(tenantId)`
- Render page header: "Lists" title + CreateListDialog trigger button
- Render ListGrid component with lists data
- Empty state: "No lists yet. Create one to start organizing prospects."

Create `src/app/(dashboard)/[orgId]/lists/components/list-grid.tsx` ("use client"):
- Accept `{ lists: List[] }` props
- Render responsive grid (1 col mobile, 2 cols md, 3 cols lg) of cards
- Each card shows:
  - List name (bold, truncated)
  - Description (muted, truncated to 2 lines)
  - Member count: "{N} prospects"
  - Last updated: relative time (e.g., "2 hours ago")
  - Actions: "View" button (links to `/[orgId]/lists/[listId]`), "Delete" button with confirmation
- Dark card styling consistent with design system

Create `src/app/(dashboard)/[orgId]/lists/components/create-list-dialog.tsx` ("use client"):
- Dialog form with Name (required, max 100 chars) and Description (optional, max 500 chars)
- Calls `createListAction` on submit
- Loading state during submission
- Close dialog on success

Create `src/app/(dashboard)/[orgId]/lists/[listId]/page.tsx` (Server Component):
- Get `listId` from params, authenticate and get tenant_id
- Fetch list: `const list = await getListById(listId, tenantId)` — 404 if not found
- Fetch members: `const members = await getListMembers(listId, tenantId)`
- Render page header with list name, description, member count, back link to `/[orgId]/lists`
- Render ListMemberTable with members data

Create `src/app/(dashboard)/[orgId]/lists/components/list-member-table.tsx` ("use client"):
- Accept `{ members: ListMember[]; listId: string }` props
- HTML table (using shadcn Table component) with columns:
  - Name (bold, linked to prospect profile: `/[orgId]/prospects/[prospectId]`)
  - Title
  - Company
  - Location
  - Email (show email or "No email" badge)
  - Phone (show phone or "No phone" badge)
  - Status (MemberStatusSelect component)
  - Notes (MemberNotesCell component)
  - Actions (Remove button with confirmation)
- Empty state: "No prospects in this list yet. Add prospects from search results."
- Sortable by name, company, status (client-side sort since members fit in memory)

Create `src/app/(dashboard)/[orgId]/lists/components/member-status-select.tsx` ("use client"):
- Accept `{ memberId: string; currentStatus: ListMemberStatus }` props
- Render shadcn Select with 4 options: New, Contacted, Responded, Not Interested
- On change: call `updateMemberStatusAction(memberId, newStatus)`
- Status badge colors: New = blue, Contacted = yellow/gold, Responded = green, Not Interested = muted/gray
- Show loading spinner during update

Create `src/app/(dashboard)/[orgId]/lists/components/member-notes-cell.tsx` ("use client"):
- Accept `{ memberId: string; notes: string | null }` props
- Display current notes (truncated) with edit icon
- On click: expand to inline textarea for editing
- On blur or Enter: call `updateMemberNotesAction(memberId, newNotes)`
- Show "Add note..." placeholder when empty
- Debounce saves (500ms) to prevent excessive server calls
  </action>
  <verify>
Run `pnpm tsc --noEmit` — no type errors. Run `pnpm build` — pages compile. Verify:
- List overview page renders grid of lists
- List detail page shows member table with all columns
- MemberStatusSelect has exactly 4 options
- MemberNotesCell supports inline editing
- All client components have "use client" directive
  </verify>
  <done>
List overview page shows all lists with member counts and last updated. Create dialog allows creating new lists. List detail page shows member table with prospect data, inline status tracking (4 statuses), and inline notes editing. Remove from list works with confirmation. All tenant-scoped via session auth.
  </done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes with zero errors
2. `pnpm build` succeeds — all pages compile
3. All 10 files exist at their specified paths
4. ListMemberStatus has exactly 4 values: new, contacted, responded, not_interested
5. List detail page fetches both list metadata and list members
6. Member status select has 4 options with distinct colors
7. Notes cell supports inline editing with debounce
8. Server actions extract tenant_id from session only
9. Delete operations include confirmation step in UI
</verification>

<success_criteria>
- User can create named lists with optional description
- User can view all lists in a grid with member count and last updated date
- User can view list members in a table with prospect data columns + status + notes
- User can update member status inline (4 statuses)
- User can add/edit inline notes on members
- User can remove prospects from lists with confirmation
- Lists are tenant-scoped via RLS
</success_criteria>

<output>
After completion, create `.planning/phases/02-persona-search-lists/02-04-SUMMARY.md`
</output>
