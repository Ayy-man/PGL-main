---
phase: 02-persona-search-lists
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/personas/types.ts
  - src/lib/personas/queries.ts
  - src/lib/personas/seed-data.ts
  - src/app/(dashboard)/[orgId]/personas/page.tsx
  - src/app/(dashboard)/[orgId]/personas/components/persona-list.tsx
  - src/app/(dashboard)/[orgId]/personas/components/persona-form-dialog.tsx
  - src/app/(dashboard)/[orgId]/personas/actions.ts
autonomous: true

must_haves:
  truths:
    - "User can create a persona with name, description, and Apollo filter fields"
    - "User can edit and delete custom personas"
    - "Persona list shows name, description, filter summary, and last used date"
    - "5 starter personas exist for each tenant (Finance Elite, Tech Execs, Startup Founders, BigLaw Partners, Crypto/Web3)"
    - "Personas are tenant-scoped (RLS enforced)"
  artifacts:
    - path: "src/lib/personas/types.ts"
      provides: "Persona TypeScript types"
      exports: ["Persona", "PersonaFilters", "CreatePersonaInput", "UpdatePersonaInput"]
    - path: "src/lib/personas/queries.ts"
      provides: "Persona CRUD database operations"
      exports: ["getPersonas", "getPersonaById", "createPersona", "updatePersona", "deletePersona"]
    - path: "src/lib/personas/seed-data.ts"
      provides: "5 starter persona definitions"
      exports: ["STARTER_PERSONAS"]
    - path: "src/app/(dashboard)/[orgId]/personas/page.tsx"
      provides: "Persona list page"
    - path: "src/app/(dashboard)/[orgId]/personas/components/persona-list.tsx"
      provides: "Persona list component with filter summary"
    - path: "src/app/(dashboard)/[orgId]/personas/components/persona-form-dialog.tsx"
      provides: "Create/Edit persona dialog form"
    - path: "src/app/(dashboard)/[orgId]/personas/actions.ts"
      provides: "Server actions for persona CRUD"
      exports: ["createPersonaAction", "updatePersonaAction", "deletePersonaAction"]
  key_links:
    - from: "src/app/(dashboard)/[orgId]/personas/actions.ts"
      to: "src/lib/personas/queries.ts"
      via: "Server action calls query functions"
      pattern: "import.*from.*personas/queries"
    - from: "src/app/(dashboard)/[orgId]/personas/page.tsx"
      to: "src/lib/personas/queries.ts"
      via: "Server component fetches personas"
      pattern: "getPersonas"
    - from: "src/app/(dashboard)/[orgId]/personas/components/persona-form-dialog.tsx"
      to: "src/lib/personas/types.ts"
      via: "Form uses PersonaFilters type"
      pattern: "PersonaFilters"
---

<objective>
Build the Persona Builder feature: CRUD operations for search filter personas with 5 starter personas seeded per tenant, and a UI for creating, editing, deleting, and listing personas.

Purpose: Personas are the foundation of search in Phase 02. Users select a persona to trigger an Apollo.io search with pre-configured filters. Without personas, there's nothing to search with.

Output: Persona types, database queries, seed data, server actions, list page, list component, and form dialog.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-persona-search-lists/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create persona types, database queries, seed data, and server actions</name>
  <files>
    src/lib/personas/types.ts
    src/lib/personas/queries.ts
    src/lib/personas/seed-data.ts
    src/app/(dashboard)/[orgId]/personas/actions.ts
  </files>
  <action>
Create `src/lib/personas/types.ts`:
- Export `PersonaFilters` interface: `{ titles?: string[]; seniorities?: string[]; industries?: string[]; locations?: string[]; companySize?: string[]; keywords?: string }`
- Export `Persona` interface: `{ id: string; tenant_id: string; name: string; description: string | null; filters: PersonaFilters; is_starter: boolean; last_used_at: string | null; created_at: string; updated_at: string }`
- Export `CreatePersonaInput`: `{ name: string; description?: string; filters: PersonaFilters }`
- Export `UpdatePersonaInput`: `{ name?: string; description?: string; filters?: PersonaFilters }`

Create `src/lib/personas/seed-data.ts`:
- Export `STARTER_PERSONAS: CreatePersonaInput[]` array with 5 personas:
  1. **Finance Elite**: `{ name: "Finance Elite", description: "C-suite at PE/VC firms, $100M+ AUM", filters: { titles: ["CEO", "CFO", "CIO", "Managing Director", "Managing Partner", "Partner"], seniorities: ["c_suite", "vp", "director"], industries: ["Financial Services", "Venture Capital & Private Equity", "Investment Management"], companySize: ["51-200", "201-500", "501-1000", "1001-5000", "5001-10000"], keywords: "private equity venture capital asset management" } }`
  2. **Tech Execs**: `{ name: "Tech Execs", description: "VP+ at unicorns or public tech companies", filters: { titles: ["VP", "SVP", "EVP", "CTO", "CPO", "CEO"], seniorities: ["c_suite", "vp"], industries: ["Computer Software", "Internet", "Information Technology and Services"], companySize: ["201-500", "501-1000", "1001-5000", "5001-10000", "10001+"], keywords: "technology software SaaS" } }`
  3. **Startup Founders**: `{ name: "Startup Founders", description: "Founder/CEO, Series B+, tech sector", filters: { titles: ["Founder", "Co-Founder", "CEO", "Co-CEO"], seniorities: ["c_suite", "owner"], industries: ["Computer Software", "Internet", "Information Technology and Services", "Financial Services"], companySize: ["11-50", "51-200", "201-500"], keywords: "startup founder series" } }`
  4. **BigLaw Partners**: `{ name: "BigLaw Partners", description: "Partners at Am Law 200 firms", filters: { titles: ["Partner", "Managing Partner", "Senior Partner", "Equity Partner", "Named Partner"], seniorities: ["c_suite", "vp", "director", "owner"], industries: ["Law Practice", "Legal Services"], companySize: ["201-500", "501-1000", "1001-5000", "5001-10000"] } }`
  5. **Crypto/Web3**: `{ name: "Crypto/Web3", description: "Founder/Executive at crypto/blockchain companies", filters: { titles: ["Founder", "Co-Founder", "CEO", "CTO", "Head of"], seniorities: ["c_suite", "vp", "owner"], industries: ["Financial Services", "Computer Software", "Internet"], keywords: "crypto blockchain web3 defi nft" } }`

Create `src/lib/personas/queries.ts`:
- Import `createClient` from `@/lib/supabase/server` (assumes Phase 1 created this)
- Import types from `./types`
- Export `getPersonas(tenantId: string): Promise<Persona[]>` — query `personas` table where `tenant_id = tenantId`, order by `is_starter DESC, name ASC`. RLS enforces tenant scoping at DB level; this app-level filter is defense-in-depth.
- Export `getPersonaById(id: string, tenantId: string): Promise<Persona | null>` — query by id and tenant_id
- Export `createPersona(tenantId: string, input: CreatePersonaInput): Promise<Persona>` — insert into `personas` with `tenant_id`, `is_starter: false`, `filters` stored as JSONB
- Export `updatePersona(id: string, tenantId: string, input: UpdatePersonaInput): Promise<Persona>` — update where `id = id AND tenant_id = tenantId AND is_starter = false` (prevent editing starter personas)
- Export `deletePersona(id: string, tenantId: string): Promise<void>` — delete where `id = id AND tenant_id = tenantId AND is_starter = false` (prevent deleting starter personas)
- Export `updatePersonaLastUsed(id: string, tenantId: string): Promise<void>` — update `last_used_at = NOW()` where `id = id AND tenant_id = tenantId`
- Export `seedStarterPersonas(tenantId: string): Promise<void>` — import STARTER_PERSONAS from seed-data, insert each with `is_starter: true` and the given tenant_id. Use upsert (ON CONFLICT DO NOTHING) to be idempotent.

All queries use the Supabase client from `createClient()` which respects RLS policies. Pass `tenant_id` explicitly as defense-in-depth.

Create `src/app/(dashboard)/[orgId]/personas/actions.ts`:
- Add `"use server"` directive at top
- Import query functions from `@/lib/personas/queries`
- Import `createClient` from `@/lib/supabase/server` for auth
- Import `revalidatePath` from `next/cache`
- Each action: get user session -> extract tenant_id from `app_metadata` -> validate input -> call query -> revalidate `/[orgId]/personas`
- Export `createPersonaAction(formData: FormData)` — parse name, description, filters from formData -> createPersona -> revalidatePath
- Export `updatePersonaAction(id: string, formData: FormData)` — parse fields -> updatePersona -> revalidatePath
- Export `deletePersonaAction(id: string)` — deletePersona -> revalidatePath

For extracting tenant_id: `const { data: { user } } = await supabase.auth.getUser(); const tenantId = user?.app_metadata?.tenant_id;`
NEVER get tenant_id from client parameters or URL — always from validated session.
  </action>
  <verify>
Run `pnpm tsc --noEmit` — no type errors. Verify:
- `STARTER_PERSONAS` has exactly 5 entries
- All query functions accept `tenantId` as parameter
- Server actions use `"use server"` directive
- No tenant_id extraction from URL params (grep for `params.orgId` used as tenant_id — should NOT exist in actions.ts)
  </verify>
  <done>
Persona types defined. 5 starter personas with Apollo-compatible filters ready for seeding. CRUD queries with tenant scoping. Server actions with session-based tenant extraction and path revalidation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create persona list page, list component, and form dialog UI</name>
  <files>
    src/app/(dashboard)/[orgId]/personas/page.tsx
    src/app/(dashboard)/[orgId]/personas/components/persona-list.tsx
    src/app/(dashboard)/[orgId]/personas/components/persona-form-dialog.tsx
  </files>
  <action>
First, install shadcn/ui components needed:
```bash
npx shadcn@latest add dialog button input textarea badge card label select separator
```

Create `src/app/(dashboard)/[orgId]/personas/page.tsx` (Server Component):
- Import `getPersonas` from `@/lib/personas/queries`
- Import `PersonaList` from `./components/persona-list`
- Import `PersonaFormDialog` from `./components/persona-form-dialog`
- Get tenant_id from user session (same pattern as actions.ts)
- Fetch personas: `const personas = await getPersonas(tenantId)`
- Render page with:
  - Page header: "Personas" title + "Create Persona" button that opens PersonaFormDialog
  - PersonaList component with personas data
- Show empty state if no personas: "No personas yet. Create one to start searching."

Create `src/app/(dashboard)/[orgId]/personas/components/persona-list.tsx` ("use client"):
- Import `Persona` type, shadcn Card, Badge, Button, and lucide icons (Search, Pencil, Trash2, Calendar)
- Accept props: `{ personas: Persona[] }`
- Render a grid of cards (responsive: 1 col mobile, 2 cols md, 3 cols lg)
- Each card shows:
  - Name (bold) with "Starter" badge if `is_starter === true`
  - Description (truncated to 2 lines)
  - Filter summary: compact display of active filters (e.g., "Titles: CEO, CFO | Industries: Finance, Tech | Seniority: C-Suite, VP"). Show count if >3 items ("+ 2 more")
  - Last used: "Last used: Feb 8, 2026" or "Never used" if null
  - Actions row: "Search" button (links to `/[orgId]/search?persona={id}`), "Edit" button (opens PersonaFormDialog in edit mode, hidden for starters), "Delete" button (hidden for starters, with confirmation)
- Use dark theme styling consistent with project design system: dark card backgrounds, gold accent on primary actions, muted text for metadata
- Delete button calls `deletePersonaAction` with confirmation dialog

Create `src/app/(dashboard)/[orgId]/personas/components/persona-form-dialog.tsx` ("use client"):
- Import Dialog, Button, Input, Textarea, Label, Select from shadcn/ui
- Accept props: `{ mode: "create" | "edit"; persona?: Persona; trigger: React.ReactNode }`
- Dialog form with fields:
  - Name (required, text input, max 100 chars)
  - Description (optional, textarea, max 500 chars)
  - **Filter section** (collapsible, mapping to Apollo.io API params):
    - Job Titles (comma-separated text input, parsed to string array)
    - Seniority Levels (multi-select: c_suite, vp, director, manager, senior, entry)
    - Industries (comma-separated text input, parsed to string array)
    - Locations (comma-separated text input, parsed to string array)
    - Company Size Ranges (multi-select: 1-10, 11-50, 51-200, 201-500, 501-1000, 1001-5000, 5001-10000, 10001+)
    - Keywords (text input, freeform)
- On submit: calls `createPersonaAction` or `updatePersonaAction` via server action binding
- In edit mode: pre-populate form with existing persona data
- Show loading state during submission with disabled submit button
- Close dialog on success
- Show validation errors inline (name required, at least one filter required)

Styling: Dark dialog with gold accent submit button, consistent with luxury brand theme.
  </action>
  <verify>
Run `pnpm tsc --noEmit` — no type errors. Run `pnpm build` — page compiles. Verify:
- Page imports and renders PersonaList and PersonaFormDialog
- PersonaList maps over personas array (not hardcoded)
- PersonaFormDialog has both "create" and "edit" modes
- Starter personas show "Starter" badge and hide edit/delete buttons
  </verify>
  <done>
Persona page lists all personas with filter summaries and last used dates. Create dialog allows building personas with all Apollo-compatible filter fields. Edit/delete work for custom personas. Starter personas are read-only. UI follows dark theme with gold accents.
  </done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes with zero errors
2. All 7 files exist at their specified paths
3. `STARTER_PERSONAS` array has exactly 5 entries with correct names
4. Persona list page renders server-side (no "use client" on page.tsx)
5. PersonaList and PersonaFormDialog are client components ("use client" directive)
6. Server actions extract tenant_id from session, never from URL params
7. Starter personas cannot be edited or deleted (UI hides buttons, queries filter by `is_starter = false`)
</verification>

<success_criteria>
- User can view a list of personas with name, description, filter summary, last used date
- User can create a new persona with Apollo-compatible filters via dialog form
- User can edit and delete custom personas (not starter personas)
- 5 starter personas are defined and ready for seeding
- All persona operations are tenant-scoped via session-based tenant_id extraction
</success_criteria>

<output>
After completion, create `.planning/phases/02-persona-search-lists/02-02-SUMMARY.md`
</output>
