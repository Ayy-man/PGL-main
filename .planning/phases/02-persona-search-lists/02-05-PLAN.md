---
phase: 02-persona-search-lists
plan: 05
type: execute
wave: 3
depends_on: ["02-03", "02-02"]
files_modified:
  - src/app/(dashboard)/[orgId]/search/page.tsx
  - src/app/(dashboard)/[orgId]/search/components/persona-selector.tsx
  - src/app/(dashboard)/[orgId]/search/components/search-results-table.tsx
  - src/app/(dashboard)/[orgId]/search/components/search-toolbar.tsx
  - src/app/(dashboard)/[orgId]/search/hooks/use-search.ts
  - src/components/ui/data-table/data-table.tsx
  - src/components/ui/data-table/data-table-pagination.tsx
autonomous: true

must_haves:
  truths:
    - "User can select a persona from dropdown and trigger search"
    - "Search results display in paginated table (50 results per page)"
    - "Results show name, title, company, location, email status, phone status"
    - "User can sort results by name, company, title"
    - "Search criteria persists in URL params (shareable/bookmarkable)"
    - "Loading states show skeleton table rows during search"
    - "Empty state shown when no results or no persona selected"
  artifacts:
    - path: "src/app/(dashboard)/[orgId]/search/page.tsx"
      provides: "Search page (server component shell)"
    - path: "src/app/(dashboard)/[orgId]/search/components/persona-selector.tsx"
      provides: "Persona dropdown selector"
    - path: "src/app/(dashboard)/[orgId]/search/components/search-results-table.tsx"
      provides: "Search results data table with sorting"
    - path: "src/app/(dashboard)/[orgId]/search/hooks/use-search.ts"
      provides: "Search state management with URL params via nuqs"
      exports: ["useSearch"]
    - path: "src/components/ui/data-table/data-table.tsx"
      provides: "Reusable TanStack data table component"
    - path: "src/components/ui/data-table/data-table-pagination.tsx"
      provides: "Pagination controls for data table"
  key_links:
    - from: "src/app/(dashboard)/[orgId]/search/hooks/use-search.ts"
      to: "/api/search/apollo"
      via: "Fetch call to search API route"
      pattern: "fetch.*api/search/apollo"
    - from: "src/app/(dashboard)/[orgId]/search/hooks/use-search.ts"
      to: "nuqs"
      via: "URL state management for search params"
      pattern: "useQueryStates|parseAsString|parseAsInteger"
    - from: "src/app/(dashboard)/[orgId]/search/components/search-results-table.tsx"
      to: "src/components/ui/data-table/data-table.tsx"
      via: "Renders reusable data table"
      pattern: "import.*DataTable.*from.*data-table"
---

<objective>
Build the Search Results UI: persona selector dropdown, paginated data table with TanStack Table, URL state management with nuqs, sorting, loading/empty states, and reusable data table components.

Purpose: This is the primary user interface for prospect discovery. Users select a persona, see results in a sortable paginated table, and share searches via URL. The table must handle 50+ rows smoothly with server-side pagination.

Output: Search page, persona selector, results table, search hook with URL state, and reusable data table components.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-persona-search-lists/02-RESEARCH.md
@.planning/phases/02-persona-search-lists/02-02-SUMMARY.md
@.planning/phases/02-persona-search-lists/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reusable data table components and search hook with URL state</name>
  <files>
    src/components/ui/data-table/data-table.tsx
    src/components/ui/data-table/data-table-pagination.tsx
    src/app/(dashboard)/[orgId]/search/hooks/use-search.ts
  </files>
  <action>
Ensure shadcn/ui table component is installed:
```bash
npx shadcn@latest add table skeleton
```

Create `src/components/ui/data-table/data-table.tsx` ("use client"):
- Generic component: `DataTable<TData, TValue>` accepting:
  - `columns: ColumnDef<TData, TValue>[]`
  - `data: TData[]`
  - `pageCount: number` (total pages from server)
  - `pageIndex: number` (0-indexed internally, displayed as 1-indexed)
  - `pageSize: number`
  - `onPaginationChange: (page: number) => void`
  - `sorting: SortingState`
  - `onSortingChange: (sorting: SortingState) => void`
  - `isLoading?: boolean`
- Use `useReactTable` with `manualPagination: true`, `manualSorting: true`, `getCoreRowModel`, `pageCount`
- Render shadcn `<Table>` with `<TableHeader>`, `<TableBody>`, `<TableRow>`, `<TableHead>`, `<TableCell>`
- Map `table.getHeaderGroups()` for headers with sort indicators (chevron up/down)
- Map `table.getRowModel().rows` for data rows
- When `isLoading`: render skeleton rows (10 rows of skeleton cells matching column count)
- When no data and not loading: render empty state row spanning all columns
- Include `DataTablePagination` at bottom

Create `src/components/ui/data-table/data-table-pagination.tsx` ("use client"):
- Accept `{ pageIndex: number; pageCount: number; pageSize: number; onPageChange: (page: number) => void }` props
- Show: "Page X of Y" text, Previous/Next buttons (disabled at boundaries), first/last page buttons
- Show total results count if available
- Dark theme styling with gold accent on active page indicator

Create `src/app/(dashboard)/[orgId]/search/hooks/use-search.ts` ("use client"):
- Import `useQueryStates`, `parseAsString`, `parseAsInteger` from `nuqs`
- Import `useState`, `useEffect`, `useCallback` from React
- Import `ApolloPerson` from `@/lib/apollo/types`

Export `useSearch()` hook:
- URL state with `useQueryStates`:
  - `persona: parseAsString.withDefault("")`
  - `page: parseAsInteger.withDefault(1)`
  - `sortBy: parseAsString.withDefault("name")`
  - `sortOrder: parseAsString.withDefault("asc")`
- Local state: `results: ApolloPerson[]`, `pagination: {...}`, `isLoading: boolean`, `error: string | null`, `cached: boolean`
- `executeSearch()` function:
  - Set isLoading = true, clear error
  - Call `fetch("/api/search/apollo", { method: "POST", body: JSON.stringify({ personaId: persona, page, pageSize: 50 }) })`
  - On success: set results, pagination, cached from response
  - On 429: set error "Rate limit exceeded. Try again in X seconds."
  - On other errors: set error "Search failed. Please try again."
  - Set isLoading = false
- `useEffect`: trigger `executeSearch()` when `persona`, `page` change (debounce 100ms to avoid double-fires from URL updates)
- Return: `{ searchState, setSearchState, results, pagination, isLoading, error, cached, executeSearch }`

URL state management means:
- Changing persona resets page to 1
- Navigating to `/[orgId]/search?persona=uuid&page=2&sortBy=company` restores full search state
- Browser back/forward works with search history
  </action>
  <verify>
Run `pnpm tsc --noEmit` — no type errors. Verify:
- DataTable uses `manualPagination: true` and `manualSorting: true`
- useSearch hook uses nuqs for URL state (grep for `useQueryStates`)
- Page defaults to 1 when persona changes
- All 3 files have "use client" directive
  </verify>
  <done>
Reusable DataTable component with server-side pagination and sorting. Pagination controls with page navigation. useSearch hook manages URL state via nuqs, fetches from /api/search/apollo, handles loading/error states.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create search page, persona selector, and results table</name>
  <files>
    src/app/(dashboard)/[orgId]/search/page.tsx
    src/app/(dashboard)/[orgId]/search/components/persona-selector.tsx
    src/app/(dashboard)/[orgId]/search/components/search-results-table.tsx
    src/app/(dashboard)/[orgId]/search/components/search-toolbar.tsx
  </files>
  <action>
Create `src/app/(dashboard)/[orgId]/search/page.tsx` (Server Component):
- Import `getPersonas` from `@/lib/personas/queries`
- Authenticate and get tenant_id from session
- Fetch personas: `const personas = await getPersonas(tenantId)`
- Render page shell with:
  - Page title "Search Prospects"
  - `<Suspense>` wrapping client-side SearchContent component
  - Pass personas to SearchContent as props

Create a client component wrapper `SearchContent` in the same file or import from components:
- Uses `useSearch()` hook for state management
- Renders SearchToolbar, then SearchResultsTable (or loading/empty states)

Create `src/app/(dashboard)/[orgId]/search/components/persona-selector.tsx` ("use client"):
- Accept `{ personas: Persona[]; selectedId: string; onSelect: (id: string) => void }` props
- Render shadcn Select/Combobox with persona options
- Group by: starter personas first (labeled "Starter Personas"), then custom (labeled "My Personas")
- Each option shows: persona name + brief filter summary (e.g., "Finance Elite — CEO, CFO | PE/VC | C-Suite")
- Include "Manage Personas" link at bottom that navigates to `/[orgId]/personas`
- Clear styling with dark background, gold accent on selected item

Create `src/app/(dashboard)/[orgId]/search/components/search-toolbar.tsx` ("use client"):
- Accept `{ personas: Persona[]; searchState; setSearchState; cached: boolean; isLoading: boolean; onRefresh: () => void }` props
- Render horizontal toolbar with:
  - PersonaSelector on the left
  - Cache indicator: "Cached results (Feb 8, 10:30 AM)" badge when cached=true, with "Refresh" button to force new API call
  - Result count: "Showing X of Y results" (from pagination metadata)
- Refresh button: clears cache and re-executes search

Create `src/app/(dashboard)/[orgId]/search/components/search-results-table.tsx` ("use client"):
- Import `DataTable` from `@/components/ui/data-table/data-table`
- Import `ColumnDef` from `@tanstack/react-table`
- Accept `{ results: ApolloPerson[]; pagination; isLoading; searchState; setSearchState; sorting; onSortingChange }` props
- Define columns:
  1. **Name**: `person.name` — bold text, linked to profile page (future: `/[orgId]/prospects/[id]`)
  2. **Title**: `person.title` — truncated with tooltip for long titles
  3. **Company**: `person.organization_name` — with company link if available
  4. **Location**: computed from `person.city`, `person.state`, `person.country` — show most specific available
  5. **Email Status**: `person.email_status` — badge: "verified" = green, "guessed" = yellow, "unavailable" = red, null = gray "Unknown"
  6. **Phone**: boolean indicator — green check if `person.phone_numbers?.length > 0`, gray X if not
  7. **Actions**: "Add to List" button (opens list selection dialog — stub for now, wired in Plan 06)
- All sortable columns (name, company, title) have sort toggle in header
- Sorting updates URL params via searchState
- Pagination changes update URL params (page param)
- Render DataTable with `manualPagination: true` props

Empty states:
- No persona selected: "Select a persona to search for prospects"
- Persona selected but no results: "No prospects found for this persona. Try adjusting the persona filters."
- Error state: Show error message with retry button

Loading state: Skeleton table with 10 rows matching column layout

Styling: Dark table with subtle row hover highlighting, gold accent on action buttons, muted text for metadata columns.
  </action>
  <verify>
Run `pnpm tsc --noEmit` — no type errors. Run `pnpm build` — page compiles. Verify:
- Search page fetches personas server-side and passes to client
- PersonaSelector shows starter and custom personas in groups
- ResultsTable defines all 7 columns
- URL params update on persona change, page change, sort change (grep for `setSearchState`)
- Loading skeleton renders 10 rows
- Cache indicator shows when results are from cache
  </verify>
  <done>
Search page with persona selector dropdown, paginated results table (50/page), sortable columns (name, company, title), URL state persistence via nuqs, loading skeletons, empty states, and cache indicator with refresh. Users can share search URLs.
  </done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes with zero errors
2. `pnpm build` succeeds
3. All 7 files exist at their specified paths
4. URL updates when changing persona (page resets to 1)
5. URL updates when changing page
6. URL updates when changing sort
7. Copy URL, open in new tab — same search state loads
8. Loading state shows skeleton table
9. Empty state shown when no persona selected
10. Results table shows all 7 columns
</verification>

<success_criteria>
- Select persona from dropdown, see paginated search results
- Results show name, title, company, location, email status, phone status in table
- Sort by name/company/title updates table and URL
- Navigate to page 3, copy URL, open new tab — page 3 loads
- Loading skeleton shows during API call
- Cache badge appears on cached results with refresh option
</success_criteria>

<output>
After completion, create `.planning/phases/02-persona-search-lists/02-05-SUMMARY.md`
</output>
