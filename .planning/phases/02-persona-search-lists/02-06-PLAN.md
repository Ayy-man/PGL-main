---
phase: 02-persona-search-lists
plan: 06
type: execute
wave: 4
depends_on: ["02-03", "02-04", "02-05"]
files_modified:
  - src/lib/prospects/types.ts
  - src/lib/prospects/queries.ts
  - src/app/(dashboard)/[orgId]/search/components/add-to-list-dialog.tsx
  - src/app/(dashboard)/[orgId]/search/components/search-results-table.tsx
  - src/app/api/prospects/upsert/route.ts
autonomous: true

must_haves:
  truths:
    - "User can add prospects from search results to any list via dialog"
    - "Prospects are deduplicated by email or LinkedIn URL on save"
    - "Add to List dialog shows existing lists with checkbox for multi-list add"
    - "Prospect data from Apollo is persisted to database on add-to-list"
    - "Adding a prospect already in the list is idempotent (no error, no duplicate)"
  artifacts:
    - path: "src/lib/prospects/types.ts"
      provides: "Prospect TypeScript types"
      exports: ["Prospect", "UpsertProspectInput"]
    - path: "src/lib/prospects/queries.ts"
      provides: "Prospect upsert with deduplication"
      exports: ["upsertProspect", "getProspectById"]
    - path: "src/app/(dashboard)/[orgId]/search/components/add-to-list-dialog.tsx"
      provides: "Dialog for adding prospect to lists"
    - path: "src/app/api/prospects/upsert/route.ts"
      provides: "API route for upserting prospects and adding to lists"
      exports: ["POST"]
  key_links:
    - from: "src/app/(dashboard)/[orgId]/search/components/add-to-list-dialog.tsx"
      to: "src/app/api/prospects/upsert/route.ts"
      via: "Dialog submits prospect + list data to API"
      pattern: "fetch.*api/prospects/upsert"
    - from: "src/app/api/prospects/upsert/route.ts"
      to: "src/lib/prospects/queries.ts"
      via: "Route calls upsertProspect"
      pattern: "import.*upsertProspect.*from.*prospects/queries"
    - from: "src/app/api/prospects/upsert/route.ts"
      to: "src/lib/lists/queries.ts"
      via: "Route calls addProspectToList"
      pattern: "import.*addProspectToList.*from.*lists/queries"
    - from: "src/app/(dashboard)/[orgId]/search/components/search-results-table.tsx"
      to: "src/app/(dashboard)/[orgId]/search/components/add-to-list-dialog.tsx"
      via: "Table action column renders AddToListDialog"
      pattern: "import.*AddToListDialog"
---

<objective>
Wire search results to list management: prospect deduplication/upsert, "Add to List" dialog from search results, and the API route that persists Apollo data and adds prospects to lists.

Purpose: This plan connects the search flow (Plans 03/05) with list management (Plan 04). Without this wiring, users can search but can't save prospects. The upsert/deduplication pattern ensures the same prospect isn't duplicated across searches.

Output: Prospect types, upsert queries with deduplication, Add to List dialog, upsert API route, and updated search results table with wired actions.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-persona-search-lists/02-RESEARCH.md
@.planning/phases/02-persona-search-lists/02-03-SUMMARY.md
@.planning/phases/02-persona-search-lists/02-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prospect types, upsert queries, and upsert API route</name>
  <files>
    src/lib/prospects/types.ts
    src/lib/prospects/queries.ts
    src/app/api/prospects/upsert/route.ts
  </files>
  <action>
Create `src/lib/prospects/types.ts`:
- Export `Prospect` interface: `{ id: string; tenant_id: string; apollo_id: string | null; name: string; first_name: string | null; last_name: string | null; title: string | null; company: string | null; city: string | null; state: string | null; country: string | null; email: string | null; email_status: string | null; phone: string | null; linkedin_url: string | null; photo_url: string | null; created_at: string; updated_at: string }`
- Export `UpsertProspectInput` interface: same fields as Prospect minus `id`, `tenant_id`, `created_at`, `updated_at` (these are set by the system)

Create `src/lib/prospects/queries.ts`:
- Import `createClient` from `@/lib/supabase/server`
- Import types from `./types`

Export functions:
- `upsertProspect(tenantId: string, input: UpsertProspectInput): Promise<Prospect>`:
  - Uses Supabase `.upsert()` with `onConflict: "tenant_id,email"` when email is present
  - If email is null but linkedin_url is present, uses `onConflict: "tenant_id,linkedin_url"`
  - On conflict: update name, title, company, city, state, country, phone, email_status, photo_url, updated_at
  - Returns the upserted prospect (with id)
  - NOTE: If neither email nor linkedin_url exists, just insert (no dedup possible)

- `upsertProspectFromApollo(tenantId: string, person: ApolloPerson): Promise<Prospect>`:
  - Maps ApolloPerson fields to UpsertProspectInput:
    - `apollo_id` = `person.id`
    - `name` = `person.name` (or `${person.first_name} ${person.last_name}`)
    - `first_name` = `person.first_name`
    - `last_name` = `person.last_name`
    - `title` = `person.title`
    - `company` = `person.organization_name`
    - `city` = `person.city`
    - `state` = `person.state`
    - `country` = `person.country`
    - `email` = `person.email`
    - `email_status` = `person.email_status`
    - `phone` = first phone number from `person.phone_numbers` (sanitized_number or raw_number)
    - `linkedin_url` = `person.linkedin_url`
    - `photo_url` = `person.photo_url`
  - Calls `upsertProspect(tenantId, mappedInput)`

- `getProspectById(id: string, tenantId: string): Promise<Prospect | null>` — query by id and tenant_id

Create `src/app/api/prospects/upsert/route.ts`:
- Export `POST` handler:
  1. Authenticate user, extract tenant_id from session
  2. Parse request body with zod schema: `{ prospect: ApolloPerson (required), listIds: string[] (required, at least 1) }`
  3. Call `upsertProspectFromApollo(tenantId, prospect)` — get back prospect with id
  4. For each listId in listIds: call `addProspectToList(listId, prospect.id)` — idempotent (ON CONFLICT DO NOTHING)
  5. Return 200 with `{ prospect: { id, name }, addedToLists: listIds.length }`
  6. Error handling: 400 for invalid input, 401 for unauthenticated, 500 for server error
  </action>
  <verify>
Run `pnpm tsc --noEmit` — no type errors. Verify:
- upsertProspect handles both email and linkedin_url dedup cases
- upsertProspectFromApollo correctly maps all ApolloPerson fields
- API route validates listIds array is non-empty
- API route extracts tenant_id from session (not from request body)
  </verify>
  <done>
Prospect types defined. Upsert queries handle deduplication by email or LinkedIn URL. Apollo-to-prospect field mapping is complete. API route persists prospect and adds to multiple lists in one call. All operations tenant-scoped.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Add to List dialog and wire to search results table</name>
  <files>
    src/app/(dashboard)/[orgId]/search/components/add-to-list-dialog.tsx
    src/app/(dashboard)/[orgId]/search/components/search-results-table.tsx
  </files>
  <action>
Install shadcn/ui checkbox if not already added:
```bash
npx shadcn@latest add checkbox
```

Create `src/app/(dashboard)/[orgId]/search/components/add-to-list-dialog.tsx` ("use client"):
- Accept props: `{ prospect: ApolloPerson; lists: List[]; trigger: React.ReactNode }`
- Dialog with:
  - Title: "Add to List" with prospect name
  - List of available lists as checkboxes (user can select multiple)
  - If no lists exist: show message "No lists yet" with link to create one
  - "Create New List" inline option at bottom (expands to name input)
  - Submit button: "Add to {N} List(s)" (disabled if no lists selected)
- On submit:
  - If new list was created: call `createListAction` first to get new list ID
  - Call `POST /api/prospects/upsert` with `{ prospect, listIds: selectedListIds }`
  - On success: show toast "Added {name} to {N} list(s)" and close dialog
  - On error: show toast with error message
- Loading state during submission

Update `src/app/(dashboard)/[orgId]/search/components/search-results-table.tsx`:
- Import `AddToListDialog` from `./add-to-list-dialog`
- The component now also accepts `{ lists: List[] }` prop (passed from search page)
- In the Actions column, replace the stub "Add to List" button with:
  ```tsx
  <AddToListDialog
    prospect={row.original}
    lists={lists}
    trigger={<Button variant="ghost" size="sm"><Plus className="h-4 w-4 mr-1" /> Add to List</Button>}
  />
  ```
- This means the search page.tsx needs to also fetch lists and pass them down

Update the search page to also fetch and pass lists:
- In page.tsx: `const lists = await getLists(tenantId)` alongside personas
- Pass `lists` to the SearchContent client component
- SearchContent passes `lists` to SearchResultsTable
  </action>
  <verify>
Run `pnpm tsc --noEmit` — no type errors. Run `pnpm build` — page compiles. Verify:
- AddToListDialog accepts ApolloPerson and List[] props
- Dialog shows checkboxes for each list
- Search results table imports and renders AddToListDialog in actions column
- Search page fetches both personas and lists
- Dialog calls /api/prospects/upsert on submit
  </verify>
  <done>
Add to List dialog shows available lists with checkboxes. User can select multiple lists and add a prospect in one action. Prospect is upserted (deduplicated) on save. Search results table has working "Add to List" action button for every row. Search page passes both personas and lists to client components.
  </done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes with zero errors
2. `pnpm build` succeeds
3. All 5 files exist at their specified paths
4. Prospect upsert handles email dedup and linkedin_url dedup
5. Add to List dialog shows all tenant lists as checkboxes
6. Search results table has "Add to List" button in actions column
7. API route adds prospect to multiple lists in one request
8. Adding same prospect to same list twice doesn't create duplicate (idempotent)
</verification>

<success_criteria>
- Click "Add to List" on search result -> dialog shows available lists
- Select 2 lists -> click submit -> prospect added to both lists
- Navigate to each list -> prospect appears in member table
- Search same persona again -> add same prospect to same list -> no duplicate error, no duplicate member
- Prospect data (name, title, company, email) persists in prospects table
</success_criteria>

<output>
After completion, create `.planning/phases/02-persona-search-lists/02-06-SUMMARY.md`
</output>
