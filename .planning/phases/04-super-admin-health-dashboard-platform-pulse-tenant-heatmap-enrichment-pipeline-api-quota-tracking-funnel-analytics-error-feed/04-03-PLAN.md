---
phase: 04-super-admin-health-dashboard-platform-pulse-tenant-heatmap-enrichment-pipeline-api-quota-tracking-funnel-analytics-error-feed
plan: 03
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - src/hooks/use-count-up.ts
  - src/components/admin/platform-pulse.tsx
  - src/components/admin/coming-soon-card.tsx
  - src/components/admin/tenant-heatmap.tsx
  - src/components/admin/enrichment-health-chart.tsx
  - src/components/admin/funnel-chart.tsx
  - src/components/admin/error-feed.tsx
autonomous: true
requirements:
  - "DESIGN.md Section: Platform Pulse (4 stat cards)"
  - "DESIGN.md Section: Tenant Activity Heatmap (expandable table)"
  - "DESIGN.md Section: Graphs (enrichment pipeline + funnel)"
  - "DESIGN.md Section: Error/Failure Feed (expandable table)"
  - "DESIGN.md Section: Coming Soon Cards"
  - "DESIGN.md Section: Component Structure"

must_haves:
  truths:
    - "Platform Pulse renders 4 stat cards with count-up animation on load"
    - "API Quota Burn card shows Coming Soon overlay (grayed out with badge)"
    - "Tenant Heatmap table has relative-to-peers color coding (top 25% green-gold, middle 50% amber, bottom 25% warm red)"
    - "Heatmap shows new tenants with zero data as 'new' state, not 'needs attention'"
    - "Tenant rows expand inline to show per-user breakdown on click"
    - "Enrichment health chart is a stacked bar chart with per-source success/failure bars per day"
    - "Funnel chart visualizes Searches -> Profile Views -> Enrichments -> Exports"
    - "Error feed is a paginated expandable table showing failed enrichments with per-source error details"
    - "All chart colors use gold-adjacent warm hues that fit the luxury dark theme"
    - "No re-trigger button on error feed (view-only per CONTEXT.md decision)"
  artifacts:
    - path: "src/hooks/use-count-up.ts"
      provides: "Count-up animation hook for stat cards"
      exports: ["useCountUp"]
    - path: "src/components/admin/platform-pulse.tsx"
      provides: "4 stat cards with count-up numbers and enrichment drill-down"
      exports: ["PlatformPulse"]
    - path: "src/components/admin/coming-soon-card.tsx"
      provides: "Reusable Coming Soon overlay wrapper"
      exports: ["ComingSoonCard"]
    - path: "src/components/admin/tenant-heatmap.tsx"
      provides: "Expandable tenant activity table with relative-rank coloring"
      exports: ["TenantHeatmap"]
    - path: "src/components/admin/enrichment-health-chart.tsx"
      provides: "Stacked bar chart showing per-source enrichment success/failure"
      exports: ["EnrichmentHealthChart"]
    - path: "src/components/admin/funnel-chart.tsx"
      provides: "Funnel visualization for search-to-export pipeline"
      exports: ["FunnelChart"]
    - path: "src/components/admin/error-feed.tsx"
      provides: "Paginated expandable error table"
      exports: ["ErrorFeed"]
  key_links:
    - from: "src/components/admin/enrichment-health-chart.tsx"
      to: "recharts"
      via: "import { BarChart, Bar, XAxis, YAxis, Tooltip, Legend, ResponsiveContainer } from recharts"
      pattern: "import.*BarChart.*from.*recharts"
    - from: "src/components/admin/funnel-chart.tsx"
      to: "recharts"
      via: "import { FunnelChart, Funnel, Cell, Tooltip, LabelList, ResponsiveContainer } from recharts"
      pattern: "import.*FunnelChart.*from.*recharts"
    - from: "src/components/admin/platform-pulse.tsx"
      to: "src/hooks/use-count-up.ts"
      via: "import { useCountUp } from @/hooks/use-count-up"
      pattern: "import.*useCountUp.*from.*@/hooks/use-count-up"
---

<objective>
Build all 6 dashboard UI components plus a count-up animation hook. These are self-contained React components that receive data as props and handle their own rendering, interactions (expand/collapse), and styling.

Purpose: The dashboard page (Plan 04) will compose these components together with a polling data fetcher. Building them as isolated, prop-driven components enables clean composition.

Output: 7 new files — 6 components in `src/components/admin/` and 1 hook in `src/hooks/`.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-super-admin-health-dashboard-platform-pulse-tenant-heatmap-enrichment-pipeline-api-quota-tracking-funnel-analytics-error-feed/DESIGN.md
@.planning/phases/04-super-admin-health-dashboard-platform-pulse-tenant-heatmap-enrichment-pipeline-api-quota-tracking-funnel-analytics-error-feed/04-RESEARCH.md
@.planning/phases/04-super-admin-health-dashboard-platform-pulse-tenant-heatmap-enrichment-pipeline-api-quota-tracking-funnel-analytics-error-feed/04-02-SUMMARY.md
@src/components/charts/usage-chart.tsx
@src/components/charts/metrics-cards.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create stat cards, Coming Soon overlay, and tenant heatmap components</name>
  <files>
    src/hooks/use-count-up.ts
    src/components/admin/platform-pulse.tsx
    src/components/admin/coming-soon-card.tsx
    src/components/admin/tenant-heatmap.tsx
  </files>
  <action>
**File 1: `src/hooks/use-count-up.ts`**

Create a tiny count-up animation hook (no external library):
- Takes `target: number` and `duration?: number` (default 800ms)
- Uses `requestAnimationFrame` to smoothly count from 0 to target
- Returns the current animated number
- Cleans up animation frame on unmount
- See Research doc code example for exact implementation

**File 2: `src/components/admin/coming-soon-card.tsx`**

Reusable wrapper component:
- Props: `{ children: ReactNode; label?: string }` where children is the card content to overlay
- Renders children with a semi-transparent overlay on top, reducing opacity of the content underneath
- Shows a "Coming Soon" badge (use Tailwind — `absolute inset-0 flex items-center justify-center bg-card/80 rounded-lg`)
- Badge text styled with `text-muted-foreground text-sm font-medium` and a subtle border
- Mark with `"use client"`

**File 3: `src/components/admin/platform-pulse.tsx`**

Props interface:
```typescript
interface PlatformPulseProps {
  data: {
    totalProspects: number;
    enrichmentCoverage: number;
    enrichmentFailed: number;
    activeUsersToday: number;
    activeUsers7dAvg: number;
  } | null;
}
```

4 stat cards in a responsive grid (`grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4`):

Card 1 — **Total Prospects**: Icon (lucide `Users`), count-up animated number, subtitle "enrichment coverage: X%"
Card 2 — **Enrichment Pipeline**: Icon (lucide `Activity`), show success rate as `(100 - failedPct)%`, subtitle "X failed" (clickable — shows enrichment_failed count in accent color)
Card 3 — **API Quota Burn**: Wrap with `<ComingSoonCard>`. Inside, show placeholder layout with 5 mini progress bars (one per provider). Content grayed out by the overlay.
Card 4 — **Active Users Today**: Icon (lucide `UserCheck`), count-up animated number, subtitle "7d avg: X"

All cards use dark theme styling consistent with existing admin UI:
- `rounded-lg border border-border bg-card p-6`
- Stat number: `text-3xl font-bold tabular-nums` (tabular-nums for count-up alignment)
- Label: `text-sm text-muted-foreground`
- Use useCountUp for the big numbers
- Gold accent on the enrichment coverage percentage: `text-primary`

Animation: Numbers count up on initial data load. On subsequent refreshes (data prop changes), numbers should update immediately (no re-animation — only animate on first non-null data).

If `data` is null (loading state), render skeleton placeholders with `animate-pulse` divs matching the card layout.

Mark with `"use client"` (uses hooks).

**File 4: `src/components/admin/tenant-heatmap.tsx`**

Props interface:
```typescript
interface TenantHeatmapProps {
  data: {
    tenants: Array<{
      id: string;
      name: string;
      userCount: number;
      searches7d: number;
      enrichments7d: number;
      exports7d: number;
      lastActive: string | null;
      users: Array<{
        id: string;
        fullName: string;
        searches7d: number;
        enrichments7d: number;
        exports7d: number;
      }>;
    }>;
  } | null;
}
```

Render a table with columns: Tenant Name, Users, Searches (7d), Enrichments (7d), Exports (7d), Last Active.

**Relative-to-peers color coding** (LOCKED DECISION — no hardcoded thresholds):
- Collect all non-zero values for each metric column across all tenants
- Rank each tenant's value within the sorted non-zero array
- Top 25%: `text-emerald-400` (healthy green-gold)
- Middle 50%: `text-amber-400` (moderate amber)
- Bottom 25%: `text-red-400` (warm red)
- Zero value when other tenants have data: `text-red-400`
- ALL zeros for a tenant (new tenant with no activity): show a "New" badge with `text-muted-foreground` — NOT red

Implement `getHeatmapClass(value: number, allValues: number[])` utility function as described in Research Pattern 3.

**Inline expansion** (LOCKED DECISION):
- Click a tenant row to expand it in-place
- Expanded section shows per-user table (data already in response — no extra API call)
- Use local `useState<string | null>` to track expanded tenant ID
- Collapse previous when a new one expands

Expandable row styling: expanded row below the parent with `bg-muted/30` background, indented slightly with `pl-8`.

If `data` is null (loading), render skeleton table rows.

Mark with `"use client"` (uses hooks for expand state).
  </action>
  <verify>
    <automated>cd "/Users/aymanbaig/Desktop/Manual Library/Phronesis-main" && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Verify all 4 files exist and export named components. Check that heatmap uses relative ranking, not hardcoded thresholds.</manual>
  </verify>
  <done>useCountUp hook, ComingSoonCard wrapper, PlatformPulse stat cards (4 cards with count-up, Coming Soon for quota), and TenantHeatmap (expandable table with relative-to-peers color coding) all created and type-check.</done>
</task>

<task type="auto">
  <name>Task 2: Create enrichment health chart, funnel chart, and error feed components</name>
  <files>
    src/components/admin/enrichment-health-chart.tsx
    src/components/admin/funnel-chart.tsx
    src/components/admin/error-feed.tsx
  </files>
  <action>
**File 5: `src/components/admin/enrichment-health-chart.tsx`**

Props interface:
```typescript
interface EnrichmentHealthChartProps {
  data: Array<{
    date: string;
    contactout_success: number; contactout_failed: number;
    exa_success: number; exa_failed: number;
    edgar_success: number; edgar_failed: number;
    claude_success: number; claude_failed: number;
  }> | null;
}
```

Use Recharts `BarChart` with `stackId` (already installed — Recharts 3.7.0).

Implementation:
- `ResponsiveContainer` with `width="100%" height={300}`
- `BarChart` with the data array
- `CartesianGrid` with `strokeDasharray="3 3"` and dark stroke (`#27272a`)
- `XAxis` dataKey="date" with muted axis color (`#a1a1aa`)
- `YAxis` with muted axis color
- `Tooltip` with dark theme contentStyle (bg: `#18181b`, border: `#3f3f46`, text: `#f4f4f5`)
- `Legend` to identify sources

For each source (contactout, exa, edgar, claude), render TWO `<Bar>` elements:
- `<Bar dataKey="{source}_success" stackId={source} fill={successColor} name="{Source} OK" />`
- `<Bar dataKey="{source}_failed" stackId={source} fill={failedColor} name="{Source} Fail" />`

**Color palette** (LOCKED DECISION — gold-adjacent warm hues, not generic colors):
- Success colors (gold tones, graduated by source): use OKLCH gold hues progressing from bright to muted. E.g.:
  - contactout: `oklch(0.84 0.10 85)` (bright gold)
  - exa: `oklch(0.77 0.09 85)`
  - edgar: `oklch(0.70 0.08 85)`
  - claude: `oklch(0.63 0.07 85)` (muted gold)
- Failed colors (warm red tones): `oklch(0.52 0.13 22)`, `oklch(0.46 0.12 22)`, `oklch(0.40 0.11 22)`, `oklch(0.35 0.10 22)`

Enable animations: `isAnimationActive={true}` with `animationBegin={100}` and `animationDuration={800}` on bars (LOCKED DECISION: bars grow in on load).

If `data` is null, render skeleton placeholder.
Mark with `"use client"`.

**File 6: `src/components/admin/funnel-chart.tsx`**

Props interface:
```typescript
interface FunnelChartProps {
  data: Array<{ stage: string; value: number }> | null;
}
```

Use Recharts `FunnelChart` + `Funnel` + `Cell` (confirmed installed in Recharts 3.7.0).

Implementation:
- `ResponsiveContainer` with `width="100%" height={280}`
- `FunnelChart`
- `Funnel` with `dataKey="value"` and `isAnimationActive={true}`
- `Cell` per data entry with gold-to-amber gradient colors:
  - `oklch(0.84 0.10 85)` (bright gold — Searches)
  - `oklch(0.77 0.09 80)`
  - `oklch(0.68 0.11 70)`
  - `oklch(0.60 0.12 60)` (warm amber — Exports)
- `LabelList` with `dataKey="name"` positioned right, fill with muted foreground color
- `Tooltip` with dark theme contentStyle

**CRITICAL (Research pitfall #5):** Memoize the funnel data array with `useMemo` to prevent Recharts `Cell` color reconciliation issues on re-renders. Also memoize the `Cell` array.

If `data` is null, render skeleton placeholder.
Mark with `"use client"`.

**File 7: `src/components/admin/error-feed.tsx`**

Props interface:
```typescript
interface ErrorFeedProps {
  data: {
    data: Array<{
      id: string;
      fullName: string;
      tenantName: string;
      tenantId: string;
      enrichmentStatus: string;
      sourceDetails: Record<string, { status: string; error?: string; at?: string }>;
      updatedAt: string;
    }>;
    total: number;
    page: number;
    limit: number;
  } | null;
  onPageChange: (page: number) => void;
}
```

Render a table with columns: Timestamp, Tenant, Prospect, Status, Details (expandable).

Features:
- Pagination: Previous/Next buttons below table. Call `onPageChange(newPage)` when clicked. Display "Page X of Y" info.
- Inline expansion: Click a row to expand and show per-source error details from `sourceDetails`. Each source shows status + error message (if present) + timestamp.
- Time formatting: Show relative time ("2 hours ago") for timestamps using simple date math (no library needed).
- NO re-trigger button (LOCKED DECISION — view-only).

Expanded row styling:
- Below the parent row with `bg-muted/30 border-l-2 border-primary/50`
- Show each source as a small badge: green-gold for success, warm red for failed, muted for skipped
- If error message exists, show it in `text-xs text-muted-foreground`

If `data` is null, render skeleton table.
Mark with `"use client"`.
  </action>
  <verify>
    <automated>cd "/Users/aymanbaig/Desktop/Manual Library/Phronesis-main" && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Verify all 3 chart/feed components exist and use Recharts imports. Check that funnel data is memoized.</manual>
  </verify>
  <done>EnrichmentHealthChart (stacked bar with gold-adjacent colors), FunnelChart (4-stage funnel with gold-to-amber gradient), and ErrorFeed (paginated expandable table, view-only) all created and type-check. Charts use Recharts from installed package.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. All 7 new files exist (1 hook + 6 components)
3. `grep -r "from 'recharts'" src/components/admin/` shows imports in enrichment-health-chart and funnel-chart
4. `grep "useCountUp" src/components/admin/platform-pulse.tsx` confirms count-up hook usage
5. `grep "ComingSoonCard" src/components/admin/platform-pulse.tsx` confirms Coming Soon usage on quota card
6. `grep "getHeatmapClass" src/components/admin/tenant-heatmap.tsx` confirms relative-rank function exists
7. `grep "useMemo" src/components/admin/funnel-chart.tsx` confirms data memoization
</verification>

<success_criteria>
- 7 new files compile cleanly
- PlatformPulse shows 4 stat cards with count-up animation and Coming Soon quota card
- TenantHeatmap uses relative-to-peers ranking (no hardcoded thresholds), new tenants show "New" not red
- EnrichmentHealthChart uses Recharts stacked BarChart with gold-adjacent palette
- FunnelChart uses Recharts FunnelChart with gold-to-amber colors and memoized data
- ErrorFeed is paginated, expandable, view-only (no re-trigger button)
- All components accept data props and render skeletons when null
</success_criteria>

<output>
After completion, create `.planning/phases/04-super-admin-health-dashboard-platform-pulse-tenant-heatmap-enrichment-pipeline-api-quota-tracking-funnel-analytics-error-feed/04-03-SUMMARY.md`
</output>
