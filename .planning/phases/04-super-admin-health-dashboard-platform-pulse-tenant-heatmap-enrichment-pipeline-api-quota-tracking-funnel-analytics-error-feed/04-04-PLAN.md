---
phase: 04-super-admin-health-dashboard-platform-pulse-tenant-heatmap-enrichment-pipeline-api-quota-tracking-funnel-analytics-error-feed
plan: 04
type: execute
wave: 3
depends_on: ["04-03"]
files_modified:
  - src/app/admin/page.tsx
autonomous: false
requirements:
  - "DESIGN.md Section: Layout (4 vertical sections, scrollable)"
  - "CONTEXT.md Decision: Auto-refresh every 60 seconds"
  - "CONTEXT.md Decision: Show Updated X seconds ago timestamp"
  - "CONTEXT.md Decision: Subtle refresh indicator during polling"
  - "CONTEXT.md Decision: Subtle animations on load"

must_haves:
  truths:
    - "Admin dashboard renders 4 vertical sections: Platform Pulse, Tenant Heatmap, Graphs (enrichment + funnel side-by-side), Error Feed"
    - "Dashboard auto-refreshes every 60 seconds without full-page loading states"
    - "Updated X seconds ago timestamp is visible and ticks every second"
    - "Subtle refresh indicator appears during background data fetch"
    - "Dashboard fetches all data via parallel Promise.all to 5 API endpoints"
    - "Super admin sees the complete health command center on the /admin page"
  artifacts:
    - path: "src/app/admin/page.tsx"
      provides: "Full health dashboard with polling, all 4 sections composed"
      contains: "use client"
  key_links:
    - from: "src/app/admin/page.tsx"
      to: "/api/admin/dashboard"
      via: "fetch in useEffect poll loop"
      pattern: "fetch.*api/admin/dashboard"
    - from: "src/app/admin/page.tsx"
      to: "/api/admin/tenants/activity"
      via: "fetch in useEffect poll loop"
      pattern: "fetch.*api/admin/tenants/activity"
    - from: "src/app/admin/page.tsx"
      to: "/api/admin/enrichment/health"
      via: "fetch in useEffect poll loop"
      pattern: "fetch.*api/admin/enrichment/health"
    - from: "src/app/admin/page.tsx"
      to: "/api/admin/funnel"
      via: "fetch in useEffect poll loop"
      pattern: "fetch.*api/admin/funnel"
    - from: "src/app/admin/page.tsx"
      to: "/api/admin/errors"
      via: "fetch in useEffect poll loop"
      pattern: "fetch.*api/admin/errors"
    - from: "src/app/admin/page.tsx"
      to: "src/components/admin/*"
      via: "imports PlatformPulse, TenantHeatmap, EnrichmentHealthChart, FunnelChart, ErrorFeed"
      pattern: "import.*from.*@/components/admin"
---

<objective>
Refactor `src/app/admin/page.tsx` from a Server Component with 4 static count cards into a Client Component that serves as the platform health command center. Wire up 60-second auto-refresh polling to all 5 API endpoints and compose all dashboard sections.

Purpose: This is the final assembly step — connecting the API layer (Plan 02) with the UI components (Plan 03) into a single, live, polled dashboard page.

Output: Refactored `src/app/admin/page.tsx` as a working health dashboard.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-super-admin-health-dashboard-platform-pulse-tenant-heatmap-enrichment-pipeline-api-quota-tracking-funnel-analytics-error-feed/DESIGN.md
@.planning/phases/04-super-admin-health-dashboard-platform-pulse-tenant-heatmap-enrichment-pipeline-api-quota-tracking-funnel-analytics-error-feed/04-RESEARCH.md
@.planning/phases/04-super-admin-health-dashboard-platform-pulse-tenant-heatmap-enrichment-pipeline-api-quota-tracking-funnel-analytics-error-feed/04-02-SUMMARY.md
@.planning/phases/04-super-admin-health-dashboard-platform-pulse-tenant-heatmap-enrichment-pipeline-api-quota-tracking-funnel-analytics-error-feed/04-03-SUMMARY.md
@src/app/admin/page.tsx
@src/app/admin/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor admin page to client component with polling and section composition</name>
  <files>src/app/admin/page.tsx</files>
  <action>
**COMPLETELY REPLACE** the existing `src/app/admin/page.tsx` (currently a Server Component with 4 static count cards).

The new file is a `"use client"` component. The admin layout (`src/app/admin/layout.tsx`) already handles the `requireSuperAdmin()` guard, so the page does not need auth checks.

**Structure:**

```typescript
"use client";

import { useEffect, useState, useCallback, useRef } from "react";
import { PlatformPulse } from "@/components/admin/platform-pulse";
import { TenantHeatmap } from "@/components/admin/tenant-heatmap";
import { EnrichmentHealthChart } from "@/components/admin/enrichment-health-chart";
import { FunnelChart as FunnelChartComponent } from "@/components/admin/funnel-chart";
import { ErrorFeed } from "@/components/admin/error-feed";
import { RefreshCw } from "lucide-react";
```

**State:**
- `pulseData` — response from `/api/admin/dashboard`
- `heatmapData` — response from `/api/admin/tenants/activity`
- `enrichmentData` — response from `/api/admin/enrichment/health` (just the `.data` array)
- `funnelData` — response from `/api/admin/funnel` (just the `.data` array)
- `errorData` — response from `/api/admin/errors` (full paginated response)
- `lastFetched: Date | null` — timestamp of last successful fetch
- `isRefreshing: boolean` — true during background refreshes (not initial load)
- `errorPage: number` — current page for error feed pagination (default 1)
- `secondsAgo: number` — for "Updated X seconds ago" display

**Data fetching:**

Create `fetchAll` as a `useCallback`:
- Takes `isBackground: boolean` param
- If `isBackground`, set `isRefreshing = true` (subtle indicator), do NOT null out existing data
- Use `Promise.all` to fetch all 5 endpoints in parallel:
  - `/api/admin/dashboard`
  - `/api/admin/tenants/activity`
  - `/api/admin/enrichment/health?days=14`
  - `/api/admin/funnel?days=7`
  - `/api/admin/errors?limit=50&page=${errorPage}`
- On success, update all state and set `lastFetched = new Date()`
- In `finally`, set `isRefreshing = false`

**Polling:**
- `useEffect` with `fetchAll(false)` on mount (initial load — full loading state)
- `setInterval(() => fetchAll(true), 60_000)` — 60-second background refresh
- Cleanup: `clearInterval` on unmount

**"Updated X seconds ago" ticker:**
- Separate `useEffect` with `setInterval(() => { if (lastFetched) setSecondsAgo(Math.floor((Date.now() - lastFetched.getTime()) / 1000)); }, 1000)`
- Display format: "Updated X seconds ago" / "Updated 1 minute ago" / "Updated X minutes ago"

**Error feed pagination handler:**
- `handleErrorPageChange(page: number)` — set `errorPage` state, trigger a fetch just for errors endpoint

**Layout (4 vertical sections, scrollable):**

```jsx
<div className="space-y-8">
  {/* Header */}
  <div className="flex items-center justify-between">
    <div>
      <h1 className="font-serif text-3xl font-bold tracking-tight">Platform Health</h1>
      <p className="text-muted-foreground mt-1">Real-time platform monitoring</p>
    </div>
    <div className="flex items-center gap-3 text-sm text-muted-foreground">
      {isRefreshing && <RefreshCw className="h-4 w-4 animate-spin text-primary" />}
      {lastFetched && <span>Updated {formatSecondsAgo(secondsAgo)}</span>}
    </div>
  </div>

  {/* Section 1: Platform Pulse */}
  <PlatformPulse data={pulseData} />

  {/* Section 2: Tenant Activity Heatmap */}
  <section>
    <h2 className="font-serif text-xl font-semibold mb-4">Tenant Activity</h2>
    <TenantHeatmap data={heatmapData} />
  </section>

  {/* Section 3: Graphs (2-up layout) */}
  <section>
    <h2 className="font-serif text-xl font-semibold mb-4">Pipeline Analytics</h2>
    <div className="grid gap-6 lg:grid-cols-2">
      <div className="rounded-lg border border-border bg-card p-6">
        <h3 className="text-sm font-medium text-muted-foreground mb-4">Enrichment Pipeline Health</h3>
        <EnrichmentHealthChart data={enrichmentData} />
      </div>
      <div className="rounded-lg border border-border bg-card p-6">
        <h3 className="text-sm font-medium text-muted-foreground mb-4">Search to Export Funnel</h3>
        <FunnelChartComponent data={funnelData} />
      </div>
    </div>
  </section>

  {/* Section 4: Error/Failure Feed */}
  <section>
    <h2 className="font-serif text-xl font-semibold mb-4">Recent Failures</h2>
    <ErrorFeed data={errorData} onPageChange={handleErrorPageChange} />
  </section>
</div>
```

**Refresh indicator:** The `RefreshCw` spinning icon in the header is the subtle indicator (LOCKED DECISION: no full-page loading states on refresh). On initial load when all data is null, components render their own skeleton states.

**formatSecondsAgo helper** (inline in the file):
```typescript
function formatSecondsAgo(seconds: number): string {
  if (seconds < 60) return `${seconds}s ago`;
  const minutes = Math.floor(seconds / 60);
  return minutes === 1 ? "1 min ago" : `${minutes} min ago`;
}
```
  </action>
  <verify>
    <automated>cd "/Users/aymanbaig/Desktop/Manual Library/Phronesis-main" && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Verify admin/page.tsx is a client component, imports all 5 dashboard components, and has 60s polling</manual>
  </verify>
  <done>Admin dashboard page refactored from Server Component to Client Component. Fetches 5 API endpoints in parallel, polls every 60s with subtle refresh indicator, displays "Updated X ago" timestamp, composes all 4 dashboard sections.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of health dashboard</name>
  <files>src/app/admin/page.tsx</files>
  <action>
    Human verification checkpoint. Complete platform health dashboard replacing the old 4-card admin page. The dashboard has:
    1. Platform Pulse — 4 stat cards with count-up animation (API Quota shows Coming Soon)
    2. Tenant Activity Heatmap — expandable table with relative-rank color coding
    3. Pipeline Analytics — stacked bar chart (enrichment health) + funnel chart (search-to-export) side by side
    4. Recent Failures — paginated expandable error feed (view-only)
    Plus: 60-second auto-refresh with "Updated X ago" timestamp and subtle spinning refresh icon

    Verification steps:
    1. Run `pnpm dev`
    2. Navigate to `http://localhost:3000/admin` (logged in as super_admin)
    3. Verify 4 sections render vertically with correct data, styling, and interactions
    4. Wait 60 seconds — subtle spinning icon should appear, data refreshes, timestamp resets
    5. Check dark theme consistency
  </action>
  <verify>
    <manual>User visually verifies dashboard layout, interactions, and auto-refresh behavior at http://localhost:3000/admin</manual>
  </verify>
  <done>User approves the health dashboard visual appearance, interactions (expand/collapse), auto-refresh behavior, and dark theme consistency.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `pnpm build` succeeds (no build errors)
3. Admin page loads at /admin with all 4 sections
4. 60-second polling works (check Network tab for periodic API calls)
5. "Updated X ago" timestamp ticks every second
6. Subtle refresh indicator (spinning icon) visible during background refreshes
</verification>

<success_criteria>
- Admin dashboard is a live, polling platform health command center
- 4 vertical sections render: Platform Pulse, Tenant Heatmap, Charts (2-up), Error Feed
- Auto-refresh every 60 seconds with subtle indicator
- "Updated X seconds ago" timestamp visible and ticking
- No full-page loading states during background refreshes
- All components receive real API data and render correctly
- Visual checkpoint passes user approval
</success_criteria>

<output>
After completion, create `.planning/phases/04-super-admin-health-dashboard-platform-pulse-tenant-heatmap-enrichment-pipeline-api-quota-tracking-funnel-analytics-error-feed/04-04-SUMMARY.md`
</output>
