---
phase: 03-enrich-ship
plan: 06
type: execute
wave: 3
depends_on: ["03-01", "03-02", "03-04"]
files_modified:
  - src/inngest/functions/daily-metrics.ts
  - src/app/api/analytics/route.ts
  - src/app/api/inngest/route.ts
autonomous: true

must_haves:
  truths:
    - "Daily metrics are aggregated from activity_log into usage_metrics_daily at 1 AM via Inngest cron"
    - "Analytics API returns aggregated metrics by date range (7d, 30d, 90d)"
    - "Tenant admin sees own team's metrics, super admin sees all tenants' metrics"
    - "Metrics include: total_logins, searches_executed, profiles_viewed, profiles_enriched, csv_exports, lists_created"
  artifacts:
    - path: "src/inngest/functions/daily-metrics.ts"
      provides: "Scheduled daily aggregation Inngest function"
      exports: ["aggregateDailyMetrics"]
    - path: "src/app/api/analytics/route.ts"
      provides: "Analytics API with date range filtering"
      exports: ["GET"]
    - path: "src/app/api/inngest/route.ts"
      provides: "Updated serve endpoint with daily-metrics function"
      exports: ["GET", "POST", "PUT"]
  key_links:
    - from: "src/inngest/functions/daily-metrics.ts"
      to: "supabase"
      via: "SQL aggregation from activity_log to usage_metrics_daily"
      pattern: "usage_metrics_daily.*INSERT"
    - from: "src/app/api/analytics/route.ts"
      to: "supabase"
      via: "Query usage_metrics_daily with date range"
      pattern: "usage_metrics_daily.*select"
    - from: "src/app/api/inngest/route.ts"
      to: "src/inngest/functions/daily-metrics.ts"
      via: "registered in serve functions array"
      pattern: "aggregateDailyMetrics"
---

<objective>
Build the usage metrics aggregation system: Inngest cron for daily stats and analytics API endpoint, covering ANLY-01, ANLY-04, ANLY-05, ANLY-06.

Purpose: Usage metrics are critical for 6-month renewal proof. Pre-aggregating into usage_metrics_daily table ensures fast dashboard queries. The Inngest cron runs nightly to aggregate the previous day's activity logs.

Output: Scheduled Inngest aggregation function and analytics API endpoint with date range filtering.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-enrich-ship/03-RESEARCH.md
@.planning/phases/03-enrich-ship/03-01-SUMMARY.md
@.planning/phases/03-enrich-ship/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Inngest daily metrics aggregation cron function</name>
  <files>
    src/inngest/functions/daily-metrics.ts
    src/app/api/inngest/route.ts
  </files>
  <action>
Create `src/inngest/functions/daily-metrics.ts`:

1. Import inngest client, Supabase admin client

2. Export `aggregateDailyMetrics` as an Inngest function:
   ```typescript
   export const aggregateDailyMetrics = inngest.createFunction(
     {
       id: "aggregate-daily-metrics",
       retries: 2,
     },
     { cron: "0 1 * * *" }, // Run at 1 AM UTC daily
     async ({ step }) => { ... }
   );
   ```

3. Function body:

   **Step 1: "compute-date-range"** — Calculate yesterday's date range (midnight to midnight UTC)

   **Step 2: "aggregate-metrics"** — Execute raw SQL via Supabase admin client:
   ```sql
   INSERT INTO usage_metrics_daily (
     date, tenant_id, user_id,
     total_logins, searches_executed, profiles_viewed,
     profiles_enriched, csv_exports, lists_created
   )
   SELECT
     DATE(created_at) as date,
     tenant_id,
     user_id,
     COUNT(*) FILTER (WHERE action_type = 'login') as total_logins,
     COUNT(*) FILTER (WHERE action_type = 'search_executed') as searches_executed,
     COUNT(*) FILTER (WHERE action_type = 'profile_viewed') as profiles_viewed,
     COUNT(*) FILTER (WHERE action_type = 'profile_enriched') as profiles_enriched,
     COUNT(*) FILTER (WHERE action_type = 'csv_exported') as csv_exports,
     COUNT(*) FILTER (WHERE action_type IN ('add_to_list')) as lists_created
   FROM activity_log
   WHERE created_at >= $1 AND created_at < $2
   GROUP BY DATE(created_at), tenant_id, user_id
   ON CONFLICT (date, tenant_id, user_id) DO UPDATE SET
     total_logins = EXCLUDED.total_logins,
     searches_executed = EXCLUDED.searches_executed,
     profiles_viewed = EXCLUDED.profiles_viewed,
     profiles_enriched = EXCLUDED.profiles_enriched,
     csv_exports = EXCLUDED.csv_exports,
     lists_created = EXCLUDED.lists_created,
     updated_at = NOW();
   ```

   Use Supabase `.rpc()` or `.from('usage_metrics_daily')` with raw SQL execution.
   Pass yesterday's start and end timestamps as parameters.

   **Step 3: "log-completion"** — Log the aggregation result (number of rows upserted, date processed)

4. Return: `{ aggregated: true, date: yesterdayDateString }`

Update `src/app/api/inngest/route.ts`:
- Import `aggregateDailyMetrics`
- Add to the serve functions array alongside `enrichProspect`

**Note:** Use Supabase admin/service role client for the aggregation query — it needs to read across all tenants' activity logs. The RLS is bypassed intentionally for this system-level aggregation.
  </action>
  <verify>
`src/inngest/functions/daily-metrics.ts` exports `aggregateDailyMetrics`.
Cron is set to "0 1 * * *".
SQL aggregation uses COUNT(*) FILTER for each metric.
ON CONFLICT handles re-runs.
`src/app/api/inngest/route.ts` includes both functions.
`pnpm build` passes.
  </verify>
  <done>
Daily metrics cron aggregates activity logs into usage_metrics_daily. Handles re-runs with ON CONFLICT upsert. Registered in Inngest serve endpoint.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create analytics API endpoint with date range filtering</name>
  <files>src/app/api/analytics/route.ts</files>
  <action>
Create `src/app/api/analytics/route.ts`:

1. Export async GET handler:
   - Validate user session (reject 401)
   - Extract query params:
     - `range`: '7d' | '30d' | '90d' (default: '30d')
     - `tenant_id`: optional (only for super_admin cross-tenant view)
   - Determine user role from session

2. Calculate date range from `range` param:
   - '7d' -> last 7 days
   - '30d' -> last 30 days
   - '90d' -> last 90 days

3. Build query based on role:

   **For tenant_admin:**
   - Query `usage_metrics_daily` WHERE tenant_id = user's tenant AND date >= calculated start date
   - Aggregate across all users in tenant: SUM each metric
   - Group by date, order by date ASC
   - Also return per-user breakdown

   **For super_admin:**
   - If `tenant_id` param provided, filter to that tenant
   - Otherwise, aggregate across ALL tenants
   - Group by date (and optionally by tenant_id for breakdown)
   - Order by date ASC

4. Return JSON response:
   ```typescript
   {
     data: {
       daily: Array<{
         date: string;
         totalLogins: number;
         searchesExecuted: number;
         profilesViewed: number;
         profilesEnriched: number;
         csvExports: number;
         listsCreated: number;
       }>;
       totals: {
         totalLogins: number;
         searchesExecuted: number;
         profilesViewed: number;
         profilesEnriched: number;
         csvExports: number;
         listsCreated: number;
       };
       userBreakdown?: Array<{
         userId: string;
         userName: string;
         totalLogins: number;
         // ... same metrics
       }>;
     },
     range: string;
     startDate: string;
     endDate: string;
   }
   ```

5. Role restrictions:
   - agent/assistant: 403 Forbidden
   - tenant_admin: own tenant only (ignore tenant_id param)
   - super_admin: all tenants or filtered by tenant_id

**Important:** Use the admin/service role client for super_admin queries (needs cross-tenant access). Use user's session client for tenant_admin queries (RLS scoped).
  </action>
  <verify>
File exists at `src/app/api/analytics/route.ts`.
GET handler supports range param (7d, 30d, 90d).
Tenant admin gets own team data. Super admin gets cross-tenant data.
Response includes daily array and totals.
`pnpm build` passes.
  </verify>
  <done>
Analytics API returns aggregated usage metrics by date range. Supports tenant-scoped and cross-tenant views based on role. Covers ANLY-04, ANLY-05, ANLY-06.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes
2. Daily metrics cron is registered in Inngest
3. Analytics API handles 7d, 30d, 90d date ranges
4. Role-based access: tenant_admin (own team), super_admin (all)
5. SQL aggregation uses FILTER for each metric type
6. ON CONFLICT handles idempotent re-runs
</verification>

<success_criteria>
Usage metrics system: nightly cron aggregates activity logs into pre-computed daily stats. Analytics API serves aggregated data with date range filtering and role-based access. Requirements ANLY-01, ANLY-04, ANLY-05, ANLY-06 covered.
</success_criteria>

<output>
After completion, create `.planning/phases/03-enrich-ship/03-06-SUMMARY.md`
</output>
