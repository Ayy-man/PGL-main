---
phase: 03-enrich-ship
plan: 08
type: execute
wave: 3
depends_on: ["03-04", "03-02"]
files_modified:
  - src/lib/enrichment/lookalike.ts
  - src/app/api/search/lookalike/route.ts
  - src/components/prospect/lookalike-discovery.tsx
autonomous: true

must_haves:
  truths:
    - "'Find Similar People' button triggers Claude to extract attributes from prospect"
    - "Extracted attributes generate Apollo.io-compatible search filters"
    - "Generated persona triggers Apollo search via POST to https://api.apollo.io/v1/mixed_people/search and displays results"
    - "User can save generated lookalike persona for future reuse"
    - "Lookalike search triggers activity log entry"
  artifacts:
    - path: "src/lib/enrichment/lookalike.ts"
      provides: "Claude persona extraction and Apollo filter generation"
      exports: ["generateLookalikePersona", "searchApollo"]
    - path: "src/app/api/search/lookalike/route.ts"
      provides: "Lookalike discovery API orchestrating extract -> search"
      exports: ["POST"]
    - path: "src/components/prospect/lookalike-discovery.tsx"
      provides: "Lookalike discovery UI component"
      exports: ["LookalikeDiscovery"]
  key_links:
    - from: "src/app/api/search/lookalike/route.ts"
      to: "src/lib/enrichment/lookalike.ts"
      via: "calls generateLookalikePersona then searchApollo"
      pattern: "generateLookalikePersona|searchApollo"
    - from: "src/lib/enrichment/lookalike.ts"
      to: "https://api.apollo.io/v1/mixed_people/search"
      via: "fetch POST with X-Api-Key header using APOLLO_API_KEY env var"
      pattern: "apollo\\.io.*mixed_people"
    - from: "src/app/api/search/lookalike/route.ts"
      to: "src/lib/activity-logger.ts"
      via: "logs lookalike_search activity"
      pattern: "logActivity.*lookalike_search"
    - from: "src/components/prospect/lookalike-discovery.tsx"
      to: "src/app/api/search/lookalike/route.ts"
      via: "fetch POST to /api/search/lookalike"
      pattern: "fetch.*api/search/lookalike"
---

<objective>
Build the Lookalike Discovery feature: AI extracts attributes from a prospect, generates Apollo-compatible filters, searches for similar people via Apollo API, and allows saving the generated persona.

Purpose: Lookalike Discovery is a key differentiator (Adrian loved it). Users can find more prospects similar to a high-value one with a single click. Claude analyzes the prospect's attributes and generates search filters automatically. Covers LIKE-01 through LIKE-06.

Output: Lookalike persona generation, Apollo API search integration, lookalike search API, and discovery UI component.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-enrich-ship/03-RESEARCH.md
@.planning/phases/03-enrich-ship/03-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lookalike persona generator with Apollo API integration and search API</name>
  <files>
    src/lib/enrichment/lookalike.ts
    src/app/api/search/lookalike/route.ts
  </files>
  <action>
Create `src/lib/enrichment/lookalike.ts`:

1. Import Anthropic from "@anthropic-ai/sdk" and zod

2. Define PersonaSchema with zod:
   ```typescript
   const PersonaSchema = z.object({
     name: z.string().describe("Generated persona name"),
     jobTitles: z.array(z.string()).describe("Similar job titles"),
     seniority: z.enum(["entry", "manager", "director", "vp", "c-level"]),
     industries: z.array(z.string()).describe("Target industries"),
     companySize: z.enum(["1-10", "11-50", "51-200", "201-1000", "1001-5000", "5001+"]),
     locations: z.array(z.string()).optional().describe("Target locations"),
     keywords: z.array(z.string()).describe("Keywords for this persona"),
     reasoning: z.string().describe("Why these attributes match"),
   });
   ```

3. Export async function `generateLookalikePersona(prospect: ProspectData): Promise<LookalikeResult>`:
   - ProspectData includes: name, title, company, linkedin, webData, insiderData, ai_summary
   - Create Anthropic client
   - Call claude-haiku-4-5 with structured output (output_config.format with json_schema):
     - System: "You are a lead research analyst. Extract key professional attributes from a prospect to find similar people. Focus on role seniority, industry, company characteristics, and wealth indicators."
     - User: Include all available prospect data
     - JSON schema: matches PersonaSchema
   - Parse response with PersonaSchema.parse()
   - Convert to Apollo.io search filters:
     ```typescript
     const apolloFilters = {
       person_titles: persona.jobTitles,
       person_seniorities: [persona.seniority],
       q_organization_domains: [], // optional, filled if company domain known
       organization_industry_tag_ids: persona.industries,
       organization_num_employees_ranges: [persona.companySize],
       person_locations: persona.locations,
       q_keywords: persona.keywords.join(" OR "),
     };
     ```
   - Return: `{ persona, apolloFilters }`

4. Export async function `searchApollo(filters: ApolloFilters): Promise<ApolloSearchResult>`:
   - **Endpoint:** POST `https://api.apollo.io/v1/mixed_people/search`
   - **Headers:**
     ```typescript
     {
       'Content-Type': 'application/json',
       'X-Api-Key': process.env.APOLLO_API_KEY!, // Set in Phase 2, already in .env
     }
     ```
   - **Request body:**
     ```typescript
     {
       person_titles: filters.person_titles,           // e.g., ["CEO", "Founder", "Managing Director"]
       person_seniorities: filters.person_seniorities, // e.g., ["c_suite", "vp", "director"]
       q_organization_domains: filters.q_organization_domains, // e.g., ["example.com"]
       organization_industry_tag_ids: filters.organization_industry_tag_ids,
       organization_num_employees_ranges: filters.organization_num_employees_ranges, // e.g., ["1,1000"]
       person_locations: filters.person_locations,      // e.g., ["United States"]
       q_keywords: filters.q_keywords,                  // e.g., "real estate OR investment"
       page: 1,
       per_page: 25,
     }
     ```
   - **Response parsing:**
     ```typescript
     interface ApolloSearchResult {
       people: Array<{
         id: string;
         name: string;
         title: string;
         organization_name: string;
         city: string;
         state: string;
         country: string;
         linkedin_url: string;
         email: string;
       }>;
       pagination: { total_entries: number; total_pages: number; page: number; per_page: number };
     }
     ```
   - Parse `response.people` array from the Apollo response body
   - Parse `response.pagination` for total result count
   - **Error handling:**
     - 401: Log "Apollo API key invalid or expired" and return empty results with error message
     - 422: Log "Apollo search filter validation failed" with response body, return empty results
     - 429: Log "Apollo rate limit hit", return empty results with retry-after if provided
     - Network errors: catch, log, return empty results with error field

**Important:** The `APOLLO_API_KEY` env var is already configured from Phase 2 (Apollo prospect search). Do NOT create a new env var.

Create `src/app/api/search/lookalike/route.ts`:

1. Export async POST handler:
   - Validate user session (401 if not authenticated)
   - Extract `prospectId` and optional `savePersona` (boolean) from request body
   - Fetch prospect data from database (with enrichment data)
   - Call `generateLookalikePersona(prospectData)` to get persona + apolloFilters
   - Call `searchApollo(apolloFilters)` to execute the Apollo people search
   - If `savePersona` is true:
     - Save generated persona to `personas` table with:
       - name: persona.name (e.g., "Similar to John Smith")
       - description: persona.reasoning
       - filters: apolloFilters as JSONB
       - tenant_id from session
       - is_generated: true (flag to distinguish from manually created)
     - Log activity: persona_created
   - Log activity: `logActivity({ actionType: 'lookalike_search', targetType: 'prospect', targetId: prospectId, metadata: { generatedPersonaName: persona.name, resultCount: apolloResults.people.length } })`
   - Return:
     ```typescript
     {
       persona: { name, jobTitles, seniority, industries, companySize, keywords, reasoning },
       apolloFilters,
       searchResults: apolloResults.people, // Array of matching people from Apollo
       totalResults: apolloResults.pagination.total_entries,
       savedPersonaId?: string, // If persona was saved
     }
     ```

**Important:**
- Claude Haiku 4.5 structured outputs ensure valid JSON every time — no need for manual JSON parsing fallbacks
- The Apollo search uses the same APOLLO_API_KEY from Phase 2 — no new env vars needed
- The `searchApollo` function is a direct API call, not a reuse of any Phase 2 module (to keep this self-contained)
  </action>
  <verify>
`src/lib/enrichment/lookalike.ts` exports `generateLookalikePersona` and `searchApollo`.
`src/app/api/search/lookalike/route.ts` exports POST handler.
Persona generation uses Claude structured outputs with json_schema.
Apollo API call uses POST to `https://api.apollo.io/v1/mixed_people/search` with `X-Api-Key` header.
Apollo response is parsed for `people` array and `pagination`.
Apollo error handling covers 401, 422, 429, and network errors.
Activity logged for lookalike_search and optionally persona_created.
`pnpm build` passes.
  </verify>
  <done>
Lookalike persona generator extracts attributes with Claude and converts to Apollo filters. Apollo API is called directly with explicit endpoint, headers, body, and response parsing. Search API orchestrates the full flow: extract -> generate filters -> Apollo search -> optionally save persona.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create lookalike discovery UI component</name>
  <files>src/components/prospect/lookalike-discovery.tsx</files>
  <action>
Create `src/components/prospect/lookalike-discovery.tsx`:

1. "use client" component
2. Props: `{ prospectId: string; prospectName: string }`
3. State management:
   - `isLoading`: boolean (loading state during AI extraction + search)
   - `result`: null | { persona, searchResults, savedPersonaId }
   - `showResults`: boolean (toggle results view)
   - `saveChecked`: boolean (checkbox for saving persona)

4. UI flow:
   **Initial state:** "Find Similar People" button (gold accent, lucide-react Users icon)

   **Loading state:** Button disabled, spinner, text "Analyzing prospect and searching..."

   **Results state:** Expandable panel showing:
   - **Generated Persona Card:**
     - Name: persona.name
     - Attributes: job titles, seniority, industries, company size, keywords (as tags)
     - Reasoning: persona.reasoning (italic, muted text)
     - "Save Persona" button (if not already saved)

   - **Similar Prospects Table:**
     - Columns: Name, Title, Company, Location
     - Rows from searchResults (limit display to 20)
     - Each row clickable to navigate to that prospect's profile
     - "Add to List" button on each row — uses the existing Phase 2 list member endpoint (POST `/api/lists/[listId]/members` from Phase 2 list management) to add the prospect to a selected list
     - Empty state: "No similar prospects found"

   - **Actions:**
     - "Search Again" button (re-runs with same prospect)
     - "Save Persona for Reuse" checkbox + confirm button

5. Fetch handler:
   ```typescript
   const handleFindSimilar = async () => {
     setIsLoading(true);
     const response = await fetch('/api/search/lookalike', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify({ prospectId, savePersona: saveChecked }),
     });
     const data = await response.json();
     setResult(data);
     setIsLoading(false);
     setShowResults(true);
   };
   ```

6. Styling:
   - Dark theme: bg-zinc-900, border-zinc-800
   - Gold accent on "Find Similar" button: bg-[#d4af37] text-black hover:bg-[#f4d47f]
   - Tags for attributes: bg-zinc-800 text-zinc-300 rounded-full px-3 py-1
   - Results table: dark rows with hover state

7. Wire this component into the ProfileView from Plan 07:
   - Replace the stub "Find Similar People" button with `<LookalikeDiscovery prospectId={prospect.id} prospectName={prospect.name} />`
   - Import LookalikeDiscovery in profile-view.tsx

**Note:** This component is designed to be used within the profile view page. It handles the full flow from button click to displaying results.
  </action>
  <verify>
Component file exists at `src/components/prospect/lookalike-discovery.tsx`.
Exports LookalikeDiscovery.
Has loading, results, and initial states.
Calls /api/search/lookalike on click.
Shows generated persona attributes and search results.
"Save Persona" functionality included.
Dark theme with gold accents.
`pnpm build` passes.
  </verify>
  <done>
Lookalike Discovery UI component handles the full flow: click "Find Similar" -> AI analyzes prospect -> display generated persona + search results -> optionally save persona. Integrated into profile view. Covers LIKE-01 through LIKE-06.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes
2. Lookalike search generates persona with Claude structured outputs
3. Apollo API called at `https://api.apollo.io/v1/mixed_people/search` with `X-Api-Key` header and correct body structure
4. Apollo response parsed for `people` array with name, title, organization_name, etc.
5. Apollo error handling covers 401, 422, 429, and network failures
6. Persona can be saved to database
7. Activity logged for lookalike_search
8. UI shows generated persona attributes and search results
9. Component integrated into profile view
</verification>

<success_criteria>
Lookalike Discovery works end-to-end: "Find Similar People" -> Claude extracts attributes -> Apollo API search at /v1/mixed_people/search returns similar prospects -> user can save persona for reuse. Activity logged. Requirements LIKE-01 through LIKE-06 complete.
</success_criteria>

<output>
After completion, create `.planning/phases/03-enrich-ship/03-08-SUMMARY.md`
</output>
