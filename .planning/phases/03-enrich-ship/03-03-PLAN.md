---
phase: 03-enrich-ship
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/circuit-breaker.ts
  - src/lib/enrichment/contactout.ts
  - src/lib/enrichment/exa.ts
  - src/lib/enrichment/edgar.ts
autonomous: true
user_setup:
  - service: contactout
    why: "Personal email and phone enrichment"
    env_vars:
      - name: CONTACTOUT_API_KEY
        source: "ContactOut Dashboard -> API -> API Key"
  - service: exa
    why: "Web presence, news, wealth signal enrichment"
    env_vars:
      - name: EXA_API_KEY
        source: "Exa.ai Dashboard -> API Keys"
  - service: sec-edgar
    why: "SEC EDGAR requires identification in User-Agent header"
    env_vars:
      - name: SEC_EDGAR_USER_AGENT
        source: "Format: 'AppName admin@email.com' (SEC requires contact info)"

must_haves:
  truths:
    - "ContactOut client enriches personal email and phone from LinkedIn URL or work email"
    - "Exa client searches for web presence, news mentions, and wealth signals"
    - "SEC EDGAR client fetches Form 4 insider transactions for public company execs"
    - "All three clients are wrapped with circuit breakers that fail-fast when services are down"
    - "Circuit breakers open after 50% error rate and reset after 30s"
  artifacts:
    - path: "src/lib/circuit-breaker.ts"
      provides: "Shared circuit breaker factory"
      exports: ["createCircuitBreaker", "withCircuitBreaker"]
    - path: "src/lib/enrichment/contactout.ts"
      provides: "ContactOut API client with circuit breaker"
      exports: ["enrichContactOut"]
    - path: "src/lib/enrichment/exa.ts"
      provides: "Exa.ai API client with circuit breaker"
      exports: ["enrichExa"]
    - path: "src/lib/enrichment/edgar.ts"
      provides: "SEC EDGAR API client with circuit breaker"
      exports: ["enrichEdgar"]
  key_links:
    - from: "src/lib/enrichment/contactout.ts"
      to: "src/lib/circuit-breaker.ts"
      via: "wraps API call with circuit breaker"
      pattern: "withCircuitBreaker|createCircuitBreaker"
    - from: "src/lib/enrichment/exa.ts"
      to: "src/lib/circuit-breaker.ts"
      via: "wraps API call with circuit breaker"
      pattern: "withCircuitBreaker|createCircuitBreaker"
    - from: "src/lib/enrichment/edgar.ts"
      to: "src/lib/circuit-breaker.ts"
      via: "wraps API call with circuit breaker"
      pattern: "withCircuitBreaker|createCircuitBreaker"
---

<objective>
Build circuit breaker infrastructure and three enrichment API clients: ContactOut, Exa.ai, and SEC EDGAR.

Purpose: These clients are the data sources for lazy enrichment. Each wraps an external API with circuit breaker resilience to prevent cascading failures. They will be called by the Inngest enrichment workflow (Plan 04).

Output: Three enrichment clients with circuit breaker protection, ready to be consumed by the enrichment workflow.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-enrich-ship/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create circuit breaker factory and ContactOut client</name>
  <files>
    src/lib/circuit-breaker.ts
    src/lib/enrichment/contactout.ts
  </files>
  <action>
Install opossum:
```bash
pnpm add opossum
pnpm add -D @types/opossum
```

Create `src/lib/circuit-breaker.ts`:
- Import CircuitBreaker from "opossum"
- Export default breaker options:
  ```typescript
  const DEFAULT_BREAKER_OPTIONS = {
    timeout: 10000,        // 10s timeout per request
    errorThresholdPercentage: 50,  // Open after 50% failures
    resetTimeout: 30000,   // Try again after 30s
    rollingCountTimeout: 60000,    // Track failures over 60s window
    volumeThreshold: 5,    // Minimum calls before circuit can open
  };
  ```
- Export `createCircuitBreaker<T>(fn: (...args: any[]) => Promise<T>, options?: Partial<typeof DEFAULT_BREAKER_OPTIONS>)`:
  - Creates a new CircuitBreaker wrapping `fn`
  - Merges custom options with defaults
  - Adds event listeners for state changes (open, halfOpen, close) that log to console.warn/console.log
  - Returns the breaker instance
- Export `withCircuitBreaker<TArgs extends any[], TResult>(fn: (...args: TArgs) => Promise<TResult>, options?: { name?: string } & Partial<typeof DEFAULT_BREAKER_OPTIONS>)`:
  - Higher-order function that wraps fn with a circuit breaker
  - Returns a function with same signature that calls `breaker.fire(...args)`
  - Adds fallback that returns `{ error: 'Service temporarily unavailable', circuitOpen: true }` when circuit is open

Create `src/lib/enrichment/contactout.ts`:
- Export async function `enrichContactOut(params: { email?: string; linkedinUrl?: string }): Promise<ContactOutResult>`
- Define `ContactOutResult` type: `{ found: boolean; personalEmail?: string; phone?: string; error?: string }`
- Implementation:
  - POST to `https://api.contactout.com/v1/people/enrich` (or similar — check ContactOut docs)
  - Headers: `Content-Type: application/json`, `token: process.env.CONTACTOUT_API_KEY`
  - Body: { email, linkedin_url }
  - Handle 404 as "not found" (return { found: false })
  - Handle 429 with error message including Retry-After header
  - Parse response for personal_email and phone fields
- Wrap with `withCircuitBreaker` with name "contactout"
- Export the wrapped function as `enrichContactOut`
  </action>
  <verify>
`src/lib/circuit-breaker.ts` exports `createCircuitBreaker` and `withCircuitBreaker`.
`src/lib/enrichment/contactout.ts` exports `enrichContactOut`.
`pnpm build` passes.
  </verify>
  <done>
Circuit breaker factory is reusable. ContactOut client handles enrichment, 404s, rate limits, and circuit breaker protection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Exa.ai and SEC EDGAR enrichment clients</name>
  <files>
    src/lib/enrichment/exa.ts
    src/lib/enrichment/edgar.ts
  </files>
  <action>
Create `src/lib/enrichment/exa.ts`:
- Export async function `enrichExa(params: { name: string; company: string; title?: string }): Promise<ExaResult>`
- Define `ExaResult` type:
  ```typescript
  {
    found: boolean;
    mentions: Array<{ title: string; url: string; snippet: string; publishDate?: string }>;
    wealthSignals: Array<{ type: string; description: string; source: string }>;
    error?: string;
  }
  ```
- Implementation:
  - POST to `https://api.exa.ai/search` with:
    - `query`: `"${name}" "${company}" executive OR founder OR investor`
    - `type`: "auto"
    - `numResults`: 5
    - `contents`: { text: { maxCharacters: 500 } }
  - Headers: `x-api-key: process.env.EXA_API_KEY`, `Content-Type: application/json`
  - Parse results: extract title, url, snippet from each result
  - Look for wealth signals in snippets: keywords like "funding", "acquisition", "IPO", "exit", "billion", "million", "net worth", "board"
  - Return structured ExaResult
- Wrap with `withCircuitBreaker` with name "exa", timeout 15000 (Exa can be slow)

Create `src/lib/enrichment/edgar.ts`:
- Export async function `enrichEdgar(params: { cik: string; name: string }): Promise<EdgarResult>`
- Define `EdgarResult` type:
  ```typescript
  {
    found: boolean;
    transactions: Array<{
      filingDate: string;
      transactionType: string;
      securityTitle: string;
      shares: number;
      pricePerShare: number;
      totalValue: number;
    }>;
    error?: string;
  }
  ```
- Implementation:
  - GET `https://data.sec.gov/submissions/CIK${cik.padStart(10, '0')}.json`
  - Headers: `User-Agent: process.env.SEC_EDGAR_USER_AGENT` (REQUIRED by SEC), `Accept: application/json`
  - **SEC rate limit: 10 requests per second** — add a 150ms delay before each request to stay safely under
  - Parse `data.filings.recent` — filter for `form === "4"` entries
  - Extract filingDate, accessionNumber from matching entries
  - For each Form 4 (up to 10 most recent), fetch the XML document at `https://www.sec.gov/Archives/edgar/data/${cik}/${accessionNumber}/${primaryDocument}`
  - Parse XML for transaction details (transactionType, securityTitle, shares, pricePerShare)
  - Calculate totalValue = shares * pricePerShare
  - Return up to 30 transactions, sorted by filingDate DESC
  - Handle case where company is not public (CIK not found) — return { found: false }
- Wrap with `withCircuitBreaker` with name "sec-edgar", timeout 15000, resetTimeout 60000

**Important for SEC EDGAR:**
- User-Agent header is mandatory — SEC blocks requests without it
- Implement basic XML parsing (use regex or DOMParser for the Form 4 XML — don't add a heavy XML library)
- If XML parsing is too complex, start with just the filing list (dates and accession numbers) and mark as "simplified" — full XML parsing can be enhanced later
  </action>
  <verify>
`src/lib/enrichment/exa.ts` exports `enrichExa`.
`src/lib/enrichment/edgar.ts` exports `enrichEdgar`.
Both use `withCircuitBreaker`.
`pnpm build` passes.
  </verify>
  <done>
Exa.ai client searches for web presence and extracts wealth signals. SEC EDGAR client fetches Form 4 insider transactions with XML parsing. Both have circuit breaker protection. All three enrichment clients (ContactOut, Exa, EDGAR) are ready for the Inngest workflow.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes
2. All three enrichment clients export their main function
3. Circuit breaker factory is used by all three clients
4. SEC EDGAR includes User-Agent header
5. Error handling returns structured error objects (never throws to caller when circuit is open)
</verification>

<success_criteria>
Three enrichment API clients are built and circuit-breaker protected. Each handles rate limits, errors, and not-found cases gracefully. They are ready to be consumed by the Inngest enrichment workflow in Plan 04.
</success_criteria>

<output>
After completion, create `.planning/phases/03-enrich-ship/03-03-SUMMARY.md`
</output>
