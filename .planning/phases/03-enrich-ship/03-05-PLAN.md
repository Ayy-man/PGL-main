---
phase: 03-enrich-ship
plan: 05
type: execute
wave: 2
depends_on: ["03-02"]
files_modified:
  - src/app/api/export/csv/route.ts
  - src/lib/csv-export.ts
autonomous: true

must_haves:
  truths:
    - "User can export a list to CSV with all enriched data columns"
    - "CSV export streams data in batches to prevent OOM on 1000+ prospects"
    - "CSV file includes UTF-8 BOM for Excel compatibility"
    - "Export triggers activity log entry with csv_exported action type"
  artifacts:
    - path: "src/app/api/export/csv/route.ts"
      provides: "Streaming CSV export endpoint"
      exports: ["GET"]
    - path: "src/lib/csv-export.ts"
      provides: "CSV column definitions and formatting helpers"
      exports: ["CSV_COLUMNS", "formatProspectRow"]
  key_links:
    - from: "src/app/api/export/csv/route.ts"
      to: "src/lib/csv-export.ts"
      via: "imports column definitions and formatters"
      pattern: "CSV_COLUMNS|formatProspectRow"
    - from: "src/app/api/export/csv/route.ts"
      to: "src/lib/activity-logger.ts"
      via: "logs csv_exported activity"
      pattern: "logActivity.*csv_exported"
---

<objective>
Build the streaming CSV export system for list data, covering EXP-01 through EXP-04.

Purpose: Users need to export prospect lists to CSV for import into their CRM tools (Monday.com, HubSpot). The export must handle 1000+ prospects without OOM by streaming, and include UTF-8 BOM for Excel compatibility with international names.

Output: Streaming CSV export API endpoint and column formatting helpers.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-enrich-ship/03-RESEARCH.md
@.planning/phases/03-enrich-ship/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV column definitions and formatting helpers</name>
  <files>src/lib/csv-export.ts</files>
  <action>
Install csv-stringify:
```bash
pnpm add csv-stringify
```

Create `src/lib/csv-export.ts`:

1. Define and export `CSV_COLUMNS` array of column definitions:
   ```typescript
   export const CSV_COLUMNS = [
     { key: 'name', header: 'Name' },
     { key: 'title', header: 'Title' },
     { key: 'company', header: 'Company' },
     { key: 'location', header: 'Location' },
     { key: 'workEmail', header: 'Work Email' },
     { key: 'workPhone', header: 'Work Phone' },
     { key: 'personalEmail', header: 'Personal Email' },
     { key: 'phone', header: 'Personal Phone' },
     { key: 'linkedinUrl', header: 'LinkedIn URL' },
     { key: 'wealthSignals', header: 'Wealth Signals' },
     { key: 'insiderTrades', header: 'Insider Trades (Count)' },
     { key: 'aiSummary', header: 'AI Summary' },
     { key: 'listStatus', header: 'List Status' },
     { key: 'notes', header: 'Notes' },
   ] as const;
   ```

2. Export `formatProspectRow(prospect: any, listMember: any): Record<string, string>`:
   - Maps raw prospect + list_member data to CSV-friendly flat object
   - Extract personalEmail and phone from prospect.contact_data JSONB
   - Format wealth signals from prospect.web_data JSONB as comma-separated string
   - Count insider trades from prospect.insider_data JSONB
   - Get list status and notes from list_member record
   - Handle null/undefined values — replace with empty string
   - Escape any newlines in text fields (replace \n with space)
  </action>
  <verify>
File exists at `src/lib/csv-export.ts`.
Exports CSV_COLUMNS (14 columns) and formatProspectRow.
All enrichment data columns are included.
`pnpm build` passes.
  </verify>
  <done>
CSV column definitions cover all enriched data fields. Row formatter handles JSONB extraction and null safety.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create streaming CSV export API endpoint</name>
  <files>src/app/api/export/csv/route.ts</files>
  <action>
Create `src/app/api/export/csv/route.ts`:

1. Export async GET handler:
   - Validate user session (reject 401 if unauthenticated)
   - Extract `listId` from query params (required — return 400 if missing)
   - Extract tenant_id from user session
   - Verify user has access to the list (query lists table with RLS)
   - Return 404 if list not found

2. Create csv-stringify stringifier:
   ```typescript
   import { stringify } from 'csv-stringify';

   const stringifier = stringify({
     header: true,
     bom: true,  // UTF-8 BOM for Excel compatibility
     columns: CSV_COLUMNS,
   });
   ```

3. Build a ReadableStream that:
   - Fetches list members in batches of 100 from the database
   - Uses Supabase query: `list_members` joined with `prospects` where listId matches
   - For each batch:
     - Format each prospect with `formatProspectRow()`
     - Write each formatted row to the stringifier
   - After all batches processed, call `stringifier.end()`
   - Pipe stringifier output to the ReadableStream controller:
     - On 'readable' event: read chunks and enqueue to controller
     - On 'end' event: close controller

4. Return NextResponse with stream:
   ```typescript
   return new NextResponse(stream, {
     headers: {
       'Content-Type': 'text/csv; charset=utf-8',
       'Content-Disposition': `attachment; filename="prospects-${listId}-${Date.now()}.csv"`,
       'Cache-Control': 'no-cache',
     },
   });
   ```

5. After starting the stream, call `logActivity()` with:
   - actionType: 'csv_exported'
   - targetType: 'list'
   - targetId: listId
   - metadata: { listName, memberCount }

**Important:**
- Use the user's authenticated Supabase client for the database query (RLS enforced)
- Batch size of 100 keeps memory usage low
- The BOM (`bom: true`) is critical for Excel to recognize UTF-8 encoding
- Do NOT load all prospects into memory at once
  </action>
  <verify>
File exists at `src/app/api/export/csv/route.ts`.
GET handler is exported.
Uses `stringify` from csv-stringify with `bom: true`.
Streams data in batches of 100.
Calls logActivity with csv_exported.
`pnpm build` passes.
  </verify>
  <done>
CSV export endpoint streams prospect data with enriched columns. Handles 1000+ prospects without OOM via batched queries. Includes UTF-8 BOM for Excel. Logs export activity. Covers EXP-01 through EXP-04.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes
2. CSV export includes all 14 data columns
3. `bom: true` is set in stringify options
4. Data is fetched in batches (not all at once)
5. Activity log entry created for csv_exported
6. Response has correct Content-Type and Content-Disposition headers
</verification>

<success_criteria>
CSV export streams list data with all enriched columns. UTF-8 BOM ensures Excel compatibility. 1000+ prospects export without memory issues. Export activity is logged. Requirements EXP-01 through EXP-04 complete.
</success_criteria>

<output>
After completion, create `.planning/phases/03-enrich-ship/03-05-SUMMARY.md`
</output>
