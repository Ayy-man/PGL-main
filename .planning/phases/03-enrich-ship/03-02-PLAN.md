---
phase: 03-enrich-ship
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/activity-logger.ts
  - src/app/api/activity/route.ts
autonomous: true

must_haves:
  truths:
    - "Any server action can log an activity with a single function call"
    - "Activity log API returns filtered entries by action_type, date range, and user"
    - "Activity log entries include user_id, tenant_id, action_type, target, metadata, timestamp"
    - "Activity log is tenant-scoped via RLS"
  artifacts:
    - path: "src/lib/activity-logger.ts"
      provides: "Reusable activity logging helper"
      exports: ["logActivity", "ActionType"]
    - path: "src/app/api/activity/route.ts"
      provides: "Activity log query API with filters"
      exports: ["GET"]
  key_links:
    - from: "src/lib/activity-logger.ts"
      to: "supabase"
      via: "Supabase client insert into activity_log"
      pattern: "activity_log.*insert"
    - from: "src/app/api/activity/route.ts"
      to: "supabase"
      via: "Supabase client query activity_log with filters"
      pattern: "activity_log.*select"
---

<objective>
Create the activity logging helper function and activity log query API, covering ACT-01 through ACT-05.

Purpose: Activity logging is used by nearly every feature in Phase 3 (enrichment, export, lookalike, profile view). Building the helper first means all subsequent plans can call `logActivity()` without duplicating logging logic. The API endpoint powers the admin activity log view.

Output: A `logActivity()` helper that any server action can call, and a GET `/api/activity` endpoint with action_type, date range, and user filtering.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-enrich-ship/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create activity logging helper function</name>
  <files>src/lib/activity-logger.ts</files>
  <action>
Create `src/lib/activity-logger.ts`:

1. Define `ActionType` union type with all 11 action types:
   `'login' | 'search_executed' | 'profile_viewed' | 'profile_enriched' | 'add_to_list' | 'remove_from_list' | 'status_updated' | 'note_added' | 'csv_exported' | 'persona_created' | 'lookalike_search'`

2. Define `LogActivityParams` interface:
   ```typescript
   interface LogActivityParams {
     tenantId: string;
     userId: string;
     actionType: ActionType;
     targetType?: string; // 'prospect' | 'list' | 'persona' | null
     targetId?: string;
     metadata?: Record<string, unknown>;
     ipAddress?: string;
     userAgent?: string;
   }
   ```

3. Export async function `logActivity(params: LogActivityParams)`:
   - Creates a Supabase admin/service client (server-side)
   - Inserts into `activity_log` table with all provided fields
   - Uses `try/catch` — log errors to console but do NOT throw (activity logging should never break the calling action)
   - Return the inserted row on success, null on failure

4. Export the ActionType type and a `ACTION_TYPES` const array for validation.

**Important design decision:** This function uses the service role client to bypass RLS for writes (since it's called from server actions that already validated the user). The API query endpoint uses the user's session client which respects RLS for reads.

**Do NOT use the anon key here.** The activity logger runs server-side and writes on behalf of authenticated users. Use `createClient` from `@supabase/supabase-js` with the service role key from env.
  </action>
  <verify>
File exists at `src/lib/activity-logger.ts`.
Exports: `logActivity`, `ActionType`, `ACTION_TYPES`.
All 11 action types are defined.
Function does NOT throw — uses try/catch with console.error.
  </verify>
  <done>
`logActivity()` is callable from any server action with a single function call. All 11 action types are defined. Errors are caught and logged without breaking callers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create activity log query API endpoint</name>
  <files>src/app/api/activity/route.ts</files>
  <action>
Create `src/app/api/activity/route.ts`:

1. Export async GET handler that:
   - Validates user session via Supabase auth (reject 401 if not authenticated)
   - Extracts query params: `action_type` (optional, comma-separated), `start_date` (optional ISO string), `end_date` (optional ISO string), `user_id` (optional), `page` (optional, default 1), `limit` (optional, default 50, max 100)
   - Builds Supabase query on `activity_log` table:
     - RLS handles tenant scoping automatically (using user's session client)
     - Filter by action_type if provided (supports multiple: `action_type=login,search_executed`)
     - Filter by date range if provided: `created_at >= start_date AND created_at <= end_date`
     - Filter by user_id if provided
     - Order by `created_at DESC`
     - Paginate with `.range(offset, offset + limit - 1)`
   - Returns JSON: `{ data: ActivityLogEntry[], total: number, page: number, limit: number }`

2. Validate action_type values against the `ACTION_TYPES` array from activity-logger.ts — return 400 if invalid action type provided.

3. Date validation: If start_date or end_date provided, validate they are valid ISO date strings. Return 400 on invalid dates.

4. Role check: Only tenant_admin and super_admin roles can access this endpoint. Return 403 for agent/assistant roles. Check user role from the users table or session metadata.

**Important:** Use the user's authenticated Supabase client (not service role) so RLS automatically scopes results to the user's tenant.
  </action>
  <verify>
File exists at `src/app/api/activity/route.ts`.
GET handler is exported.
Query supports filtering by action_type (comma-separated), date range, user_id.
Pagination is implemented.
Role check restricts to tenant_admin and super_admin.
RLS-scoped query uses user's session client.
  </verify>
  <done>
Activity log API at /api/activity returns filtered, paginated activity entries. Supports action_type, date range, and user filtering. Tenant-scoped via RLS. Access restricted to admin roles.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes
2. `logActivity()` can be imported from `@/lib/activity-logger`
3. Activity API endpoint handles all filter combinations
4. Invalid action_type returns 400
5. Non-admin roles get 403
</verification>

<success_criteria>
Activity logging helper is importable and callable from any server action. Activity log API supports querying with filters. Both handle errors gracefully. Requirements ACT-01 through ACT-05 are covered.
</success_criteria>

<output>
After completion, create `.planning/phases/03-enrich-ship/03-02-SUMMARY.md`
</output>
