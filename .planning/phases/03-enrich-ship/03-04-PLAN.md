---
phase: 03-enrich-ship
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-02", "03-03"]
files_modified:
  - src/lib/enrichment/claude.ts
  - src/inngest/functions/enrich-prospect.ts
  - src/app/api/inngest/route.ts
autonomous: false
user_setup:
  - service: anthropic
    why: "AI summaries and lookalike persona generation"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys -> Create Key"

must_haves:
  truths:
    - "Inngest enrichment workflow triggers ContactOut, Exa, SEC EDGAR, and Claude sequentially with per-step retries"
    - "Each enrichment step is independent — if ContactOut fails, Exa/SEC/Claude still run"
    - "Claude generates a 2-3 sentence 'Why Recommended' summary from enriched data"
    - "Enrichment status is tracked per data source in the prospects table"
    - "Enrichment function is registered in the Inngest serve endpoint"
    - "Activity log entry is created for profile_enriched action"
  artifacts:
    - path: "src/lib/enrichment/claude.ts"
      provides: "Claude AI summary generation"
      exports: ["generateProspectSummary"]
    - path: "src/inngest/functions/enrich-prospect.ts"
      provides: "Multi-step enrichment workflow"
      exports: ["enrichProspect"]
    - path: "src/app/api/inngest/route.ts"
      provides: "Updated serve endpoint with enrichment function"
      exports: ["GET", "POST", "PUT"]
  key_links:
    - from: "src/inngest/functions/enrich-prospect.ts"
      to: "src/lib/enrichment/contactout.ts"
      via: "step.run calls enrichContactOut"
      pattern: "enrichContactOut"
    - from: "src/inngest/functions/enrich-prospect.ts"
      to: "src/lib/enrichment/exa.ts"
      via: "step.run calls enrichExa"
      pattern: "enrichExa"
    - from: "src/inngest/functions/enrich-prospect.ts"
      to: "src/lib/enrichment/edgar.ts"
      via: "step.run calls enrichEdgar"
      pattern: "enrichEdgar"
    - from: "src/inngest/functions/enrich-prospect.ts"
      to: "src/lib/enrichment/claude.ts"
      via: "step.run calls generateProspectSummary"
      pattern: "generateProspectSummary"
    - from: "src/inngest/functions/enrich-prospect.ts"
      to: "src/lib/activity-logger.ts"
      via: "logActivity for profile_enriched"
      pattern: "logActivity"
    - from: "src/app/api/inngest/route.ts"
      to: "src/inngest/functions/enrich-prospect.ts"
      via: "registered in serve functions array"
      pattern: "enrichProspect"
---

<objective>
Build the Claude AI summary client and the Inngest multi-step enrichment workflow that orchestrates all four data sources.

Purpose: This is the core enrichment pipeline — when a user views a prospect profile, this Inngest function is triggered to enrich data from ContactOut, Exa, SEC EDGAR, and Claude. Per-step retries ensure independent failure handling. This covers PROF-02 through PROF-08 and INFRA-02.

Output: Working Inngest enrichment function that orchestrates all data sources, Claude AI summary generator, and updated serve endpoint.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-enrich-ship/03-RESEARCH.md
@.planning/phases/03-enrich-ship/03-01-SUMMARY.md
@.planning/phases/03-enrich-ship/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Claude AI summary client</name>
  <files>src/lib/enrichment/claude.ts</files>
  <action>
Install Anthropic SDK:
```bash
pnpm add @anthropic-ai/sdk
```

Create `src/lib/enrichment/claude.ts`:

1. Import Anthropic from "@anthropic-ai/sdk"

2. Export async function `generateProspectSummary(params: ProspectSummaryInput): Promise<string>`:
   - Define `ProspectSummaryInput`:
     ```typescript
     interface ProspectSummaryInput {
       name: string;
       title: string;
       company: string;
       contactData?: { personalEmail?: string; phone?: string } | null;
       webData?: { mentions: Array<{ title: string; snippet: string }>; wealthSignals: Array<{ type: string; description: string }> } | null;
       insiderData?: { transactions: Array<{ filingDate: string; transactionType: string; shares: number; totalValue: number }> } | null;
     }
     ```
   - Create Anthropic client: `new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY })`
   - Use model: `"claude-haiku-4-5-20250514"` (cost-efficient for high-volume summaries)
   - max_tokens: 500
   - System prompt: "You are a luxury real estate prospect analyst. Generate concise 2-3 sentence summaries explaining why a prospect is a qualified UHNWI buyer. Focus on wealth signals, lifestyle indicators, and buying potential. Be specific — reference actual data points."
   - User message: Build from enriched data — include name, title, company, wealth signals (SEC transactions, Exa mentions), contact availability
   - If enrichment data is sparse (no web_data AND no insider_data), return "Insufficient enrichment data for AI summary. Enrich this prospect's profile for a detailed recommendation."
   - Parse response: extract text content from response.content[0]
   - Return the summary string

3. Handle errors:
   - If Anthropic API returns error, log and return fallback: "AI summary temporarily unavailable."
   - Do NOT wrap with circuit breaker (Claude is the final step — if it fails, the enrichment still saved the other data)

**Important:** Use claude-haiku-4-5 (not claude-3-haiku) as specified in research. Target <500 tokens per summary for cost efficiency.
  </action>
  <verify>
File exists at `src/lib/enrichment/claude.ts`.
Exports `generateProspectSummary`.
Uses claude-haiku-4-5 model.
Has fallback for sparse data and API errors.
`pnpm build` passes.
  </verify>
  <done>
Claude AI summary generator creates 2-3 sentence prospect recommendations from enriched data. Handles sparse data with informative fallback. Cost-efficient with Haiku model and 500 token limit.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Inngest enrichment workflow and register in serve endpoint</name>
  <files>
    src/inngest/functions/enrich-prospect.ts
    src/app/api/inngest/route.ts
  </files>
  <action>
Create `src/inngest/functions/enrich-prospect.ts`:

1. Import: inngest client, all enrichment clients (enrichContactOut, enrichExa, enrichEdgar, generateProspectSummary), logActivity, Supabase admin client

2. Export `enrichProspect` as an Inngest function:
   ```typescript
   export const enrichProspect = inngest.createFunction(
     {
       id: "enrich-prospect",
       retries: 3,
       concurrency: [{ limit: 5 }], // Max 5 concurrent enrichments
     },
     { event: "prospect/enrich.requested" },
     async ({ event, step }) => { ... }
   );
   ```

3. Function body — sequential steps with per-step independence:

   **Step 1: "mark-in-progress"** — Update prospect enrichment_status to 'in_progress' and enrichment_source_status to show all sources as 'pending'

   **Step 2: "fetch-contactout"** — Call `enrichContactOut({ email, linkedinUrl })`. On success, update prospect contact_data and set enrichment_source_status.contactout = 'complete'. On failure, set enrichment_source_status.contactout = 'failed'. Use try/catch — don't let failure stop workflow.

   **Step 3: "fetch-exa"** — Call `enrichExa({ name, company, title })`. On success, update prospect web_data and set enrichment_source_status.exa = 'complete'. On failure, set enrichment_source_status.exa = 'failed'.

   **Step 4: "fetch-edgar"** — Only if `isPublicCompany` is true. Call `enrichEdgar({ cik: companyCik, name })`. On success, update prospect insider_data and set enrichment_source_status.sec = 'complete'. On failure, set enrichment_source_status.sec = 'failed'. If not public company, set enrichment_source_status.sec = 'skipped'.

   **Step 5: "generate-summary"** — Call `generateProspectSummary()` with all collected data. Update prospect ai_summary.

   **Step 6: "finalize"** — Update prospect enrichment_status to 'complete', set last_enriched_at to NOW(). Call `logActivity({ tenantId, userId, actionType: 'profile_enriched', targetType: 'prospect', targetId: prospectId })`.

4. Add `onFailure` handler:
   - Update prospect enrichment_status to 'failed'
   - Log the error

**Important implementation notes:**
- Each step.run callback should handle its own errors with try/catch
- Store partial results even if later steps fail
- Update enrichment_source_status JSONB after each step (use Supabase .update())
- The event payload comes from the profile view page (Plan 07) when it detects missing/stale data

Update `src/app/api/inngest/route.ts`:
- Import `enrichProspect` from the functions directory
- Add it to the serve functions array: `functions: [enrichProspect]`
  </action>
  <verify>
`src/inngest/functions/enrich-prospect.ts` exports `enrichProspect`.
Function has 6 steps: mark-in-progress, fetch-contactout, fetch-exa, fetch-edgar, generate-summary, finalize.
Each step uses try/catch for independent failure handling.
`src/app/api/inngest/route.ts` includes `enrichProspect` in functions array.
`pnpm build` passes.
  </verify>
  <done>
Inngest enrichment workflow orchestrates all four data sources with per-step retries and independent failure handling. Enrichment status tracked per source. Activity logged on completion. Function registered in serve endpoint.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Claude AI summary client and Inngest 6-step enrichment workflow orchestrating ContactOut, Exa, SEC EDGAR, and Claude. This is a complex multi-API pipeline — verify before Plans 07/08 build on top of it.</what-built>
  <how-to-verify>
    1. Verify `pnpm build` passes cleanly
    2. Review `src/inngest/functions/enrich-prospect.ts` — confirm 6 steps exist with correct names
    3. Confirm each step has try/catch for independent failure handling
    4. Verify enrichment_source_status JSONB is updated after each step
    5. Check `src/app/api/inngest/route.ts` includes enrichProspect in serve functions
    6. Verify Claude client uses claude-haiku-4-5 model
    7. Optionally: Run Inngest dev server (`npx inngest-cli@latest dev`) and inspect registered functions
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm build` passes
2. enrichProspect function has all 6 steps
3. Claude uses Haiku model with 500 token limit
4. Each enrichment step handles errors independently
5. Serve endpoint includes enrichProspect in functions array
6. Activity log entry created for profile_enriched
</verification>

<success_criteria>
Complete enrichment pipeline: trigger event -> ContactOut -> Exa -> SEC EDGAR -> Claude summary -> save all data -> log activity. Per-step retries, independent failure handling, status tracking per source. Covers PROF-02 through PROF-08 and INFRA-02.
</success_criteria>

<output>
After completion, create `.planning/phases/03-enrich-ship/03-04-SUMMARY.md`
</output>
