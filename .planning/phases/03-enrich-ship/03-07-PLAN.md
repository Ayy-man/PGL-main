---
phase: 03-enrich-ship
plan: 07
type: execute
wave: 3
depends_on: ["03-04"]
files_modified:
  - src/app/[orgId]/prospects/[prospectId]/page.tsx
  - src/components/prospect/profile-view.tsx
  - src/components/prospect/enrichment-status.tsx
  - src/components/prospect/wealth-signals.tsx
  - src/app/api/prospects/[prospectId]/enrich/route.ts
autonomous: false

must_haves:
  truths:
    - "Clicking a prospect opens a profile view with consolidated data"
    - "Profile view triggers lazy enrichment if data is missing or stale (>7 days)"
    - "Enrichment status indicators show loading/complete/failed per data source"
    - "User can add prospect to a list directly from profile view"
    - "'Find Similar People' button is visible on profile view"
    - "Profile shows sections: Overview, Contact, Wealth Signals, AI Summary, Lists"
  artifacts:
    - path: "src/app/[orgId]/prospects/[prospectId]/page.tsx"
      provides: "Prospect profile page with server-side data loading"
      min_lines: 30
    - path: "src/components/prospect/profile-view.tsx"
      provides: "Main profile view component"
      min_lines: 50
    - path: "src/components/prospect/enrichment-status.tsx"
      provides: "Per-source enrichment status indicators"
      exports: ["EnrichmentStatus"]
    - path: "src/components/prospect/wealth-signals.tsx"
      provides: "Wealth signals display (SEC transactions, Exa mentions)"
      exports: ["WealthSignals"]
    - path: "src/app/api/prospects/[prospectId]/enrich/route.ts"
      provides: "Trigger enrichment endpoint"
      exports: ["POST"]
  key_links:
    - from: "src/app/[orgId]/prospects/[prospectId]/page.tsx"
      to: "src/components/prospect/profile-view.tsx"
      via: "renders ProfileView component"
      pattern: "ProfileView"
    - from: "src/app/api/prospects/[prospectId]/enrich/route.ts"
      to: "src/inngest/client.ts"
      via: "inngest.send prospect/enrich.requested event"
      pattern: "inngest\\.send"
    - from: "src/app/[orgId]/prospects/[prospectId]/page.tsx"
      to: "src/lib/activity-logger.ts"
      via: "logs profile_viewed activity"
      pattern: "logActivity.*profile_viewed"
    - from: "src/components/prospect/profile-view.tsx"
      to: "Phase 2 list member API"
      via: "POST /api/lists/[listId]/members to add prospect to list"
      pattern: "fetch.*api/lists.*members"
---

<objective>
Build the prospect profile view page with enrichment status indicators, lazy enrichment trigger, and quick actions (Add to List, Find Similar People).

Purpose: The profile view is the central UI for prospect intelligence. It displays all enriched data, triggers lazy enrichment when data is missing/stale, and provides quick actions. This covers PROF-01, PROF-07, PROF-09, PROF-10.

Output: Prospect profile page with data sections, enrichment status indicators, and enrichment trigger endpoint.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-enrich-ship/03-RESEARCH.md
@.planning/phases/03-enrich-ship/03-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create enrichment trigger endpoint and profile page</name>
  <files>
    src/app/api/prospects/[prospectId]/enrich/route.ts
    src/app/[orgId]/prospects/[prospectId]/page.tsx
  </files>
  <action>
Create `src/app/api/prospects/[prospectId]/enrich/route.ts`:

1. Export async POST handler:
   - Validate user session (401 if not authenticated)
   - Extract prospectId from route params
   - Extract tenant_id from session
   - Fetch prospect from database (verify it exists and belongs to tenant)
   - Check staleness: if `last_enriched_at` is within 7 days AND enrichment_status is 'complete', return 200 with message "Already enriched, not stale"
   - Check if already in progress: if enrichment_status is 'in_progress', return 200 with message "Enrichment already in progress"
   - Send Inngest event:
     ```typescript
     await inngest.send({
       name: "prospect/enrich.requested",
       data: {
         prospectId,
         tenantId,
         userId: session.user.id,
         email: prospect.email,
         linkedinUrl: prospect.linkedin_url,
         name: prospect.name,
         company: prospect.company,
         title: prospect.title,
         isPublicCompany: !!prospect.publicly_traded_symbol,
         companyCik: prospect.company_cik,
       },
     });
     ```
   - Return 202 Accepted with `{ status: 'enrichment_started' }`

Create `src/app/[orgId]/prospects/[prospectId]/page.tsx`:

1. Server component page:
   - Extract orgId and prospectId from params
   - Validate user session
   - Fetch prospect data from Supabase (with RLS)
   - If prospect not found, return notFound()
   - Log activity: `logActivity({ actionType: 'profile_viewed', targetType: 'prospect', targetId: prospectId })`
   - Check if enrichment needed (missing data or stale >7 days)
   - If enrichment needed, trigger via fetch to the enrich endpoint (fire-and-forget)
   - Fetch list memberships for this prospect (which lists it belongs to)
   - Render ProfileView component with prospect data

2. Pass to ProfileView:
   - prospect (all fields including enrichment data)
   - enrichmentSourceStatus (JSONB parsed)
   - listMemberships (array of { listId, listName, status })
   - isStale (boolean — whether enrichment data is >7 days old)
  </action>
  <verify>
Enrich endpoint exports POST handler.
Staleness check uses 7-day threshold.
Inngest event is sent with correct payload.
Profile page logs profile_viewed activity.
Page fetches prospect data with RLS.
`pnpm build` passes.
  </verify>
  <done>
Enrichment trigger endpoint sends Inngest event when data is missing or stale. Profile page loads prospect data, logs view activity, and triggers enrichment as needed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create profile view UI components</name>
  <files>
    src/components/prospect/profile-view.tsx
    src/components/prospect/enrichment-status.tsx
    src/components/prospect/wealth-signals.tsx
  </files>
  <action>
Create `src/components/prospect/enrichment-status.tsx`:
- "use client" component
- Props: `{ sourceStatus: Record<string, 'pending' | 'in_progress' | 'complete' | 'failed' | 'skipped'> }`
- Renders a row of status indicators for each enrichment source:
  - ContactOut: personal contact info
  - Exa: web presence & wealth signals
  - SEC EDGAR: insider transactions
  - Claude: AI summary
- Each indicator shows:
  - `pending`: gray dot + "Pending"
  - `in_progress`: spinning loader + "Enriching..."
  - `complete`: green checkmark + "Complete"
  - `failed`: red X + "Failed"
  - `skipped`: gray dash + "Skipped" (e.g., SEC for non-public companies)
- Use dark theme styling: bg-zinc-900 border-zinc-800, gold accent for complete state
- Include a "Refresh Enrichment" button that calls POST /api/prospects/[id]/enrich

Create `src/components/prospect/wealth-signals.tsx`:
- "use client" component
- Props: `{ webData?: ExaResult; insiderData?: EdgarResult }`
- Displays wealth signals section:
  - **Web Mentions:** List of Exa results with title, snippet, URL, date
  - **Insider Transactions:** Table of SEC Form 4 transactions (date, type, shares, value)
  - If no data: "No wealth signals found" with muted styling
- Format transaction values with currency formatting ($1,234,567)
- Use dark theme: zinc-900 backgrounds, zinc-300 text, gold for notable values

Create `src/components/prospect/profile-view.tsx`:
- "use client" component
- Props: `{ prospect, enrichmentSourceStatus, listMemberships, isStale }`
- Layout with sections (vertical stack):

  **1. Header:** Name (Playfair Display, large), Title @ Company, Location
  - Quick action buttons (right side): "Add to List", "Find Similar People", "Export Profile"
  - If isStale: show "Data may be outdated" badge

  **2. Enrichment Status Bar:** `<EnrichmentStatus sourceStatus={enrichmentSourceStatus} />`

  **3. Contact Section:** Two columns
  - Work: email, phone (from Apollo)
  - Personal: email, phone (from ContactOut enrichment)
  - Show "Not enriched" if contact_data is null

  **4. AI Summary Section:** "Why Recommended"
  - Display ai_summary in a highlighted card with gold border
  - If no summary: "AI summary will be generated after enrichment"

  **5. Wealth Signals Section:** `<WealthSignals webData={...} insiderData={...} />`

  **6. Lists Section:** Table of list memberships
  - Columns: List Name, Status, Added Date
  - Each row links to the list detail page

- Dark theme throughout: bg-zinc-950 page background, zinc-900 cards, zinc-800 borders
- Gold accents: #f4d47f for important text, #d4af37 for icons/borders
- Playfair Display for section headings, Inter for body

- "Add to List" button: Opens a dropdown/modal with available lists (fetch from API).
  - On select: POST to `/api/lists/[listId]/members` with `{ prospectId }` — this uses the **existing Phase 2 list member endpoint** which already handles adding prospects to lists and logging activity.
  - No new API needed — Phase 2 provides the list management APIs including member add/remove.

- "Find Similar People" button: Navigates to or triggers lookalike flow (Plan 08)
  - For now, just link/button stub that will be wired in Plan 08
  </action>
  <verify>
All three component files exist.
ProfileView has 6 sections: header, enrichment status, contact, AI summary, wealth signals, lists.
EnrichmentStatus handles all 5 states (pending, in_progress, complete, failed, skipped).
WealthSignals displays Exa mentions and SEC transactions.
"Add to List" calls POST /api/lists/[listId]/members (existing Phase 2 endpoint).
Dark theme with gold accents applied.
`pnpm build` passes.
  </verify>
  <done>
Profile view displays consolidated prospect data with enrichment status indicators, contact info, AI summary, wealth signals, and list memberships. Quick actions for Add to List (using Phase 2 list member API) and Find Similar People. Dark theme with gold accents.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Prospect profile view with enrichment status indicators, contact sections, wealth signals, AI summary, and quick actions. Lazy enrichment trigger on profile view.</what-built>
  <how-to-verify>
    1. Navigate to a prospect profile page
    2. Verify sections render: Overview, Contact, Wealth Signals, AI Summary, Lists
    3. Check enrichment status indicators show correct states
    4. Verify dark theme with gold accents applied
    5. Check "Add to List" and "Find Similar People" buttons are visible
    6. Verify "Refresh Enrichment" button is present
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm build` passes
2. Profile page loads prospect data with RLS
3. Enrichment trigger sends Inngest event
4. Status indicators show all 5 states
5. Dark theme with gold accents
6. Quick actions visible
7. "Add to List" uses existing Phase 2 list member endpoint
</verification>

<success_criteria>
Prospect profile view is the central intelligence hub. Shows all enriched data with status indicators. Triggers lazy enrichment for missing/stale data. Quick actions for list management (via Phase 2 API) and lookalike discovery. Covers PROF-01, PROF-07, PROF-09, PROF-10.
</success_criteria>

<output>
After completion, create `.planning/phases/03-enrich-ship/03-07-SUMMARY.md`
</output>
