---
phase: 03-enrich-ship
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/inngest/client.ts
  - src/inngest/types.ts
  - src/app/api/inngest/route.ts
  - supabase/migrations/20260208_phase3_schema.sql
autonomous: true
user_setup:
  - service: inngest
    why: "Background job orchestration for enrichment workflows"
    env_vars:
      - name: INNGEST_EVENT_KEY
        source: "Inngest Dashboard -> Manage -> Event Keys -> Create Event Key"
      - name: INNGEST_SIGNING_KEY
        source: "Inngest Dashboard -> Manage -> Signing Keys"
    dashboard_config:
      - task: "Create Inngest account and app"
        location: "https://app.inngest.com -> Create App"

must_haves:
  truths:
    - "Inngest serve endpoint responds to GET/POST/PUT at /api/inngest"
    - "activity_log table exists with RLS, partitioning, and BRIN indexes"
    - "usage_metrics_daily table exists with unique constraint on (date, tenant_id, user_id)"
    - "prospects table has enrichment columns (enrichment_status, last_enriched_at, contact_data, web_data, insider_data, ai_summary)"
  artifacts:
    - path: "src/inngest/client.ts"
      provides: "Inngest client instance"
      exports: ["inngest"]
    - path: "src/inngest/types.ts"
      provides: "Inngest event type definitions"
      exports: ["Events"]
    - path: "src/app/api/inngest/route.ts"
      provides: "Inngest serve endpoint"
      exports: ["GET", "POST", "PUT"]
    - path: "supabase/migrations/20260208_phase3_schema.sql"
      provides: "Phase 3 database tables and indexes"
      contains: "activity_log"
  key_links:
    - from: "src/app/api/inngest/route.ts"
      to: "src/inngest/client.ts"
      via: "import inngest client"
      pattern: "import.*inngest.*client"
---

<objective>
Set up Inngest infrastructure and Phase 3 database schema for enrichment workflows, activity logging, and usage metrics.

Purpose: Inngest is the foundation for all background jobs in Phase 3 (enrichment, daily metrics aggregation). The database schema additions support activity logging, usage metrics, and enrichment data storage. Everything else in Phase 3 depends on this.

Output: Working Inngest serve endpoint, typed event definitions, and Phase 3 database tables with RLS and indexes.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-enrich-ship/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Inngest client, event types, and serve endpoint</name>
  <files>
    src/inngest/client.ts
    src/inngest/types.ts
    src/app/api/inngest/route.ts
  </files>
  <action>
Install inngest:
```bash
pnpm add inngest
```

Create `src/inngest/client.ts`:
- Import Inngest from "inngest"
- Create and export `inngest` client with id: "phronesis" (or app name)
- Type the client with the Events type from types.ts

Create `src/inngest/types.ts`:
- Define event types for Phase 3:
  - `prospect/enrich.requested` — payload: { prospectId: string, tenantId: string, userId: string, email?: string, linkedinUrl?: string, name: string, company: string, title: string, isPublicCompany: boolean, companyCik?: string }
  - `metrics/aggregate.daily` — payload: { date: string } (for scheduled cron)
- Export the Events type map for Inngest client typing

Create `src/app/api/inngest/route.ts`:
- Import `serve` from "inngest/next"
- Import `inngest` client
- Export GET, POST, PUT using serve({ client: inngest, functions: [] })
- Functions array will be empty initially — enrichment functions added in Plan 04
- This endpoint is required for Inngest to discover and invoke functions

Do NOT add any Inngest functions yet (those come in Plans 04 and 06). The serve endpoint just needs to be wired up and ready to accept function registrations.
  </action>
  <verify>
Run `pnpm build` — no TypeScript errors.
Verify `src/inngest/client.ts`, `src/inngest/types.ts`, and `src/app/api/inngest/route.ts` exist.
Check that GET, POST, PUT are exported from the route.
  </verify>
  <done>
Inngest client is typed with event definitions. Serve endpoint exports GET/POST/PUT. Build passes without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Phase 3 database schema migration</name>
  <files>
    supabase/migrations/20260208_phase3_schema.sql
  </files>
  <action>
Create `supabase/migrations/20260208_phase3_schema.sql` with:

**1. activity_log table (partitioned by created_at):**
```sql
CREATE TABLE IF NOT EXISTS activity_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id),
  user_id UUID NOT NULL REFERENCES users(id),
  action_type TEXT NOT NULL CHECK (action_type IN (
    'login', 'search_executed', 'profile_viewed', 'profile_enriched',
    'add_to_list', 'remove_from_list', 'status_updated', 'note_added',
    'csv_exported', 'persona_created', 'lookalike_search'
  )),
  target_type TEXT,
  target_id UUID,
  metadata JSONB DEFAULT '{}',
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
) PARTITION BY RANGE (created_at);
```

Create initial monthly partitions for 2026-02 through 2026-06 (covers project timeline).
Add BRIN index on created_at per partition.
Add B-tree composite index on (tenant_id, action_type, created_at DESC) per partition.
Add B-tree index on (user_id, created_at DESC) per partition.
Add GIN index on metadata per partition.

Enable RLS on activity_log:
```sql
ALTER TABLE activity_log ENABLE ROW LEVEL SECURITY;
CREATE POLICY activity_log_tenant_isolation ON activity_log
  FOR ALL USING (tenant_id = (current_setting('app.current_tenant_id', true))::UUID);
```

**2. usage_metrics_daily table:**
```sql
CREATE TABLE IF NOT EXISTS usage_metrics_daily (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  date DATE NOT NULL,
  tenant_id UUID NOT NULL REFERENCES tenants(id),
  user_id UUID NOT NULL REFERENCES users(id),
  total_logins INTEGER DEFAULT 0,
  searches_executed INTEGER DEFAULT 0,
  profiles_viewed INTEGER DEFAULT 0,
  profiles_enriched INTEGER DEFAULT 0,
  csv_exports INTEGER DEFAULT 0,
  lists_created INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE (date, tenant_id, user_id)
);
```

Add indexes: B-tree on (tenant_id, date DESC), B-tree on (date DESC).
Enable RLS with tenant isolation policy.

**3. Enrichment columns on prospects table (ALTER TABLE):**
Add columns if they don't exist:
- `enrichment_status TEXT DEFAULT 'pending' CHECK (enrichment_status IN ('pending', 'in_progress', 'complete', 'failed'))`
- `last_enriched_at TIMESTAMPTZ`
- `contact_data JSONB` (ContactOut results: personal_email, phone)
- `web_data JSONB` (Exa results: mentions, wealth_signals)
- `insider_data JSONB` (SEC EDGAR Form 4 transactions)
- `ai_summary TEXT`
- `enrichment_source_status JSONB DEFAULT '{}'` (per-source status: { contactout: 'complete', exa: 'pending', sec: 'failed', claude: 'pending' })

Note: If the prospects table doesn't exist yet (Phase 2 dependency), create it with these columns plus the basic Apollo fields (name, title, company, email, phone, linkedin_url, location, tenant_id). Check if it exists first with `IF NOT EXISTS`.

**Important:** Use `current_setting('app.current_tenant_id', true)` with the `true` parameter for missing_ok to prevent errors when the setting hasn't been set.
  </action>
  <verify>
File exists at `supabase/migrations/20260208_phase3_schema.sql`.
SQL is valid — check for syntax errors by reading the file.
Verify: activity_log has PARTITION BY RANGE, RLS enabled, all 11 action types in CHECK constraint.
Verify: usage_metrics_daily has UNIQUE constraint on (date, tenant_id, user_id).
Verify: prospects table enrichment columns are added.
  </verify>
  <done>
Phase 3 database schema is defined with partitioned activity_log, usage_metrics_daily aggregation table, and enrichment columns on prospects. RLS policies and indexes are configured for all tables.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with no TypeScript errors
2. Inngest route file exports GET, POST, PUT
3. SQL migration file is syntactically valid
4. activity_log table definition includes all 11 action types
5. usage_metrics_daily has unique constraint
6. All tables have RLS policies
</verification>

<success_criteria>
Inngest infrastructure is ready to register functions. Database schema supports activity logging with partitioned tables, daily metrics aggregation, and prospect enrichment data storage. Build passes cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/03-enrich-ship/03-01-SUMMARY.md`
</output>
