---
phase: 03-enrich-ship
plan: 09
type: execute
wave: 4
depends_on: ["03-06", "03-07", "03-02"]
files_modified:
  - src/app/[orgId]/dashboard/analytics/page.tsx
  - src/app/[orgId]/dashboard/activity/page.tsx
  - src/app/admin/analytics/page.tsx
  - src/components/charts/usage-chart.tsx
  - src/components/charts/metrics-cards.tsx
  - src/components/charts/date-range-filter.tsx
  - src/components/activity/activity-log-viewer.tsx
autonomous: false

must_haves:
  truths:
    - "Tenant admin sees team usage metrics at /[orgId]/dashboard/analytics"
    - "Super admin sees cross-tenant metrics at /admin/analytics"
    - "Dashboard shows date range filter (7d, 30d, 90d)"
    - "Charts display daily trends for searches, profile views, enrichments"
    - "Summary cards show totals for the selected date range"
    - "Metrics include: logins, searches, profiles viewed, profiles enriched, CSV exports, lists created"
    - "Activity log is viewable by tenant admin at /[orgId]/dashboard/activity"
  artifacts:
    - path: "src/app/[orgId]/dashboard/analytics/page.tsx"
      provides: "Tenant admin analytics dashboard page"
      min_lines: 30
    - path: "src/app/[orgId]/dashboard/activity/page.tsx"
      provides: "Tenant admin activity log viewer page"
      min_lines: 30
    - path: "src/app/admin/analytics/page.tsx"
      provides: "Super admin analytics dashboard page"
      min_lines: 30
    - path: "src/components/charts/usage-chart.tsx"
      provides: "Line chart for daily usage trends"
      exports: ["UsageChart"]
    - path: "src/components/charts/metrics-cards.tsx"
      provides: "Summary metric cards"
      exports: ["MetricsCards"]
    - path: "src/components/charts/date-range-filter.tsx"
      provides: "Date range filter component"
      exports: ["DateRangeFilter"]
    - path: "src/components/activity/activity-log-viewer.tsx"
      provides: "Activity log table with filters"
      exports: ["ActivityLogViewer"]
  key_links:
    - from: "src/app/[orgId]/dashboard/analytics/page.tsx"
      to: "src/app/api/analytics/route.ts"
      via: "fetches analytics data"
      pattern: "fetch.*api/analytics"
    - from: "src/app/admin/analytics/page.tsx"
      to: "src/app/api/analytics/route.ts"
      via: "fetches cross-tenant analytics data"
      pattern: "fetch.*api/analytics"
    - from: "src/components/charts/usage-chart.tsx"
      to: "recharts"
      via: "renders LineChart from recharts"
      pattern: "LineChart.*recharts"
    - from: "src/app/[orgId]/dashboard/activity/page.tsx"
      to: "src/app/api/activity/route.ts"
      via: "fetches activity log entries from Plan 02 API"
      pattern: "fetch.*api/activity"
    - from: "src/components/activity/activity-log-viewer.tsx"
      to: "src/app/api/activity/route.ts"
      via: "queries paginated activity log with filters"
      pattern: "fetch.*api/activity"
---

<objective>
Build the usage metrics dashboards for tenant admins and super admins with Recharts charts and date range filtering, plus the activity log viewer page for tenant admins. Covers ANLY-02, ANLY-03, ANLY-05, ACT-03.

Purpose: Usage metrics dashboards are critical for 6-month renewal proof. Tenant admins see their team's activity. PGL super admins see cross-tenant aggregate metrics. The activity log viewer lets tenant admins browse all team activity. This is the UI layer for the analytics API (Plan 06) and activity log API (Plan 02).

Output: Two analytics dashboard pages (tenant admin + super admin) with line charts, summary cards, and date range filters. One activity log viewer page for tenant admins.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-enrich-ship/03-RESEARCH.md
@.planning/phases/03-enrich-ship/03-06-SUMMARY.md
@.planning/phases/03-enrich-ship/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chart components (UsageChart, MetricsCards, DateRangeFilter)</name>
  <files>
    src/components/charts/usage-chart.tsx
    src/components/charts/metrics-cards.tsx
    src/components/charts/date-range-filter.tsx
  </files>
  <action>
Install recharts:
```bash
pnpm add recharts
```

Create `src/components/charts/date-range-filter.tsx`:
- "use client" component
- Props: `{ selectedRange: '7d' | '30d' | '90d'; onRangeChange: (range: '7d' | '30d' | '90d') => void }`
- Renders 3 buttons: "7 Days", "30 Days", "90 Days"
- Active button has gold accent: bg-[#d4af37] text-black
- Inactive buttons: bg-zinc-800 text-zinc-400 hover:bg-zinc-700
- Compact layout (inline buttons with rounded corners)

Create `src/components/charts/metrics-cards.tsx`:
- "use client" component
- Props: `{ totals: { totalLogins: number; searchesExecuted: number; profilesViewed: number; profilesEnriched: number; csvExports: number; listsCreated: number } }`
- Renders a grid of 6 metric cards (3 cols on lg, 2 on md, 1 on sm)
- Each card shows:
  - Label (e.g., "Searches Executed")
  - Value (large number, Playfair Display font)
  - Icon (lucide-react): Search, Eye, Sparkles, Download, List, LogIn
- Card styling: bg-zinc-900 border-zinc-800 rounded-xl p-6
- Value color: #f4d47f (gold text) for emphasis

Create `src/components/charts/usage-chart.tsx`:
- "use client" component
- Props: `{ data: Array<{ date: string; searches: number; profileViews: number; enrichments: number; exports: number }> }`
- Uses Recharts LineChart with ResponsiveContainer:
  ```tsx
  import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from "recharts";
  ```
- Configure:
  - Width: 100%, Height: 400px
  - CartesianGrid: strokeDasharray="3 3", stroke="#27272a" (zinc-800)
  - XAxis: dataKey="date", tick formatter for short date, stroke="#a1a1aa" (zinc-400)
  - YAxis: stroke="#a1a1aa"
  - Tooltip: dark theme (bg-zinc-900, border-zinc-700, text-zinc-100)
  - Legend: bottom, text-zinc-400
  - Lines with distinct colors:
    - Searches: #d4af37 (gold)
    - Profile Views: #60a5fa (blue-400)
    - Enrichments: #34d399 (emerald-400)
    - Exports: #f472b6 (pink-400)
  - Line type: "monotone" with strokeWidth 2

**Dark theme is critical** â€” Recharts default styling is for light backgrounds. Override all text colors, grid colors, and tooltip backgrounds.
  </action>
  <verify>
All three component files exist.
UsageChart uses Recharts LineChart with dark theme styling.
MetricsCards shows 6 metric values in a grid.
DateRangeFilter has 3 range buttons with gold active state.
`pnpm build` passes.
  </verify>
  <done>
Chart components are built with dark theme styling. Line chart shows daily trends with color-coded metrics. Summary cards display totals. Date range filter toggles between 7d/30d/90d.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tenant admin and super admin analytics dashboard pages</name>
  <files>
    src/app/[orgId]/dashboard/analytics/page.tsx
    src/app/admin/analytics/page.tsx
  </files>
  <action>
Create `src/app/[orgId]/dashboard/analytics/page.tsx`:
- "use client" page (needs state for date range filter)
- Or: Server component with client wrapper for interactivity

1. State: `dateRange` ('7d' | '30d' | '90d'), default '30d'
2. Data fetching: Use `useEffect` or SWR to fetch from `/api/analytics?range=${dateRange}`
3. Loading state: Skeleton cards + skeleton chart
4. Layout:
   ```
   <h1>Team Analytics</h1>            <!-- Playfair Display -->
   <DateRangeFilter />                <!-- Top right -->
   <MetricsCards totals={data.totals} />
   <UsageChart data={data.daily} />
   ```
   - If data includes userBreakdown, show a "Team Breakdown" table below the chart:
     - Columns: User Name, Searches, Profile Views, Enrichments, Exports
     - Dark table with zebra striping (zinc-900 / zinc-950)
5. Role check: If user is not tenant_admin or super_admin, redirect to dashboard
6. Page title: "Team Analytics" with tenant name

Create `src/app/admin/analytics/page.tsx`:
- Similar structure but for super_admin cross-tenant view
1. Data fetching: `/api/analytics?range=${dateRange}` (super admin sees all tenants)
2. Additional features:
   - Tenant dropdown filter (select specific tenant or "All Tenants")
   - When tenant selected, fetches: `/api/analytics?range=${dateRange}&tenant_id=${tenantId}`
3. Layout:
   ```
   <h1>Platform Analytics</h1>        <!-- Playfair Display -->
   <div className="flex gap-4">
     <TenantFilter />                 <!-- Tenant dropdown -->
     <DateRangeFilter />              <!-- Date range -->
   </div>
   <MetricsCards totals={data.totals} />
   <UsageChart data={data.daily} />
   ```
   - If viewing "All Tenants", show a "Tenant Breakdown" table:
     - Columns: Tenant Name, Searches, Profile Views, Enrichments, Exports
     - Each row clickable to filter to that tenant
4. Role check: If not super_admin, return 403 or redirect
5. Page title: "Platform Analytics"

**Styling for both pages:**
- bg-zinc-950 page background
- Section spacing: space-y-8
- Cards grid: grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4
- Chart container: bg-zinc-900 rounded-xl p-6 border border-zinc-800
- Playfair Display for page heading and section headings
- Inter for body text and table content
  </action>
  <verify>
Both dashboard pages exist.
Tenant admin page at `src/app/[orgId]/dashboard/analytics/page.tsx`.
Super admin page at `src/app/admin/analytics/page.tsx`.
Both use DateRangeFilter, MetricsCards, UsageChart components.
Super admin page has tenant dropdown filter.
Role checks restrict access.
`pnpm build` passes.
  </verify>
  <done>
Tenant admin dashboard shows team usage at /[orgId]/dashboard/analytics. Super admin dashboard shows platform-wide metrics at /admin/analytics. Both have date range filters, summary cards, and trend charts with dark theme styling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create activity log viewer page for tenant admin (ACT-03)</name>
  <files>
    src/components/activity/activity-log-viewer.tsx
    src/app/[orgId]/dashboard/activity/page.tsx
  </files>
  <action>
Create `src/components/activity/activity-log-viewer.tsx`:
- "use client" component
- Props: `{ initialData?: ActivityLogEntry[] }`
- State management:
  - `entries`: Array of activity log entries
  - `page`: current page number (default 1)
  - `total`: total entries count
  - `filters`: { actionType?: string; userId?: string; startDate?: string; endDate?: string }
  - `isLoading`: boolean

- **Filter Bar:**
  - Action Type dropdown: Select from ACTION_TYPES (all 11 types) or "All"
  - User dropdown: Select from team members or "All Users" (fetch users from API or pass as prop)
  - Date range: Start date and End date pickers (simple input[type=date])
  - "Apply Filters" button

- **Activity Table:**
  - Columns: Timestamp, User, Action, Target, Details
  - Timestamp: Formatted as relative time (e.g., "2 hours ago") with full date on hover
  - User: User name
  - Action: Human-readable action label (e.g., "search_executed" -> "Executed Search", "profile_viewed" -> "Viewed Profile")
  - Target: Link to target if applicable (e.g., prospect name links to profile)
  - Details: Expandable metadata JSON (collapsed by default, click to expand)
  - Dark table styling: bg-zinc-900, zinc-800 borders, zinc-300 text
  - Hover state on rows: bg-zinc-800

- **Pagination:**
  - "Previous" and "Next" buttons
  - "Page X of Y" indicator
  - 50 entries per page

- Data fetching function:
  ```typescript
  const fetchActivityLog = async () => {
    setIsLoading(true);
    const params = new URLSearchParams();
    if (filters.actionType) params.set('action_type', filters.actionType);
    if (filters.userId) params.set('user_id', filters.userId);
    if (filters.startDate) params.set('start_date', filters.startDate);
    if (filters.endDate) params.set('end_date', filters.endDate);
    params.set('page', String(page));
    params.set('limit', '50');

    const response = await fetch(`/api/activity?${params.toString()}`);
    const data = await response.json();
    setEntries(data.data);
    setTotal(data.total);
    setIsLoading(false);
  };
  ```
  This calls the activity log query API built in Plan 02 (`GET /api/activity`).

- Human-readable action type labels:
  ```typescript
  const ACTION_LABELS: Record<string, string> = {
    login: 'Logged In',
    search_executed: 'Executed Search',
    profile_viewed: 'Viewed Profile',
    profile_enriched: 'Enriched Profile',
    add_to_list: 'Added to List',
    remove_from_list: 'Removed from List',
    status_updated: 'Updated Status',
    note_added: 'Added Note',
    csv_exported: 'Exported CSV',
    persona_created: 'Created Persona',
    lookalike_search: 'Lookalike Search',
  };
  ```

Create `src/app/[orgId]/dashboard/activity/page.tsx`:
- Server component wrapper page
- Validate user session
- Role check: Only tenant_admin and super_admin can access (redirect others to dashboard)
- Page title: "Activity Log" (Playfair Display)
- Render `<ActivityLogViewer />` as the main content
- Dark theme: bg-zinc-950 page background
- Add breadcrumb navigation: Dashboard > Activity Log
  </action>
  <verify>
`src/components/activity/activity-log-viewer.tsx` exists and exports `ActivityLogViewer`.
`src/app/[orgId]/dashboard/activity/page.tsx` exists.
Activity log viewer fetches from `GET /api/activity` (Plan 02 API).
Filter bar supports action_type, user, and date range filters.
Table displays entries with pagination (50 per page).
Role check restricts to tenant_admin and super_admin.
`pnpm build` passes.
  </verify>
  <done>
Activity log viewer page at /[orgId]/dashboard/activity displays all team activity log entries with filtering by action type, user, and date range. Paginated table with human-readable labels. Uses the activity log API from Plan 02. Covers ACT-03.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Usage metrics dashboards for tenant admin (team view) and super admin (platform view) with Recharts charts, metric cards, and date range filtering. Activity log viewer page for tenant admins with filters and pagination.</what-built>
  <how-to-verify>
    1. Navigate to /[orgId]/dashboard/analytics as tenant admin
    2. Verify date range filter (7d, 30d, 90d) changes displayed data
    3. Check metric cards show totals with gold accent numbers
    4. Verify line chart renders with dark theme (no white backgrounds)
    5. Navigate to /admin/analytics as super admin
    6. Verify tenant dropdown filter works
    7. Check chart colors are distinguishable on dark background
    8. Navigate to /[orgId]/dashboard/activity as tenant admin
    9. Verify activity log table loads with entries
    10. Test filters: select an action type, verify table updates
    11. Test pagination: verify Next/Previous buttons work
    12. Verify non-admin users are redirected from activity log page
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm build` passes
2. Both analytics dashboard pages render with data from /api/analytics
3. Date range filter changes data
4. Charts use dark theme colors
5. Metric cards show all 6 metrics
6. Role checks enforce access
7. Activity log viewer at /[orgId]/dashboard/activity loads entries from /api/activity
8. Activity log filters work (action type, user, date range)
9. Pagination works with 50 entries per page
</verification>

<success_criteria>
Usage metrics dashboards display team and platform analytics with line charts, summary cards, and date range filters. Activity log viewer allows tenant admins to browse all team activity with filters and pagination. Dark theme throughout. Tenant admin sees team data, super admin sees cross-tenant data. Requirements ANLY-02, ANLY-03, ANLY-05, ACT-03 complete.
</success_criteria>

<output>
After completion, create `.planning/phases/03-enrich-ship/03-09-SUMMARY.md`
</output>
