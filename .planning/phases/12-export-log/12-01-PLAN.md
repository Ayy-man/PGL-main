---
phase: 12-export-log
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/layout/nav-items.tsx
  - src/app/[orgId]/exports/page.tsx
  - src/app/[orgId]/exports/components/export-stat-cards.tsx
  - src/app/[orgId]/exports/components/export-log-client.tsx
autonomous: true
requirements: [EXP-01, EXP-02, EXP-03, EXP-04, ACT-01, ACT-03]

must_haves:
  truths:
    - "Exports nav item appears in sidebar navigation and highlights when active"
    - "Tenant admin can view a paginated table of csv_exported activity entries at /{orgId}/exports"
    - "Page shows three stat cards: Total Monthly Exports, Unique Prospects, and Top Exporter"
    - "Stat card values update when date filters are applied"
    - "Re-download button triggers CSV download for exports with valid list IDs"
    - "Re-download button shows 'Unavailable' when list ID is missing"
    - "Exported By column shows user display names (not UUIDs)"
    - "Empty state renders when no export activity exists"
    - "Non-admin users are redirected away from the exports page"
  artifacts:
    - path: "src/components/layout/nav-items.tsx"
      provides: "Exports nav link in sidebar"
      contains: "exports"
    - path: "src/app/[orgId]/exports/page.tsx"
      provides: "Server Component with auth + initial data fetch"
      exports: ["default"]
    - path: "src/app/[orgId]/exports/components/export-stat-cards.tsx"
      provides: "Three stat cards derived from export data"
      exports: ["ExportStatCards"]
    - path: "src/app/[orgId]/exports/components/export-log-client.tsx"
      provides: "Client component with table, filters, pagination, re-download"
      exports: ["ExportLogClient"]
  key_links:
    - from: "src/components/layout/nav-items.tsx"
      to: "/{orgId}/exports"
      via: "NAV_ITEMS entry"
      pattern: "exports"
    - from: "src/app/[orgId]/exports/page.tsx"
      to: "activity_log table"
      via: "createClient().from('activity_log')"
      pattern: "activity_log.*csv_exported"
    - from: "src/app/[orgId]/exports/page.tsx"
      to: "users table"
      via: "createClient().from('users')"
      pattern: "users.*full_name"
    - from: "src/app/[orgId]/exports/components/export-log-client.tsx"
      to: "/api/activity"
      via: "fetch with action_type=csv_exported"
      pattern: "api/activity.*csv_exported"
    - from: "src/app/[orgId]/exports/components/export-log-client.tsx"
      to: "/api/export/csv"
      via: "window.location.href for re-download"
      pattern: "api/export/csv.*listId"
---

<objective>
Build the Export Log page (Screen E) — a luxury-styled export history view at `/{orgId}/exports` with stat cards, filterable paginated table, re-download actions, and user display names. Also add the Exports nav item to the sidebar.

Purpose: Tenant admins need visibility into their team's data extraction history to monitor usage, access previous downloads, and track export volume. This surfaces the csv_exported activity log entries through the design system's UI language.

Output: A fully functional Export Log page with nav item, stat cards, table, filters, pagination, re-download, and empty state — all following the design system (Cormorant headings, DM Sans body, CSS variable tokens, surface-card treatment, Lucide icons).
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/12-export-log/12-RESEARCH.md
@design-system/MASTER.md
@src/components/layout/nav-items.tsx
@src/app/[orgId]/layout.tsx
@src/lib/activity-logger.ts
@src/app/api/activity/route.ts
@src/app/api/export/csv/route.ts
@src/components/ui/table.tsx
@src/components/ui/card.tsx
@src/components/ui/empty-state.tsx
@src/components/ui/breadcrumbs.tsx
@src/components/activity/activity-log-viewer.tsx
@stitch/crm_sync_team_export_log/code.html

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/lib/activity-logger.ts:
```typescript
export type ActionType =
  | "login" | "search_executed" | "profile_viewed" | "profile_enriched"
  | "add_to_list" | "remove_from_list" | "status_updated" | "note_added"
  | "csv_exported" | "persona_created" | "lookalike_search";

export interface ActivityLogEntry {
  id: string;
  tenant_id: string;
  user_id: string;
  action_type: ActionType;
  target_type: string | null;
  target_id: string | null;
  metadata: Record<string, unknown> | null;
  ip_address: string | null;
  user_agent: string | null;
  created_at: string;
}
```

From src/lib/supabase/server.ts:
```typescript
export async function createClient(): Promise<SupabaseClient>;
```

From src/components/ui/card.tsx:
```typescript
export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
// Card uses className="surface-card rounded-[14px] text-card-foreground"
```

From src/components/ui/table.tsx:
```typescript
export { Table, TableHeader, TableBody, TableFooter, TableHead, TableRow, TableCell, TableCaption }
// TableHead: 11px uppercase tracking-[1px] text-muted-foreground
// TableRow: border-b border-[var(--border-subtle)] hover:bg-[rgba(255,255,255,0.02)]
// TableCell: px-4 py-3
```

From src/components/ui/empty-state.tsx:
```typescript
export function EmptyState({ icon, title, description, children, className, variant }: EmptyStateProps);
```

From src/components/ui/breadcrumbs.tsx:
```typescript
export function Breadcrumbs({ items, rightContent }: BreadcrumbsProps);
// items: Array<{ label: string; href?: string }>
```

From src/app/api/activity/route.ts:
```
GET /api/activity?action_type=csv_exported&start_date=ISO&end_date=ISO&page=N&limit=N
Response: { data: ActivityLogEntry[], total: number, page: number, limit: number, has_more: boolean }
Access: tenant_admin and super_admin only
```

From src/app/api/export/csv/route.ts:
```
GET /api/export/csv?listId={uuid}
Response: Streaming CSV with Content-Disposition: attachment
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Exports nav item to sidebar and build Server Component page</name>
  <files>src/components/layout/nav-items.tsx, src/app/[orgId]/exports/page.tsx</files>
  <action>
**1. Add Exports nav item to `src/components/layout/nav-items.tsx`:**

Import `FileDown` from `lucide-react`. Add a new entry to the `NAV_ITEMS` array after the "Lists" entry:

```typescript
{ label: "Exports", href: "/exports", icon: FileDown, exact: false },
```

This ensures the Export Log appears in the sidebar between Lists and Activity, matching the stitch mockup's navigation ordering.

**2. Create `src/app/[orgId]/exports/page.tsx` as a Server Component:**

This page handles auth, role check, initial data fetch, user name lookup, and renders the client components.

Implementation details:

- Import `createClient` from `@/lib/supabase/server`, `redirect` from `next/navigation`
- Accept async params: `{ params }: { params: Promise<{ orgId: string }> }`
- Authenticate via `supabase.auth.getUser()` — redirect to `/login` if no user
- Check role: `user.app_metadata?.role` — redirect to `/${orgId}` if not `tenant_admin` or `super_admin`
- Query `activity_log` directly (NOT via `/api/activity` route — avoids HTTP round-trip):
  ```typescript
  const firstOfMonth = new Date();
  firstOfMonth.setDate(1);
  firstOfMonth.setHours(0, 0, 0, 0);

  const { data: exports, count } = await supabase
    .from("activity_log")
    .select("*", { count: "exact" })
    .eq("action_type", "csv_exported")
    .gte("created_at", firstOfMonth.toISOString())
    .order("created_at", { ascending: false })
    .range(0, 19);
  ```
- Collect distinct `user_id` values from the exports results
- Run secondary query for display names:
  ```typescript
  const userIds = [...new Set((exports ?? []).map((e) => e.user_id))];
  const { data: users } = await supabase
    .from("users")
    .select("id, full_name")
    .in("id", userIds);
  const userMap: Record<string, string> = Object.fromEntries(
    (users ?? []).map((u) => [u.id, u.full_name ?? u.id.slice(0, 8)])
  );
  ```
- Render page structure:
  - `Breadcrumbs` with items `[{ label: "Dashboard", href: \`/${orgId}\` }, { label: "Export Log" }]`
  - Page header: `h1` with `font-serif font-semibold` and inline style `fontSize: "38px", letterSpacing: "-0.5px", color: "var(--text-primary-ds)"`. Subtitle `p` with `text-sm` and `color: "var(--text-secondary-ds)"` reading "Monitor your team's data extraction history and access previous downloads."
  - `ExportStatCards` receiving the initial exports array, count, and userMap
  - `ExportLogClient` receiving orgId, initial data (exports, count), and userMap

**IMPORTANT design system compliance:**
- No raw Tailwind color classes (`zinc-*`, `gray-*`, etc.) — use CSS variables via inline style
- `font-serif` for headings (Cormorant Garamond), never `font-cormorant`
- All card surfaces use `surface-card` class (via Card component)
- Only Lucide icons — no Material Symbols
- No scale transforms on hover
  </action>
  <verify>
    <automated>cd /Users/aymanbaig/Desktop/Manual\ Library/Phronesis-main && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
    - Exports nav item appears in sidebar between Lists and Activity with FileDown icon
    - Server Component at /{orgId}/exports/ authenticates user, checks role, fetches initial csv_exported entries for current month, resolves user display names, and renders page layout with Breadcrumbs, heading, ExportStatCards, and ExportLogClient
    - Non-admin roles redirected to /{orgId}
  </done>
</task>

<task type="auto">
  <name>Task 2: Build ExportStatCards component</name>
  <files>src/app/[orgId]/exports/components/export-stat-cards.tsx</files>
  <action>
Create `src/app/[orgId]/exports/components/export-stat-cards.tsx` as a pure component (no "use client" needed if it receives pre-computed data, but since parent ExportLogClient is client it should be a regular component — mark as "use client" since it will be imported into the client component for filter-reactive updates).

**Props interface:**

```typescript
interface ExportStatCardsProps {
  totalExports: number;
  uniqueProspects: number;
  topExporter: {
    name: string;
    initials: string;
    exportCount: number;
    prospectCount: number;
  } | null;
}
```

**Implementation:**

Import `Card`, `CardContent` from `@/components/ui/card` and `FileDown`, `Users`, `Trophy` from `lucide-react`.

Render a responsive grid: `grid grid-cols-1 sm:grid-cols-3 gap-4`.

**Card 1 — Total Monthly Exports:**
- Card with `relative overflow-hidden` class
- Background icon: `FileDown` at `h-12 w-12` with `opacity-10` and `color: var(--gold-primary)`, positioned `absolute top-4 right-4`
- Label: `text-[11px] font-semibold uppercase tracking-[1px]` with `color: var(--text-tertiary)` — "TOTAL MONTHLY EXPORTS"
- Value: `font-serif text-4xl font-semibold` with `color: var(--text-primary-ds)` — `{totalExports}`
- Subtext: `text-xs` with `color: var(--text-tertiary)` — "Files generated this billing cycle"

**Card 2 — Unique Prospects:**
- Same pattern with `Users` icon
- Label: "UNIQUE PROSPECTS"
- Value: `{uniqueProspects.toLocaleString()}`
- Subtext: "High Net Worth Individuals exported"

**Card 3 — Top Exporter:**
- Same card pattern with `Trophy` icon
- Label: "TOP EXPORTER"
- Instead of a large number, show the top exporter's avatar (initials in a gold circle) + name + stats:
  ```tsx
  <div className="flex items-center gap-3 mt-3">
    <div
      className="flex items-center justify-center h-10 w-10 rounded-full text-sm font-semibold"
      style={{
        background: "var(--gold-bg-strong)",
        color: "var(--gold-primary)",
        border: "1px solid var(--border-gold)",
      }}
    >
      {topExporter.initials}
    </div>
    <div>
      <p className="font-serif text-xl font-semibold" style={{ color: "var(--text-primary-ds)" }}>
        {topExporter.name}
      </p>
      <p className="text-xs" style={{ color: "var(--text-tertiary)" }}>
        {topExporter.exportCount} Exports / {topExporter.prospectCount.toLocaleString()} Prospects
      </p>
    </div>
  </div>
  ```
- If `topExporter` is null, show "—" as value with subtext "No exports yet"

**IMPORTANT:** Use `mt-3` spacing between label and value. CardContent gets `pt-6`. All colors via CSS variables in `style` props. No raw Tailwind color classes.
  </action>
  <verify>
    <automated>cd /Users/aymanbaig/Desktop/Manual\ Library/Phronesis-main && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
    - ExportStatCards renders 3 stat cards in a responsive grid
    - Cards use surface-card treatment (via Card component), Cormorant headings for values, CSS variable tokens for all colors
    - Top Exporter card shows gold initials circle + name + stats when data exists, graceful fallback when null
  </done>
</task>

<task type="auto">
  <name>Task 3: Build ExportLogClient with table, filters, pagination, and re-download</name>
  <files>src/app/[orgId]/exports/components/export-log-client.tsx</files>
  <action>
Create `src/app/[orgId]/exports/components/export-log-client.tsx` with `"use client"` directive.

**Props interface:**

```typescript
interface ExportLogClientProps {
  orgId: string;
  initialExports: ActivityLogEntry[];
  initialTotal: number;
  userMap: Record<string, string>;
}
```

Import `ActivityLogEntry` from `@/lib/activity-logger`.

**State management:**

Use `useState` for: `exports` (initialized from props), `total` (from props), `page` (default 1), `loading` (default false), `startDate` (string, default: first of current month ISO), `endDate` (string, default: empty). Use `useCallback` for fetch function.

**Stat card integration:**

Import `ExportStatCards` and compute stat values from the current `exports` array + `total`:
- `totalExports` = `total`
- `uniqueProspects` = sum of `(entry.metadata as Record<string, unknown>)?.memberCount` across all entries, using optional chaining and `?? 0` fallback for each entry
- `topExporter`: reduce entries to count per user_id, find the max, look up name from `userMap`, derive initials from first character of display name

Render `ExportStatCards` above the table section.

**Filter section:**

A flex row with date inputs and a Filter button:
- Start date: `<input type="date">` with label "Start Date", styled with `rounded-[8px] border` and inline style `borderColor: "var(--border-default)", background: "var(--bg-input)", color: "var(--text-primary-ds)"`, padding `px-3 py-2 text-sm`
- End date: same pattern
- Clear button: `Button` variant `ghost` size `sm` with `X` icon — resets dates and page to 1, refetches

**Table section:**

Use `Table`, `TableHeader`, `TableBody`, `TableHead`, `TableRow`, `TableCell` from `@/components/ui/table`.

Table wrapped in a Card (surface-card). Table header row with `TableHead` columns:
1. **Timestamp** — left aligned
2. **List Name** — left aligned
3. **Row Count** — left aligned
4. **Format** — left aligned
5. **Exported By** — left aligned
6. **Actions** — right aligned (add `text-right` class)

Each `TableRow` renders:
1. **Timestamp**: `<TableCell className="font-mono text-xs" style={{ color: "var(--text-tertiary)" }}>` with `format(new Date(entry.created_at), "MMM d, h:mm a")` from `date-fns`
2. **List Name**: `<TableCell>` with `<span className="text-sm font-medium" style={{ color: "var(--text-primary-ds)" }}>` showing `(entry.metadata as Record<string, unknown>)?.listName as string ?? "Unknown List"`. Wrap with `List` icon (Lucide) at `h-4 w-4 shrink-0` and `color: var(--text-tertiary)` in a flex container
3. **Row Count**: `<TableCell>` with a Badge-like span: `inline-flex items-center px-2 py-0.5 rounded text-xs font-medium` with inline style `background: "rgba(255,255,255,0.03)", border: "1px solid var(--border-default)", color: "var(--text-primary-ds)"` showing `(entry.metadata as Record<string, unknown>)?.memberCount ?? "—"`
4. **Format**: `<TableCell>` with a small badge: `text-[10px] font-semibold uppercase px-2 py-1 rounded` with inline style `background: "rgba(255,255,255,0.03)", border: "1px solid var(--border-default)", color: "var(--text-tertiary)"` — always "CSV" (per research: system only supports CSV, no format field in metadata)
5. **Exported By**: `<TableCell>` with a flex row showing user initials in a small circle (h-6 w-6 rounded-full, gold-tinted bg) + display name from `userMap[entry.user_id] ?? entry.user_id.slice(0, 8) + "..."`
6. **Actions**: `<TableCell className="text-right">` with the Re-download button

**Re-download button logic:**

If `entry.target_id` is truthy:
```tsx
<button
  className="inline-flex items-center gap-1 text-sm font-medium transition-colors cursor-pointer"
  style={{ color: "var(--text-tertiary)" }}
  onMouseEnter={(e) => { (e.currentTarget as HTMLElement).style.color = "var(--gold-primary)"; }}
  onMouseLeave={(e) => { (e.currentTarget as HTMLElement).style.color = "var(--text-tertiary)"; }}
  onClick={() => { window.location.href = `/api/export/csv?listId=${entry.target_id}`; }}
  aria-label="Re-download this export"
>
  <Download className="h-4 w-4 shrink-0" />
  Re-download
</button>
```

If `entry.target_id` is null/undefined: show `<span className="text-xs" style={{ color: "var(--text-muted)" }}>Unavailable</span>`.

**Pagination bar:**

Below the table Card, a flex row with `justify-between items-center mt-4`:
- Left: `<p className="text-xs" style={{ color: "var(--text-tertiary)" }}>Showing {startIdx}-{endIdx} of {total} exports</p>`
- Right: Previous / Next buttons styled as ghost buttons with CSS variable borders:
  ```tsx
  <button
    disabled={page <= 1}
    onClick={() => { setPage(p => Math.max(1, p - 1)); }}
    className="px-3 py-1.5 text-xs font-medium rounded-[8px] transition-colors cursor-pointer disabled:opacity-40 disabled:cursor-not-allowed"
    style={{ border: "1px solid var(--border-default)", color: "var(--text-secondary-ds)" }}
  >
    Previous
  </button>
  ```
  Same pattern for Next button, disabled when `page * PAGE_SIZE >= total`.

**Fetch function:**

`useCallback` that sets `loading=true`, builds URL params for `/api/activity?action_type=csv_exported&start_date=...&end_date=...&page=N&limit=20`, fetches, parses response text then JSON (per `HTML-safe JSON parse guard` pattern from STATE.md decisions), updates `exports` and `total`, sets `loading=false`. Include error handling with fallback to empty array.

Call fetch on mount (via `useEffect`) and when `page`, `startDate`, or `endDate` change — BUT skip initial fetch if `page === 1` and dates match initial (data already passed from server).

**Also fetch user names for new users on subsequent pages:**

After fetching new exports, collect any user_ids not in `userMap`, and if found, do a secondary fetch to `/api/activity` is not needed — instead, store the userMap in a `useRef` and on the server side pass all known users. For client-side pagination, show `userId.slice(0, 8)...` for unknown users since the server-side user lookup only covered the initial page. (This is acceptable — the primary use case is small teams where the same users appear on every page.)

**Loading state:**

Show a simple loading indicator inside the table area: a div with `flex h-64 items-center justify-center` and `<p style={{ color: "var(--text-tertiary)" }}>Loading exports...</p>`.

**Empty state:**

When `exports.length === 0` and not loading, render:
```tsx
<EmptyState
  icon={FileDown}
  title="No exports yet"
  description="When your team exports prospect lists to CSV, they'll appear here for tracking and re-download."
/>
```

**IMPORTANT design system compliance:**
- All colors via CSS variables — no raw Tailwind color classes
- `font-serif` for stat card values only (Cormorant Garamond) — body/UI uses `font-sans` (DM Sans)
- `font-mono text-xs` for timestamps per MASTER.md "data" type scale
- Table uses existing `Table/TableHead/TableRow/TableCell` components (already design-system compliant)
- Card component provides `surface-card` treatment automatically
- Lucide icons only: `Download`, `FileDown`, `List`, `X`
- `cursor-pointer` on all clickable elements
- Transitions: `transition-colors` only, no scale transforms
  </action>
  <verify>
    <automated>cd /Users/aymanbaig/Desktop/Manual\ Library/Phronesis-main && npx tsc --noEmit --pretty 2>&1 | head -50</automated>
  </verify>
  <done>
    - ExportLogClient renders stat cards, date filter inputs, export history table with 6 columns, pagination controls, and empty state
    - Table shows Timestamp (font-mono), List Name (with icon), Row Count (badge), Format (CSV badge), Exported By (initials + name), Re-download action
    - Re-download navigates to /api/export/csv?listId={target_id}, disabled/unavailable when target_id is null
    - Pagination shows "Showing X-Y of Z exports" with Previous/Next buttons
    - All colors use CSS variables, all headings use font-serif, all icons are Lucide
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — TypeScript compiles without errors
2. `pnpm build` — Next.js build passes without errors (Dynamic server usage messages for cookie-using routes are expected and informational, not errors)
3. Verify nav-items.tsx contains "Exports" entry with `FileDown` icon and `/exports` href
4. Verify page.tsx checks role and redirects non-admins
5. Verify ExportStatCards renders 3 cards with CSS variable tokens
6. Verify ExportLogClient renders table with re-download button conditional on target_id
7. Verify no raw Tailwind color classes (zinc-*, gray-*, emerald-*, yellow-*) in any new file
8. Verify `font-serif` used only for headings/values, never for body text
</verification>

<success_criteria>
- TypeScript compiles clean (`npx tsc --noEmit`)
- `pnpm build` passes
- Export Log page exists at `/{orgId}/exports`
- Sidebar shows "Exports" nav item with FileDown icon
- Page renders Breadcrumbs > heading > 3 stat cards > filter inputs > data table > pagination
- Re-download button present on rows with valid target_id, "Unavailable" on rows without
- Empty state shown when no csv_exported entries exist
- All new code uses CSS variable tokens — zero raw Tailwind color classes
</success_criteria>

<output>
After completion, create `.planning/phases/12-export-log/12-01-SUMMARY.md`
</output>
