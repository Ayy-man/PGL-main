# Plan 11-02: Create ActivityFeed Client Component

---
wave: 1
depends_on: []
files_modified:
  - src/components/dashboard/activity-feed.tsx
autonomous: true
requirements: [ACT-03, UI-05]
---

## Goal

Create a `"use client"` ActivityFeed component that fetches the 10 most recent activity log entries from `/api/activity` and renders them as a compact feed. This component is rendered only for admin users (tenant_admin / super_admin) — the parent Server Component gates its display based on role. The feed shows action type, relative time, and a truncated user ID per entry. Includes skeleton loading state and manual refresh.

## must_haves

- Component is `"use client"` with `useEffect` fetch on mount
- Fetches `/api/activity?limit=10&page=1` (the API is already role-gated server-side)
- Uses text-then-parse guard on the response to handle potential HTML error pages
- Shows skeleton loading state while fetching (3-4 animated placeholder bars)
- Shows EmptyState when no entries returned
- Each entry shows: action label, relative time, truncated user_id (first 8 chars)
- `relativeTime` function copied from `activity-log-viewer.tsx` pattern (not imported — different module boundary)
- `ACTION_LABELS` map copied from `activity-log-viewer.tsx` pattern (covers all 11 action types)
- Manual "Refresh" button (Ghost variant, small) in the feed header
- CSS variables only — zero raw Tailwind color classes
- onMouseEnter/onMouseLeave for hover states on entries
- Lucide icons only — `RefreshCw` for refresh button, `Activity` for section icon
- Section heading uses `font-serif` h3 at 22px

## Tasks

<task id="11-02-T1">
<title>Create ActivityFeed client component with fetch, loading, and render logic</title>
<description>
Create `src/components/dashboard/activity-feed.tsx`:

```typescript
"use client";

import { useEffect, useState, useCallback } from "react";
import { RefreshCw, Activity } from "lucide-react";
```

1. Define the ActivityEntry interface (inline, do not import from activity-logger to avoid server/client module boundary issues):
```typescript
interface ActivityEntry {
  id: string;
  tenant_id: string;
  user_id: string;
  action_type: string;
  target_type: string | null;
  target_id: string | null;
  metadata: Record<string, unknown> | null;
  created_at: string;
}
```

2. Copy the ACTION_LABELS map from `activity-log-viewer.tsx`:
```typescript
const ACTION_LABELS: Record<string, string> = {
  login: "Logged In",
  search_executed: "Executed Search",
  profile_viewed: "Viewed Profile",
  profile_enriched: "Enriched Profile",
  add_to_list: "Added to List",
  remove_from_list: "Removed from List",
  status_updated: "Updated Status",
  note_added: "Added Note",
  csv_exported: "Exported CSV",
  persona_created: "Created Persona",
  lookalike_search: "Lookalike Search",
};
```

3. Copy the relativeTime function from `activity-log-viewer.tsx`:
```typescript
function relativeTime(dateStr: string): string {
  const now = Date.now();
  const then = new Date(dateStr).getTime();
  const diff = now - then;
  const minutes = Math.floor(diff / 60000);
  if (minutes < 1) return "Just now";
  if (minutes < 60) return `${minutes}m ago`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours}h ago`;
  const days = Math.floor(hours / 24);
  if (days < 30) return `${days}d ago`;
  return new Date(dateStr).toLocaleDateString();
}
```

4. Component implementation:
```typescript
export function ActivityFeed() {
  const [entries, setEntries] = useState<ActivityEntry[]>([]);
  const [loading, setLoading] = useState(true);

  const fetchEntries = useCallback(async () => {
    setLoading(true);
    try {
      const res = await fetch("/api/activity?limit=10&page=1");
      const text = await res.text();
      let json: { data: ActivityEntry[] } | null = null;
      try {
        json = JSON.parse(text);
      } catch {
        json = null;
      }
      setEntries(json?.data || []);
    } catch {
      setEntries([]);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchEntries();
  }, [fetchEntries]);

  return (
    <div>
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-2">
          <Activity
            className="h-4 w-4 shrink-0"
            style={{ color: "var(--gold-muted)" }}
          />
          <h3
            className="font-serif text-[22px] font-semibold"
            style={{ color: "var(--text-primary)" }}
          >
            Live Feed
          </h3>
        </div>
        <button
          onClick={fetchEntries}
          disabled={loading}
          className="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-[8px] text-xs cursor-pointer transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          style={{
            background: "rgba(255,255,255,0.03)",
            border: "1px solid rgba(255,255,255,0.08)",
            color: "rgba(232,228,220,0.6)",
          }}
          onMouseEnter={(e) => {
            if (!loading) {
              e.currentTarget.style.borderColor = "var(--border-hover)";
            }
          }}
          onMouseLeave={(e) => {
            e.currentTarget.style.borderColor = "rgba(255,255,255,0.08)";
          }}
          aria-label="Refresh activity feed"
        >
          <RefreshCw className={`h-3 w-3 shrink-0 ${loading ? "animate-spin" : ""}`} />
          Refresh
        </button>
      </div>

      {loading ? (
        /* Skeleton loading state */
        <div className="space-y-2">
          {Array.from({ length: 4 }).map((_, i) => (
            <div
              key={i}
              className="h-10 animate-pulse rounded-[8px]"
              style={{
                background: "var(--bg-elevated)",
              }}
            />
          ))}
        </div>
      ) : entries.length === 0 ? (
        <div
          className="flex flex-col items-center justify-center py-8 text-center rounded-[14px]"
          style={{
            background: "var(--bg-card-gradient)",
            border: "1px solid var(--border-subtle)",
          }}
        >
          <Activity
            className="h-8 w-8 mb-2"
            style={{ color: "var(--text-tertiary)" }}
          />
          <p
            className="text-sm"
            style={{ color: "var(--text-secondary)" }}
          >
            No recent activity
          </p>
        </div>
      ) : (
        <div className="space-y-1">
          {entries.map((entry) => (
            <div
              key={entry.id}
              className="flex items-center gap-3 rounded-[8px] px-3 py-2.5 transition-colors"
              style={{ background: "transparent" }}
              onMouseEnter={(e) => {
                e.currentTarget.style.background = "var(--bg-elevated)";
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.background = "transparent";
              }}
            >
              <div className="flex-1 min-w-0">
                <p className="text-sm truncate" style={{ color: "var(--text-primary)" }}>
                  {ACTION_LABELS[entry.action_type] || entry.action_type}
                </p>
                <p className="text-xs font-mono" style={{ color: "var(--text-tertiary)" }}>
                  {entry.user_id.slice(0, 8)}...
                </p>
              </div>
              <span
                className="text-xs shrink-0"
                style={{ color: "var(--text-tertiary)" }}
              >
                {relativeTime(entry.created_at)}
              </span>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
```

Key implementation notes:
- The text-then-parse guard handles the known bug where `/api/activity` might return HTML instead of JSON.
- The loading state uses animated skeleton bars matching `var(--bg-elevated)`.
- The refresh button uses the Ghost button variant from MASTER.md (rgba background, subtle border).
- The `animate-spin` class on RefreshCw icon provides visual feedback during refresh.
- `aria-label` on the refresh button for accessibility.
- Each entry row uses onMouseEnter/onMouseLeave for hover state (project pattern from Phase 05-03).
</description>
</task>

## Verification

- `src/components/dashboard/activity-feed.tsx` exists with `"use client"` directive
- `pnpm build` passes with no TypeScript errors
- Component fetches `/api/activity?limit=10&page=1` on mount
- Text-then-parse guard present on fetch response
- Skeleton loading state renders 4 animated bars
- Empty state shows when no entries returned
- Each entry shows action label, truncated user_id, and relative time
- Refresh button triggers re-fetch with loading spinner
- No raw Tailwind color classes (grep for `zinc-`, `gray-`, `yellow-`, `emerald-`)
- No emojis used
- All interactive elements have `cursor-pointer` or appropriate cursor class
