# Plan 11-04: Build Verification + Design System Compliance Audit

---
wave: 3
depends_on: [11-03]
files_modified: []
autonomous: true
requirements: [ANLY-01, ANLY-02, ANLY-04, ANLY-05, ACT-03, UI-01, UI-04, UI-05]
---

## Goal

Verify that the Phase 11 dashboard implementation builds successfully and passes all design system compliance checks. No code changes expected — this plan is purely verification. If issues are found, fix them inline.

## must_haves

- `pnpm build` completes with zero errors (warnings are acceptable)
- All 4 new files exist: `stat-pills.tsx`, `persona-pill-row.tsx`, `recent-lists-preview.tsx`, `activity-feed.tsx`
- Rewritten `page.tsx` is a Server Component (no "use client" directive)
- Zero raw Tailwind color classes in all Phase 11 files
- Zero `font-cormorant` usage (only `font-serif`)
- Zero emojis in any component
- Zero scale transforms on hover
- All clickable elements have `cursor-pointer`
- CSS variable hover states use onMouseEnter/onMouseLeave (not Tailwind hover: with var())
- `getUser()` used in page.tsx (not `getSession()`)
- Tenant ID from `app_metadata.tenant_id` (not URL params)
- `page-enter` class on root container of page.tsx
- All card/surface elements use `rounded-[14px]` (not `rounded-xl` or `rounded-lg`)
- StatPills, ActivityFeed are conditionally rendered behind `isAdmin` guard
- PersonaPillRow, RecentListsPreview are rendered for all roles

## Tasks

<task id="11-04-T1">
<title>Run pnpm build and verify zero errors</title>
<description>
Run `pnpm build` in the project root directory.

1. If build succeeds with 0 errors: note any warnings (img-element and Dynamic server usage warnings are pre-existing and expected — do not fix them).

2. If build fails: read the error output, identify the file and line, fix the TypeScript or import error in the appropriate file, then re-run `pnpm build` until it passes.

Common issues to watch for:
- Missing imports (e.g., `Persona` type, `List` type, Lucide icons)
- Type mismatches between `Promise.all` result destructuring and actual return types
- Client component imports in Server Components (should work fine — Next.js handles this)
- `getLists` or `getPersonas` signature changes (verify they take `tenantId: string` as sole argument)
</description>
</task>

<task id="11-04-T2">
<title>Audit design system compliance across all Phase 11 files</title>
<description>
Check each of these 5 files for design system violations:

**Files to audit:**
1. `src/app/[orgId]/page.tsx`
2. `src/components/dashboard/stat-pills.tsx`
3. `src/components/dashboard/persona-pill-row.tsx`
4. `src/components/dashboard/recent-lists-preview.tsx`
5. `src/components/dashboard/activity-feed.tsx`

**Compliance checks (12 items):**

1. **Raw Tailwind colors:** Search all 5 files for `zinc-`, `gray-`, `yellow-`, `emerald-`, `red-`, `green-`, `blue-`. Result must be zero matches (except within `text-muted-foreground`, `text-foreground`, `text-destructive`, `bg-destructive` which are shadcn tokens mapped to CSS variables).

2. **font-cormorant:** Search all 5 files for `font-cormorant`. Must be zero matches. Only `font-serif` is allowed.

3. **Emojis:** Visually scan all 5 files for emoji characters. Must be zero.

4. **Scale transforms:** Search for `scale-`, `hover:scale-`, `transform: scale`. Must be zero matches.

5. **cursor-pointer:** Verify every `<Link>`, `<button>`, and clickable `<div>` has `cursor-pointer` in its className or is inheriting it from a parent class like `card-interactive`.

6. **CSS variable hover states:** Verify that no `hover:border-[var(` or `hover:bg-[var(` patterns exist. All CSS variable hover states must use onMouseEnter/onMouseLeave handlers.

7. **getUser vs getSession:** Search `page.tsx` for `getSession`. Must be zero matches. Only `getUser()` is allowed.

8. **Tenant ID source:** Verify `page.tsx` uses `user.app_metadata?.tenant_id` and does NOT use `orgId` for database queries.

9. **page-enter class:** Verify the root `<div>` in `page.tsx` has `className="page-enter ..."`.

10. **Border radius:** Search for `rounded-xl` or `rounded-lg` on card/panel containers. Dashboard cards should use `rounded-[14px]`. (Note: `rounded-[8px]` is correct for buttons and small elements per MASTER.md.)

11. **Role gating:** Verify `StatPills` and `ActivityFeed` are wrapped in `{isAdmin && ...}` conditionals. Verify `PersonaPillRow` and `RecentListsPreview` are NOT gated.

12. **Activity feed text-then-parse:** Verify `activity-feed.tsx` uses `res.text()` then `JSON.parse()` pattern (not direct `res.json()`).

**Report format:** List each check as PASS or FAIL with explanation. If any FAIL, fix the issue in the source file and re-verify.
</description>
</task>

<task id="11-04-T3">
<title>Verify component integration and data flow</title>
<description>
Verify the data flow chain from page.tsx to each sub-component:

1. **StatPills data flow:**
   - `page.tsx` queries `usage_metrics_daily` directly via Supabase
   - Aggregated totals object has shape: `{ totalLogins, searchesExecuted, profilesViewed, profilesEnriched, csvExports, listsCreated }`
   - Verify `StatPills` props interface matches this shape exactly

2. **PersonaPillRow data flow:**
   - `page.tsx` calls `getPersonas(tenantId)` which returns `Persona[]`
   - Verify `PersonaPillRow` accepts `personas: Persona[]` and `orgId: string`
   - Verify persona pill links are formatted as `/${orgId}/search?persona=${persona.id}`

3. **RecentListsPreview data flow:**
   - `page.tsx` calls `getLists(tenantId)` which returns `List[]` (ordered by `updated_at desc`)
   - Verify `RecentListsPreview` accepts `lists: List[]` and `orgId: string`
   - Verify list item links are formatted as `/${orgId}/lists/${list.id}`

4. **ActivityFeed data flow:**
   - Client component fetches `/api/activity?limit=10&page=1` independently
   - No props needed from parent (role gating is at the render level)
   - Verify the component is self-contained

5. **New prospects banner:**
   - Verify `prospects` table query uses `tenant_id` and `created_at >= 24h ago`
   - Verify count is displayed with correct singular/plural form

If any data flow mismatch is found (e.g., prop name doesn't match query result field name), fix the issue in the relevant file.
</description>
</task>

## Verification

- `pnpm build` passes with zero errors
- All 12 design system compliance items pass
- All 4 data flow chains verified correct
- No code changes needed (or all fixes applied and verified)
- Phase 11 is complete and ready for deployment
