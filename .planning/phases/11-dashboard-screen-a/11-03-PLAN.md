# Plan 11-03: Rewrite Tenant Dashboard Page (page.tsx)

---
wave: 2
depends_on: [11-01, 11-02]
files_modified:
  - src/app/[orgId]/page.tsx
autonomous: true
requirements: [ANLY-01, ANLY-02, ANLY-04, ANLY-05, ACT-03, UI-01, UI-04, UI-05]
---

## Goal

Replace the current minimal tenant dashboard (`/[orgId]/page.tsx`) with the full data-rich home screen. The Server Component fetches personas, lists, and analytics totals in parallel, then renders: greeting header (Cormorant 38px), new-prospects alert banner (conditional), stat pills (admin-only), persona pill row (all roles), recent lists preview (all roles), and live activity feed (admin-only). Role-gated sections use conditional rendering based on `user.app_metadata.role`.

## must_haves

- Page is a Server Component (async function, no "use client")
- `getUser()` used for auth (NOT `getSession()`)
- Tenant ID sourced from `user.app_metadata.tenant_id` (NEVER from URL params)
- Greeting header: Cormorant 38px weight 600 (`font-serif font-semibold` with inline `fontSize: "38px"`)
- Date subtitle below greeting: `text-sm text-muted-foreground`
- `Promise.all` used for parallel data fetching (personas, lists, analytics)
- Analytics fetch uses direct Supabase query on `usage_metrics_daily` (not HTTP to /api/analytics) to avoid extra network hop in Server Component
- Analytics totals shown as StatPills (admin-only, not for agent/assistant roles)
- StatPills show 7d totals only (no date range toggle on home page — that lives on analytics sub-page)
- PersonaPillRow rendered for ALL roles (not just admins)
- RecentListsPreview rendered for ALL roles
- ActivityFeed rendered for admin roles only (`tenant_admin` / `super_admin`)
- New prospects alert banner: query `prospects` for `created_at >= now() - 24h`, show count if > 0, hide if 0
- `.page-enter` class applied to root container for fade-in animation
- `space-y-8` spacing between sections (per dashboard.md density rules)
- Search hero card preserved but simplified — secondary to persona pills
- No Recharts or chart libraries on this page
- CSS variables only throughout
- Redirect to `/login` if no user session

## Tasks

<task id="11-03-T1">
<title>Rewrite /[orgId]/page.tsx with parallel data fetching and role-gated sections</title>
<description>
Replace the entire contents of `src/app/[orgId]/page.tsx` with:

```typescript
import Link from "next/link";
import { createClient } from "@/lib/supabase/server";
import { redirect } from "next/navigation";
import { Search, ArrowRight, Sparkles } from "lucide-react";
import { getPersonas } from "@/lib/personas/queries";
import { getLists } from "@/lib/lists/queries";
import { StatPills } from "@/components/dashboard/stat-pills";
import { PersonaPillRow } from "@/components/dashboard/persona-pill-row";
import { RecentListsPreview } from "@/components/dashboard/recent-lists-preview";
import { ActivityFeed } from "@/components/dashboard/activity-feed";

export default async function TenantDashboard({
  params,
}: {
  params: Promise<{ orgId: string }>;
}) {
  const { orgId } = await params;
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) {
    redirect("/login");
  }

  const tenantId = user.app_metadata?.tenant_id as string;
  const role = user.app_metadata?.role as string;
  const isAdmin = role === "tenant_admin" || role === "super_admin";

  const firstName =
    user.user_metadata?.first_name || user.email?.split("@")[0] || "there";

  const hour = new Date().getHours();
  const greeting =
    hour < 12 ? "Good morning" : hour < 17 ? "Good afternoon" : "Good evening";

  const today = new Date().toLocaleDateString("en-US", {
    weekday: "long",
    month: "long",
    day: "numeric",
    year: "numeric",
  });

  // --- Parallel data fetching ---
  // Calculate 7d date range for analytics
  const now = new Date();
  const sevenDaysAgo = new Date(now);
  sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
  const startDateStr = sevenDaysAgo.toISOString().split("T")[0];
  const endDateStr = now.toISOString().split("T")[0];

  // Calculate 24h ago for new prospects banner
  const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString();

  // Build parallel fetch array
  const fetchPromises: [
    Promise<Awaited<ReturnType<typeof getPersonas>>>,
    Promise<Awaited<ReturnType<typeof getLists>>>,
    Promise<{ count: number | null } | null>,
    Promise<{
      totalLogins: number;
      searchesExecuted: number;
      profilesViewed: number;
      profilesEnriched: number;
      csvExports: number;
      listsCreated: number;
    } | null>,
  ] = [
    getPersonas(tenantId).catch(() => []),
    getLists(tenantId).catch(() => []),
    // New prospects count (last 24h)
    supabase
      .from("prospects")
      .select("*", { count: "exact", head: true })
      .eq("tenant_id", tenantId)
      .gte("created_at", twentyFourHoursAgo)
      .then(({ count }) => ({ count }))
      .catch(() => null),
    // Analytics totals (admin-only, 7d) — direct Supabase query, not /api/analytics
    isAdmin
      ? supabase
          .from("usage_metrics_daily")
          .select("*")
          .eq("tenant_id", tenantId)
          .gte("date", startDateStr)
          .lte("date", endDateStr)
          .then(({ data: metrics }) => {
            if (!metrics || metrics.length === 0) {
              return {
                totalLogins: 0,
                searchesExecuted: 0,
                profilesViewed: 0,
                profilesEnriched: 0,
                csvExports: 0,
                listsCreated: 0,
              };
            }
            const totals = {
              totalLogins: 0,
              searchesExecuted: 0,
              profilesViewed: 0,
              profilesEnriched: 0,
              csvExports: 0,
              listsCreated: 0,
            };
            for (const m of metrics) {
              totals.totalLogins += m.total_logins || 0;
              totals.searchesExecuted += m.searches_executed || 0;
              totals.profilesViewed += m.profiles_viewed || 0;
              totals.profilesEnriched += m.profiles_enriched || 0;
              totals.csvExports += m.csv_exports || 0;
              totals.listsCreated += m.lists_created || 0;
            }
            return totals;
          })
          .catch(() => null)
      : Promise.resolve(null),
  ];

  const [personas, lists, newProspectsResult, analyticsTotals] = await Promise.all(fetchPromises);
  const newProspectsCount = newProspectsResult?.count ?? 0;

  return (
    <div className="page-enter space-y-8">
      {/* Greeting header */}
      <div>
        <h1
          className="font-serif font-semibold"
          style={{ fontSize: "38px", letterSpacing: "-0.5px", color: "var(--text-primary)" }}
        >
          {greeting}, {firstName}
        </h1>
        <p className="mt-1 text-sm text-muted-foreground">{today}</p>
      </div>

      {/* New prospects alert banner */}
      {newProspectsCount > 0 && (
        <div
          className="flex items-center gap-3 rounded-[14px] px-5 py-3"
          style={{
            background: "var(--gold-bg-strong)",
            border: "1px solid var(--border-gold)",
          }}
        >
          <Sparkles
            className="h-4 w-4 shrink-0"
            style={{ color: "var(--gold-primary)" }}
          />
          <p
            className="text-sm font-medium"
            style={{ color: "var(--gold-primary)" }}
          >
            {newProspectsCount} new {newProspectsCount === 1 ? "prospect" : "prospects"} found in the last 24h
          </p>
          <Link
            href={`/${orgId}/search`}
            className="ml-auto text-xs underline cursor-pointer"
            style={{ color: "var(--gold-text)" }}
          >
            View
          </Link>
        </div>
      )}

      {/* Stat pills (admin-only) */}
      {isAdmin && analyticsTotals && <StatPills totals={analyticsTotals} />}

      {/* Search hero — secondary action */}
      <Link
        href={`/${orgId}/search`}
        className="card-interactive group relative flex items-center gap-6 rounded-[14px] p-8 cursor-pointer block"
      >
        <div
          className="flex h-12 w-12 shrink-0 items-center justify-center rounded-[14px] transition-colors"
          style={{
            background: "var(--gold-bg)",
            color: "var(--gold-primary)",
          }}
        >
          <Search className="h-6 w-6" />
        </div>
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2">
            <span
              className="font-serif text-xl font-semibold"
              style={{ color: "var(--text-primary)" }}
            >
              Search Prospects
            </span>
            <ArrowRight
              className="h-4 w-4 opacity-0 -translate-x-2 transition-all duration-200 group-hover:opacity-100 group-hover:translate-x-0"
              style={{ color: "var(--gold-primary)" }}
            />
          </div>
          <p
            className="mt-1 text-sm"
            style={{ color: "var(--text-secondary)" }}
          >
            Find high-net-worth buyers matching your personas
          </p>
        </div>
      </Link>

      {/* Persona pill row (all roles) */}
      <PersonaPillRow personas={personas} orgId={orgId} />

      {/* Two-column layout: Recent Lists + Activity Feed */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        {/* Recent Lists (all roles) */}
        <RecentListsPreview lists={lists} orgId={orgId} />

        {/* Activity Feed (admin-only) */}
        {isAdmin && <ActivityFeed />}
      </div>
    </div>
  );
}
```

CRITICAL implementation details:

1. **Tenant ID from app_metadata** — `user.app_metadata.tenant_id`, NEVER from `orgId` URL param. This is a locked decision from Phase 2.

2. **Direct Supabase query for analytics** — The `/api/analytics` endpoint would require an HTTP round-trip from Server Component. Instead, query `usage_metrics_daily` directly using the session client (RLS will scope to tenant automatically). This matches the in-memory aggregation pattern from Phase 03 (STATE.md decision).

3. **New prospects count** — Uses `select("*", { count: "exact", head: true })` which returns only the count without row data, minimal DB load.

4. **Analytics are admin-only** — The `isAdmin` check gates both the query (avoids wasting a DB round-trip for non-admins) and the render. Non-admin users see: greeting, alert banner, search hero, persona pills, recent lists.

5. **page-enter class** on root div for the fade-in animation per MASTER.md Section 12.

6. **border-radius 14px** on the search hero card — matches MASTER.md card radius (was `rounded-xl` = 12px before, now `rounded-[14px]` = 14px).

7. **text-foreground replaced** — The old greeting used `text-foreground` (shadcn token). Replace with explicit `style={{ color: "var(--text-primary)" }}` for design system compliance. Similarly, the search description uses `var(--text-secondary)` instead of `text-muted-foreground`.

8. **Promise.all catch patterns** — Each promise has a `.catch()` fallback so that a single data source failure does not crash the entire page.

9. **Grid layout for bottom section** — Recent Lists and Activity Feed sit side-by-side on desktop (`lg:grid-cols-2`), stack on mobile (`grid-cols-1`). If user is not admin, only RecentListsPreview renders (takes full width via CSS grid auto-flow).
</description>
</task>

## Verification

- `src/app/[orgId]/page.tsx` is a Server Component (no "use client" directive)
- `pnpm build` passes with no TypeScript errors
- Greeting uses `font-serif font-semibold` at 38px with -0.5px letter-spacing
- Date subtitle renders below greeting
- New prospects alert banner shows when count > 0, hidden when 0
- StatPills render for admin roles only
- PersonaPillRow renders for all roles
- RecentListsPreview renders for all roles
- ActivityFeed renders for admin roles only
- Search hero card uses `card-interactive` class and `rounded-[14px]`
- `.page-enter` class on root container
- `space-y-8` spacing between sections
- No `getSession()` calls — only `getUser()`
- Tenant ID from `user.app_metadata.tenant_id`
- No raw Tailwind color classes
- No emojis
- No Recharts usage
