---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/globals.css
  - tailwind.config.ts
  - postcss.config.mjs
  - src/lib/env.ts
  - src/types/database.ts
  - src/types/auth.ts
  - .env.example
  - .env.local
autonomous: true

must_haves:
  truths:
    - "Tailwind color system renders correctly with OKLCH values from globals.css"
    - "Environment variables are validated at build time with type-safe access"
    - "TypeScript types exist for all 9 database tables and auth roles"
  artifacts:
    - path: "tailwind.config.ts"
      provides: "OKLCH-compatible color system without hsl() wrappers"
      contains: "var(--"
    - path: "postcss.config.mjs"
      provides: "OKLCH fallback support via PostCSS plugin"
      contains: "postcss-oklab-function"
    - path: "src/lib/env.ts"
      provides: "Zod-validated environment variables"
      exports: ["env"]
    - path: "src/types/database.ts"
      provides: "TypeScript types for all database tables"
      contains: "Tenant"
    - path: "src/types/auth.ts"
      provides: "Auth types and role definitions"
      contains: "UserRole"
    - path: ".env.example"
      provides: "Template for required environment variables"
      contains: "NEXT_PUBLIC_SUPABASE_URL"
  key_links:
    - from: "tailwind.config.ts"
      to: "src/app/globals.css"
      via: "CSS custom properties without hsl() wrapper"
      pattern: "var\\(--"
    - from: "src/lib/env.ts"
      to: ".env.local"
      via: "Zod schema validation"
      pattern: "z\\.string"
---

<objective>
Fix the OKLCH/HSL color system mismatch, establish environment variable validation, and create TypeScript types for the database schema and auth system.

Purpose: Resolve the broken color system (tailwind.config.ts uses hsl() wrappers but globals.css uses oklch() values), create foundational types that all subsequent plans depend on, and set up validated env var access.

Output: Working color system, type-safe env vars, complete TypeScript types for database and auth.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix OKLCH/HSL color mismatch and install dependencies</name>
  <files>
    tailwind.config.ts
    postcss.config.mjs
    src/app/globals.css
    .env.example
    .env.local
  </files>
  <action>
    1. Install required packages:
       ```
       pnpm add @supabase/supabase-js @supabase/ssr @upstash/redis zod jwt-decode @csstools/postcss-oklab-function
       ```

    2. Fix tailwind.config.ts: Remove ALL `hsl()` wrappers from color values. Replace every `hsl(var(--xxx))` with just `var(--xxx)`. The globals.css already uses oklch() values, so the hsl() wrapper is WRONG (it wraps oklch values in hsl(), which breaks rendering). Keep all variable names the same, just remove the hsl() wrapper.

       Example: `background: 'hsl(var(--background))'` becomes `background: 'var(--background)'`

       Do this for ALL color entries: background, foreground, card, popover, primary, secondary, muted, accent, destructive, border, input, ring, chart-1 through chart-5, and all sidebar-* colors.

    3. Update postcss.config.mjs: Add `@csstools/postcss-oklab-function` plugin with `{ preserve: true }` BEFORE tailwindcss in the plugins array. This provides HSL fallbacks for browsers that don't support oklch().

    4. Update globals.css: Remove the duplicate `:root` block at lines 5-8 and the `@media (prefers-color-scheme: dark)` block at lines 10-15 — these conflict with the tweakcn theme below. Keep the `body` style at lines 17-21 but update it to use the CSS vars from the tweakcn theme. Also remove the `body { font-family: Arial... }` and let the theme's --font-sans handle it. The `.theme` class and its :root/.dark blocks should remain.

    5. Create .env.example with all required env vars (no values, just keys with comments):
       ```
       # Supabase (safe for client)
       NEXT_PUBLIC_SUPABASE_URL=
       NEXT_PUBLIC_SUPABASE_ANON_KEY=

       # Supabase (server-only - NEVER prefix with NEXT_PUBLIC_)
       SUPABASE_SERVICE_ROLE_KEY=

       # Upstash Redis
       UPSTASH_REDIS_REST_URL=
       UPSTASH_REDIS_REST_TOKEN=

       # Apollo.io (server-only)
       APOLLO_API_KEY=

       # Anthropic Claude (server-only)
       ANTHROPIC_API_KEY=

       # ContactOut (server-only)
       CONTACTOUT_API_KEY=

       # Exa.ai (server-only)
       EXA_API_KEY=
       ```

    6. Create .env.local with placeholder values matching the same structure (this file is gitignored). Use empty string values so the app can boot in dev without real keys (env validation will be optional in dev).

    DO NOT change oklch values — they are correct from the tweakcn theme.
    DO NOT add new CSS variables — use existing ones.
  </action>
  <verify>
    Run `pnpm build` — should compile without CSS errors.
    Inspect tailwind.config.ts — no `hsl()` wrappers remain.
    Verify postcss.config.mjs includes @csstools/postcss-oklab-function.
    Verify .env.example exists with all keys.
  </verify>
  <done>
    Color system renders correctly with oklch values flowing through CSS vars to Tailwind classes. PostCSS fallback plugin installed. All required packages installed. .env.example documents all required environment variables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types and environment validation</name>
  <files>
    src/types/database.ts
    src/types/auth.ts
    src/lib/env.ts
  </files>
  <action>
    1. Create src/types/database.ts with TypeScript interfaces for ALL 9+ database tables from the roadmap schema:

       ```typescript
       // Tenant table
       export interface Tenant {
         id: string; // UUID
         name: string;
         slug: string;
         logo_url: string | null;
         primary_color: string; // hex color, default '#d4af37'
         secondary_color: string; // hex color, default '#f4d47f'
         is_active: boolean;
         created_at: string; // ISO timestamp
         updated_at: string;
       }

       // User table (maps to auth.users + public.users)
       export interface User {
         id: string; // UUID, matches auth.users.id
         tenant_id: string | null; // null for super_admin
         email: string;
         full_name: string;
         role: UserRole;
         is_active: boolean;
         created_at: string;
         updated_at: string;
       }

       // Persona table
       export interface Persona {
         id: string;
         tenant_id: string;
         name: string;
         description: string | null;
         filters: PersonaFilters;
         is_starter: boolean;
         created_by: string; // user id
         last_used_at: string | null;
         created_at: string;
         updated_at: string;
       }

       export interface PersonaFilters {
         job_titles?: string[];
         seniority_levels?: string[];
         industries?: string[];
         locations?: string[];
         company_size_ranges?: string[];
         keywords?: string[];
       }

       // Prospect table
       export interface Prospect {
         id: string;
         tenant_id: string;
         apollo_id: string | null;
         first_name: string;
         last_name: string;
         full_name: string;
         title: string | null;
         company: string | null;
         location: string | null;
         work_email: string | null;
         work_phone: string | null;
         personal_email: string | null;
         personal_phone: string | null;
         linkedin_url: string | null;
         enrichment_status: EnrichmentStatus;
         enriched_at: string | null;
         created_at: string;
         updated_at: string;
       }

       export type EnrichmentStatus = 'none' | 'pending' | 'in_progress' | 'complete' | 'failed';

       // SEC Transaction table
       export interface SecTransaction {
         id: string;
         prospect_id: string;
         tenant_id: string;
         transaction_date: string;
         security_title: string;
         transaction_type: string; // 'purchase' | 'sale' | 'exercise'
         transaction_shares: number;
         price_per_share: number;
         transaction_value: number;
         filing_url: string | null;
         created_at: string;
       }

       // Prospect Summary table (AI-generated)
       export interface ProspectSummary {
         id: string;
         prospect_id: string;
         tenant_id: string;
         summary_text: string;
         generated_at: string;
         model_used: string; // e.g. 'claude-3-haiku'
         token_count: number;
         created_at: string;
       }

       // List table
       export interface List {
         id: string;
         tenant_id: string;
         name: string;
         description: string | null;
         created_by: string; // user id
         member_count: number;
         created_at: string;
         updated_at: string;
       }

       // List Member table (junction)
       export interface ListMember {
         id: string;
         list_id: string;
         prospect_id: string;
         tenant_id: string;
         status: ListMemberStatus;
         notes: string | null;
         added_by: string; // user id
         created_at: string;
         updated_at: string;
       }

       export type ListMemberStatus = 'new' | 'contacted' | 'responded' | 'not_interested';

       // Activity Log table
       export interface ActivityLog {
         id: string;
         tenant_id: string;
         user_id: string;
         action_type: ActivityActionType;
         target_type: 'prospect' | 'list' | 'persona' | 'user' | 'tenant' | null;
         target_id: string | null;
         metadata: Record<string, unknown> | null;
         created_at: string;
       }

       export type ActivityActionType =
         | 'login'
         | 'search_executed'
         | 'profile_viewed'
         | 'profile_enriched'
         | 'add_to_list'
         | 'remove_from_list'
         | 'status_updated'
         | 'note_added'
         | 'csv_exported'
         | 'persona_created'
         | 'lookalike_search';

       // Usage Metrics Daily table
       export interface UsageMetricsDaily {
         id: string;
         tenant_id: string;
         user_id: string;
         date: string; // YYYY-MM-DD
         logins: number;
         searches: number;
         profiles_viewed: number;
         profiles_enriched: number;
         csv_exports: number;
         lists_created: number;
         created_at: string;
         updated_at: string;
       }
       ```

    2. Create src/types/auth.ts:

       ```typescript
       export type UserRole = 'super_admin' | 'tenant_admin' | 'agent' | 'assistant';

       // Role hierarchy for comparison (higher number = more privileges)
       export const ROLE_HIERARCHY: Record<UserRole, number> = {
         assistant: 0,
         agent: 1,
         tenant_admin: 2,
         super_admin: 3,
       };

       // Permissions matrix
       export const ROLE_PERMISSIONS: Record<UserRole, {
         canView: boolean;
         canCreate: boolean;
         canEdit: boolean;
         canDelete: boolean;
         canManageUsers: boolean;
         canManageTenants: boolean;
         canAccessAdmin: boolean;
       }> = {
         assistant: {
           canView: true,
           canCreate: false,
           canEdit: false,
           canDelete: false,
           canManageUsers: false,
           canManageTenants: false,
           canAccessAdmin: false,
         },
         agent: {
           canView: true,
           canCreate: true,
           canEdit: true,
           canDelete: false,
           canManageUsers: false,
           canManageTenants: false,
           canAccessAdmin: false,
         },
         tenant_admin: {
           canView: true,
           canCreate: true,
           canEdit: true,
           canDelete: true,
           canManageUsers: true,
           canManageTenants: false,
           canAccessAdmin: false,
         },
         super_admin: {
           canView: true,
           canCreate: true,
           canEdit: true,
           canDelete: true,
           canManageUsers: true,
           canManageTenants: true,
           canAccessAdmin: true,
         },
       };

       // Session user with tenant context
       export interface SessionUser {
         id: string;
         email: string;
         role: UserRole;
         tenantId: string | null; // null for super_admin
         fullName: string;
       }

       // JWT custom claims shape
       export interface CustomClaims {
         user_role: UserRole;
         tenant_id: string | null;
       }

       // Helper type guard
       export function isValidRole(role: string): role is UserRole {
         return ['super_admin', 'tenant_admin', 'agent', 'assistant'].includes(role);
       }

       export function hasMinRole(userRole: UserRole, requiredRole: UserRole): boolean {
         return ROLE_HIERARCHY[userRole] >= ROLE_HIERARCHY[requiredRole];
       }
       ```

    3. Create src/lib/env.ts with Zod validation:

       ```typescript
       import { z } from 'zod';

       // Only validate in server context (not in browser)
       const isServer = typeof window === 'undefined';

       const serverEnvSchema = z.object({
         NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
         NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),
         SUPABASE_SERVICE_ROLE_KEY: z.string().min(1),
         UPSTASH_REDIS_REST_URL: z.string().url().optional(),
         UPSTASH_REDIS_REST_TOKEN: z.string().min(1).optional(),
       });

       // Client-safe env vars (available in browser)
       const clientEnvSchema = z.object({
         NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
         NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),
       });

       export type ServerEnv = z.infer<typeof serverEnvSchema>;
       export type ClientEnv = z.infer<typeof clientEnvSchema>;

       function getServerEnv(): ServerEnv {
         const parsed = serverEnvSchema.safeParse(process.env);
         if (!parsed.success) {
           console.error('❌ Invalid server environment variables:', parsed.error.flatten().fieldErrors);
           throw new Error('Invalid server environment variables');
         }
         return parsed.data;
       }

       function getClientEnv(): ClientEnv {
         const parsed = clientEnvSchema.safeParse({
           NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,
           NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
         });
         if (!parsed.success) {
           console.error('❌ Invalid client environment variables:', parsed.error.flatten().fieldErrors);
           throw new Error('Invalid client environment variables');
         }
         return parsed.data;
       }

       // Lazy initialization to avoid build-time errors
       let _serverEnv: ServerEnv | null = null;
       let _clientEnv: ClientEnv | null = null;

       export const env = {
         get server(): ServerEnv {
           if (!isServer) throw new Error('Cannot access server env vars in browser');
           if (!_serverEnv) _serverEnv = getServerEnv();
           return _serverEnv;
         },
         get client(): ClientEnv {
           if (!_clientEnv) _clientEnv = getClientEnv();
           return _clientEnv;
         },
       };
       ```

    Make sure all files use correct import paths with the @/ alias.
    DO NOT make env validation eager (lazy init) to avoid breaking dev builds without all keys present.
  </action>
  <verify>
    Run `pnpm build` or `npx tsc --noEmit` — no TypeScript errors.
    Verify src/types/database.ts exports all table interfaces.
    Verify src/types/auth.ts exports UserRole, ROLE_HIERARCHY, ROLE_PERMISSIONS, SessionUser.
    Verify src/lib/env.ts exports env object with server and client getters.
  </verify>
  <done>
    TypeScript types exist for all 9 database tables, 4 auth roles with permissions matrix, and environment variables are validated via Zod with lazy initialization. All types are importable from @/types/database, @/types/auth, and @/lib/env.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` completes without CSS or TypeScript errors
2. No `hsl()` wrappers remain in tailwind.config.ts (grep for "hsl(" returns 0 matches)
3. globals.css has no duplicate :root blocks
4. src/types/database.ts compiles and exports all 9+ table interfaces
5. src/types/auth.ts compiles and exports role types with permissions
6. src/lib/env.ts compiles and exports env object
7. .env.example exists with all required keys
</verification>

<success_criteria>
- Color system works: Tailwind classes like `bg-primary`, `text-foreground` render correctly with oklch values
- Types are complete: Every database table from the roadmap has a TypeScript interface
- Env validation works: Importing `env.server` in a Server Component provides type-safe access to validated env vars
- All packages installed: @supabase/ssr, @supabase/supabase-js, @upstash/redis, zod, jwt-decode
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
