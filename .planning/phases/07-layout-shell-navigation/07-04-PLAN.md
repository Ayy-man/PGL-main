# Plan 07-04: Wire TopBar into Admin Layout + Add Admin Mobile Sidebar

---
wave: 2
depends_on:
  - 07-02
files_modified:
  - src/app/admin/layout.tsx
autonomous: true
---

## Goal

Replace the bare text `<header>` in the admin layout with the Phase 6 `TopBar` component. Remove duplicate ambient glow divs. Add mobile support for the admin sidebar (currently `hidden lg:flex` with no mobile fallback — admin is completely unusable on mobile). The admin sidebar should use the same Sheet-based mobile pattern as the tenant MobileSidebar.

## must_haves

- Inline `<header>` with "Admin Dashboard" text replaced with `<TopBar>` component
- TopBar receives `userName` and `userInitials` from `requireSuperAdmin()` session user
- Duplicate `ambient-glow-top` and `ambient-glow-bottom` divs removed from admin layout
- Desktop admin sidebar still renders at 220px with `hidden lg:flex`
- Mobile: hamburger button + Sheet-based admin sidebar drawer added
- Sheet drawer renders the admin sidebar content (PGL header + AdminNavLinks + footer)
- Sheet closes on navigation (usePathname effect, same as MobileSidebar)
- Mobile hamburger bar is `lg:hidden`, desktop sidebar is `hidden lg:flex`
- Admin layout still calls `requireSuperAdmin()` for auth guard
- `page-enter` class still applied to main content

## Tasks

<task id="07-04-T1">
<title>Create AdminMobileSidebar client component</title>
<description>
Create a new file `src/app/admin/admin-mobile-sidebar.tsx` that provides mobile navigation for the admin layout. This follows the exact same pattern as `src/components/layout/mobile-sidebar.tsx` but with admin-specific content.

```typescript
"use client";

import { useState, useEffect } from "react";
import { usePathname } from "next/navigation";
import { Menu } from "lucide-react";
import { Button } from "@/components/ui/button";
import {
  Sheet,
  SheetContent,
  SheetTitle,
} from "@/components/ui/sheet";
import { AdminNavLinks } from "./admin-nav-links";

interface AdminMobileSidebarProps {
  userEmail: string;
}

export function AdminMobileSidebar({ userEmail }: AdminMobileSidebarProps) {
  const [open, setOpen] = useState(false);
  const pathname = usePathname();

  // Close sidebar on navigation
  useEffect(() => {
    setOpen(false);
  }, [pathname]);

  return (
    <div className="lg:hidden">
      {/* Fixed mobile header bar */}
      <div
        className="fixed top-0 left-0 right-0 z-40 flex h-14 items-center gap-3 px-4"
        style={{
          background: "rgba(8,8,10,0.85)",
          backdropFilter: "blur(12px)",
          borderBottom: "1px solid var(--border-subtle)",
        }}
      >
        <Button
          variant="ghost"
          size="icon"
          onClick={() => setOpen(true)}
          aria-label="Open admin navigation menu"
          className="h-9 w-9"
        >
          <Menu className="h-5 w-5" />
        </Button>
        <span className="font-serif text-sm font-semibold text-foreground">
          PGL Admin
        </span>
      </div>

      {/* Spacer to push content below fixed header */}
      <div className="h-14" />

      {/* Sheet drawer */}
      <Sheet open={open} onOpenChange={setOpen}>
        <SheetContent
          side="left"
          className="p-0"
          style={{
            width: "220px",
            background: "var(--bg-sidebar)",
            borderRight: "1px solid var(--border-sidebar)",
          }}
        >
          <SheetTitle className="sr-only">Admin Navigation</SheetTitle>
          <div className="flex h-full flex-col">
            {/* Admin header */}
            <div className="px-5 py-5">
              <div className="flex items-center gap-3">
                <div
                  className="flex h-9 w-9 shrink-0 items-center justify-center rounded-full font-serif font-bold text-sm"
                  style={{
                    background: "linear-gradient(135deg, rgba(212,175,55,0.2), rgba(212,175,55,0.05))",
                    color: "var(--gold-primary)",
                    border: "1px solid var(--border-gold)",
                  }}
                >
                  P
                </div>
                <div className="flex flex-col min-w-0">
                  <span className="text-sm font-semibold text-foreground">PGL</span>
                  <span
                    className="text-[11px] uppercase tracking-wider"
                    style={{ color: "var(--gold-text)" }}
                  >
                    Admin Console
                  </span>
                </div>
              </div>
            </div>

            {/* Navigation */}
            <nav className="flex-1 overflow-y-auto py-2 px-3">
              <AdminNavLinks />
            </nav>

            {/* Footer */}
            <div className="mt-auto px-5 py-4">
              <p
                className="text-[11px] truncate"
                style={{ color: "var(--text-ghost)" }}
              >
                {userEmail}
              </p>
            </div>
          </div>
        </SheetContent>
      </Sheet>
    </div>
  );
}
```

Key decisions:
- Follows exact same structure as tenant MobileSidebar
- Admin header (PGL + "Admin Console") matches the desktop admin sidebar header
- AdminNavLinks is reused (it's already a client component)
- userEmail passed as prop from the server layout
- Sheet closes on pathname change
</description>
</task>

<task id="07-04-T2">
<title>Refactor admin layout: wire TopBar, remove ambient glows, add mobile sidebar</title>
<description>
In `src/app/admin/layout.tsx`:

1. **Add imports:**
```typescript
import { requireSuperAdmin } from "@/lib/auth/rbac";
import { AdminNavLinks } from "./admin-nav-links";
import { AdminMobileSidebar } from "./admin-mobile-sidebar";
import { TopBar } from "@/components/layout/top-bar";
```

2. **Extract user data for TopBar** — the `requireSuperAdmin()` call returns a `SessionUser` with `fullName` and `email`. Use these:
```typescript
const user = await requireSuperAdmin();
const userName = user.fullName || user.email || "Admin";
const userInitials = userName.charAt(0).toUpperCase() || "A";
```

3. **Remove duplicate ambient glow divs** — delete:
```tsx
<div className="ambient-glow-top" aria-hidden="true" />
<div className="ambient-glow-bottom" aria-hidden="true" />
```

4. **Add `hidden lg:flex` to the desktop admin sidebar `<aside>`** — it already has `sticky top-0 flex h-screen flex-col` but needs `hidden lg:flex` instead of just `flex` so it hides on mobile:
```tsx
<aside
  className="hidden lg:flex sticky top-0 h-screen flex-col"
  style={{ ... }}
>
```

5. **Add AdminMobileSidebar** — render it alongside the desktop sidebar:
```tsx
<AdminMobileSidebar userEmail={user.email} />
```

6. **Replace the inline `<header>` block** (the one with "Admin Dashboard" text) with:
```tsx
<TopBar userName={userName} userInitials={userInitials} />
```

7. **Final layout JSX:**
```tsx
return (
  <div
    className="flex min-h-screen"
    style={{ backgroundColor: "var(--bg-root)" }}
  >
    <div className="relative z-10 flex flex-1">
      {/* Desktop admin sidebar */}
      <aside
        className="hidden lg:flex sticky top-0 h-screen flex-col"
        style={{
          width: "220px",
          background: "var(--bg-sidebar)",
          borderRight: "1px solid var(--border-sidebar)",
        }}
      >
        {/* Admin header */}
        <div className="px-5 py-5">
          <div className="flex items-center gap-3">
            <div
              className="flex h-9 w-9 shrink-0 items-center justify-center rounded-full font-serif font-bold text-sm"
              style={{
                background: "linear-gradient(135deg, rgba(212,175,55,0.2), rgba(212,175,55,0.05))",
                color: "var(--gold-primary)",
                border: "1px solid var(--border-gold)",
              }}
            >
              P
            </div>
            <div className="flex flex-col min-w-0">
              <span className="text-sm font-semibold text-foreground">PGL</span>
              <span
                className="text-[11px] uppercase tracking-wider"
                style={{ color: "var(--gold-text)" }}
              >
                Admin Console
              </span>
            </div>
          </div>
        </div>

        <nav className="flex-1 overflow-y-auto py-2 px-3">
          <AdminNavLinks />
        </nav>

        <div className="mt-auto px-5 py-4">
          <p
            className="text-[11px] truncate"
            style={{ color: "var(--text-ghost)" }}
          >
            {user.email}
          </p>
        </div>
      </aside>

      {/* Mobile admin sidebar */}
      <AdminMobileSidebar userEmail={user.email} />

      {/* Main content */}
      <div className="flex flex-1 flex-col min-w-0">
        <TopBar userName={userName} userInitials={userInitials} />

        <main className="flex-1 overflow-y-auto">
          <div className="page-enter p-6 lg:p-8">
            {children}
          </div>
        </main>
      </div>
    </div>
  </div>
);
```

8. **Do NOT change** the `requireSuperAdmin()` auth guard.
</description>
</task>

## Verification

- `pnpm build` passes with no errors
- No duplicate ambient glow divs in admin pages (only root layout renders them)
- Admin desktop: 220px sidebar with 4 nav items + TopBar with search input, bell, user avatar
- Admin mobile (<lg): hamburger button + Sheet drawer with admin nav + AdminMobileSidebar header
- TopBar shows admin user's initials (from fullName or email)
- TopBar hidden on mobile, AdminMobileSidebar header shown instead
- Sheet closes when navigating between admin pages
- Admin still requires super_admin role to access
