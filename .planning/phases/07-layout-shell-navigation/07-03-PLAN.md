# Plan 07-03: Wire TopBar into Tenant Layout

---
wave: 2
depends_on:
  - 07-01
files_modified:
  - src/app/[orgId]/layout.tsx
  - src/components/layout/top-bar.tsx
autonomous: true
---

## Goal

Replace the inline `<header>` markup in the tenant layout with the Phase 6 `TopBar` component. Remove duplicate ambient glow divs (root layout already renders them). Pass user name and initials from the Supabase session to TopBar props. Add MobileSidebar hamburger visibility coordination so the TopBar does not render a second mobile bar when the MobileSidebar is visible.

## must_haves

- Inline `<header>` block in `src/app/[orgId]/layout.tsx` replaced with `<TopBar>` component import
- TopBar receives `userName` and `userInitials` props derived from user session data
- Duplicate `ambient-glow-top` and `ambient-glow-bottom` divs removed from tenant layout (root layout handles them)
- TopBar z-index is `z-20` (below Sheet which is z-50) — consistent with Phase 6 component
- `Search` and `Bell` imports removed from layout.tsx (no longer needed — TopBar handles its own icons)
- `page-enter` class still applied to main content wrapper
- Layout still fetches user and tenant data, redirects on missing auth, and calls `notFound()` for inactive tenants
- Mobile: TopBar hidden below `lg` breakpoint since MobileSidebar has its own fixed header bar

## Tasks

<task id="07-03-T1">
<title>Update TopBar to hide on mobile (below lg breakpoint)</title>
<description>
In `src/components/layout/top-bar.tsx`:

The MobileSidebar component already renders its own fixed header bar (with hamburger + tenant name) at `lg:hidden`. To avoid a double top bar on mobile, add `hidden lg:flex` to the TopBar's root `<header>` element, so it only shows on desktop (lg+).

Change:
```tsx
className="sticky top-0 z-20 flex h-14 items-center justify-between px-6"
```

To:
```tsx
className="sticky top-0 z-20 hidden lg:flex h-14 items-center justify-between px-6"
```

This ensures:
- Desktop (lg+): TopBar visible, MobileSidebar hidden
- Mobile (<lg): MobileSidebar header visible, TopBar hidden
</description>
</task>

<task id="07-03-T2">
<title>Replace inline header with TopBar component in tenant layout</title>
<description>
In `src/app/[orgId]/layout.tsx`:

1. **Update imports** — remove `Search` and `Bell` from lucide-react (they're no longer used). Add TopBar import:
```typescript
import { createClient } from "@/lib/supabase/server";
import { notFound, redirect } from "next/navigation";
import { Sidebar } from "@/components/layout/sidebar";
import { TopBar } from "@/components/layout/top-bar";
```

2. **Extract user data for TopBar** — after the existing `user` fetch (which already exists), add:
```typescript
const userName = user?.user_metadata?.full_name ?? user?.email ?? "User";
const userInitials = userName.charAt(0).toUpperCase() || "?";
```

3. **Remove duplicate ambient glow divs** — delete these two lines from the JSX:
```tsx
<div className="ambient-glow-top" aria-hidden="true" />
<div className="ambient-glow-bottom" aria-hidden="true" />
```
The root `layout.tsx` already renders these.

4. **Replace the inline `<header>...</header>` block** with:
```tsx
<TopBar userName={userName} userInitials={userInitials} />
```

5. **Final layout JSX should be:**
```tsx
return (
  <div
    className="flex min-h-screen"
    style={{ backgroundColor: "var(--bg-root)" }}
  >
    {/* Content layer — above ambient glow (rendered in root layout) */}
    <div className="relative z-10 flex flex-1">
      <Sidebar
        orgId={orgId}
        tenantName={tenant.name}
        logoUrl={tenant.logo_url}
      />

      <div className="flex flex-1 flex-col min-w-0">
        <TopBar userName={userName} userInitials={userInitials} />

        {/* Page content with fade-in animation */}
        <main className="flex-1 overflow-y-auto">
          <div className="page-enter p-6">
            {children}
          </div>
        </main>
      </div>
    </div>
  </div>
);
```

6. **Do NOT change** the auth check, tenant lookup, or `notFound()` logic.
</description>
</task>

## Verification

- `pnpm build` passes with no errors
- No duplicate ambient glow divs (inspect DOM — only root layout renders them)
- TopBar renders on desktop with search input, notification bell, and user avatar showing initials
- TopBar is hidden on mobile (<lg breakpoint) — MobileSidebar header takes over
- User initials are derived from session (first char of full_name or email)
- No `Search` or `Bell` imports remain in layout.tsx
