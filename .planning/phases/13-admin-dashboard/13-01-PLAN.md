# Plan 13-01: Restore Quota API Route + Build ApiQuotaCard + Wire into PlatformPulse

---
phase: 13-admin-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/admin/quota/route.ts
  - src/components/admin/api-quota-card.tsx
  - src/components/admin/platform-pulse.tsx
  - src/app/admin/page.tsx
autonomous: true
requirements: [SA-01, ANLY-03]

must_haves:
  truths:
    - "Super admin sees live API quota burn data per provider (Apollo, ContactOut, Exa, EDGAR, Claude) on the admin dashboard"
    - "Quota card shows 7-day cumulative totals with relative progress bars"
    - "Quota card gracefully shows zeros/empty state when Redis has no data or is unavailable"
    - "ComingSoonCard wrapper is removed from the PlatformPulse grid — ApiQuotaCard renders directly"
  artifacts:
    - path: "src/app/api/admin/quota/route.ts"
      provides: "Admin quota API endpoint reading api_usage:* keys from Upstash Redis"
      exports: ["GET"]
    - path: "src/components/admin/api-quota-card.tsx"
      provides: "Live API quota card with progress bars per provider"
      exports: ["ApiQuotaCard"]
    - path: "src/components/admin/platform-pulse.tsx"
      provides: "PlatformPulse grid with ApiQuotaCard replacing ComingSoonCard"
    - path: "src/app/admin/page.tsx"
      provides: "Admin page fetching quota data and passing to PlatformPulse"
  key_links:
    - from: "src/app/admin/page.tsx"
      to: "/api/admin/quota"
      via: "fetch in fetchAll callback"
      pattern: "fetch.*api/admin/quota"
    - from: "src/components/admin/platform-pulse.tsx"
      to: "src/components/admin/api-quota-card.tsx"
      via: "import and render ApiQuotaCard with quotaData prop"
      pattern: "ApiQuotaCard"
    - from: "src/app/api/admin/quota/route.ts"
      to: "src/lib/cache/redis.ts"
      via: "redis.mget for api_usage keys"
      pattern: "redis\\.mget"
---

<objective>
Restore the deleted `/api/admin/quota` API route, create a live `ApiQuotaCard` component, and wire it into PlatformPulse replacing the `ComingSoonCard` placeholder.

Purpose: The API quota card is the last stat card in the PlatformPulse grid. It was previously a placeholder behind a "Coming Soon" overlay. The Redis tracking infrastructure (`track-api-usage.ts`) already writes `api_usage:{provider}:{YYYY-MM-DD}` keys. This plan builds the read side and the UI to display it.

Output: Working quota API route, live quota card component, PlatformPulse grid with 4 real cards (no placeholders).
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/13-admin-dashboard/13-RESEARCH.md

@src/lib/cache/redis.ts
@src/lib/supabase/server.ts
@src/components/admin/platform-pulse.tsx
@src/components/admin/coming-soon-card.tsx
@src/app/admin/page.tsx
@src/app/api/admin/dashboard/route.ts

<interfaces>
From src/lib/cache/redis.ts:
```typescript
export const redis: Redis; // Upstash Redis proxy — supports .mget(), .get(), .pipeline(), etc.
```

From src/lib/supabase/server.ts:
```typescript
export async function createClient(): Promise<SupabaseClient>;
```

Existing admin auth guard pattern (from src/app/api/admin/dashboard/route.ts):
```typescript
export const dynamic = "force-dynamic";
export async function GET() {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user || user.app_metadata?.role !== "super_admin") {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }
  // ... admin logic
}
```

Redis key pattern (from track-api-usage 2.ts):
```typescript
const key = `api_usage:${provider}:${today}`; // provider: "apollo" | "contactout" | "exa" | "edgar" | "claude"
```

PlatformPulse props:
```typescript
interface PlatformPulseProps {
  data: {
    totalProspects: number;
    enrichmentCoverage: number;
    enrichmentFailed: number;
    activeUsersToday: number;
    activeUsers7dAvg: number;
  } | null;
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restore /api/admin/quota route and create ApiQuotaCard component</name>
  <files>src/app/api/admin/quota/route.ts, src/components/admin/api-quota-card.tsx</files>
  <action>
**File 1: `src/app/api/admin/quota/route.ts`** — Create from scratch (was deleted).

```typescript
import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";
import { redis } from "@/lib/cache/redis";

export const dynamic = "force-dynamic";

const PROVIDERS = ["apollo", "contactout", "exa", "edgar", "claude"] as const;
const DEFAULT_DAYS = 7;

export async function GET(request: NextRequest) {
  // Inline super_admin check — NOT requireSuperAdmin() (Phase 04 decision: avoid redirect() 500 in Route Handler context)
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user || user.app_metadata?.role !== "super_admin") {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const { searchParams } = new URL(request.url);
  const days = parseInt(searchParams.get("days") ?? String(DEFAULT_DAYS), 10);

  // Build date strings for the last N days
  const dates: string[] = [];
  for (let i = 0; i < days; i++) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    dates.push(d.toISOString().slice(0, 10));
  }

  // Build all Redis keys: api_usage:{provider}:{date}
  const keys = PROVIDERS.flatMap((p) => dates.map((d) => `api_usage:${p}:${d}`));

  try {
    const values = await redis.mget<(number | null)[]>(...keys);
    // Aggregate by provider — each provider has `days` consecutive entries
    const totals: Record<string, number> = {};
    PROVIDERS.forEach((p, pi) => {
      totals[p] = dates.reduce((sum, _, di) => {
        const idx = pi * days + di;
        return sum + (values[idx] ?? 0);
      }, 0);
    });
    return NextResponse.json({ totals, days });
  } catch {
    // Redis unavailable — degrade gracefully, return zeros
    const totals = Object.fromEntries(PROVIDERS.map((p) => [p, 0]));
    return NextResponse.json({ totals, days });
  }
}
```

Key decisions:
- Inline auth check (not `requireSuperAdmin()`) per Phase 04 locked decision
- `redis.mget` for batch reads (single round-trip)
- Graceful degradation: returns zeros if Redis throws
- `dynamic = "force-dynamic"` for auth cookie access

**File 2: `src/components/admin/api-quota-card.tsx`** — Create new component.

```typescript
"use client";

import { Activity } from "lucide-react";

interface QuotaData {
  totals: Record<string, number>;
  days: number;
}

interface ApiQuotaCardProps {
  data: QuotaData | null;
}

const PROVIDERS = [
  { key: "apollo", label: "Apollo" },
  { key: "contactout", label: "ContactOut" },
  { key: "exa", label: "Exa" },
  { key: "edgar", label: "EDGAR" },
  { key: "claude", label: "Claude" },
];

export function ApiQuotaCard({ data }: ApiQuotaCardProps) {
  // Skeleton state
  if (data === null) {
    return (
      <div className="surface-admin-card rounded-[14px] p-5 animate-pulse">
        <div className="flex items-center justify-between mb-4">
          <div className="h-3 w-28 bg-white/[0.06] rounded" />
          <div className="h-4 w-4 bg-white/[0.06] rounded" />
        </div>
        <div className="space-y-2.5 mt-3">
          {Array.from({ length: 5 }).map((_, i) => (
            <div key={i} className="flex items-center gap-2">
              <div className="h-3 w-20 bg-white/[0.06] rounded" />
              <div className="flex-1 h-1.5 bg-white/[0.06] rounded-full" />
              <div className="h-3 w-8 bg-white/[0.06] rounded" />
            </div>
          ))}
        </div>
      </div>
    );
  }

  const allZero = Object.values(data.totals).every((v) => v === 0);
  const maxValue = Math.max(...Object.values(data.totals), 1);

  return (
    <div className="surface-admin-card rounded-[14px] p-5">
      <div className="flex items-center justify-between mb-3">
        <p
          className="text-xs font-semibold uppercase tracking-wider"
          style={{ color: "var(--admin-text-secondary)" }}
        >
          API Quota Burn ({data.days}d)
        </p>
        <Activity
          className="h-4 w-4 shrink-0"
          style={{ color: "var(--admin-text-secondary)", opacity: 0.7 }}
        />
      </div>

      {allZero ? (
        <p
          className="text-xs py-4 text-center"
          style={{ color: "var(--admin-text-secondary)" }}
        >
          No API usage data yet
        </p>
      ) : (
        <div className="space-y-2">
          {PROVIDERS.map(({ key, label }) => {
            const count = data.totals[key] ?? 0;
            const pct = maxValue > 0 ? Math.round((count / maxValue) * 100) : 0;
            return (
              <div key={key} className="flex items-center gap-2">
                <span
                  className="text-xs w-20 shrink-0"
                  style={{ color: "var(--admin-text-secondary)" }}
                >
                  {label}
                </span>
                <div className="flex-1 h-1.5 bg-white/[0.06] rounded-full overflow-hidden">
                  <div
                    className="h-1.5 rounded-full transition-all duration-500"
                    style={{
                      width: `${pct}%`,
                      background: "var(--gold-primary)",
                    }}
                  />
                </div>
                <span
                  className="text-xs font-mono w-10 text-right shrink-0"
                  style={{
                    color: count > 0 ? "var(--gold-primary)" : "var(--text-secondary)",
                  }}
                >
                  {count > 999 ? `${(count / 1000).toFixed(1)}k` : count}
                </span>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}
```

Key decisions:
- `surface-admin-card` CSS utility class per design system
- `rounded-[14px]` per MASTER.md border radius spec for cards
- Gold progress bars (`var(--gold-primary)`)
- Gold text for non-zero values, `var(--text-secondary)` for zero
- All labels use `var(--admin-text-secondary)` — no raw Tailwind color classes
- `font-mono` for numeric values per MASTER.md data typography
- Skeleton shimmer uses `bg-white/[0.06]` — acceptable per research compliance note
- Empty state shows "No API usage data yet" centered text
  </action>
  <verify>
    <automated>cd /Users/aymanbaig/Desktop/Manual\ Library/Phronesis-main && npx tsc --noEmit src/app/api/admin/quota/route.ts src/components/admin/api-quota-card.tsx 2>&1 | head -20</automated>
  </verify>
  <done>
    - `/api/admin/quota` route exists, exports GET, returns `{ totals: Record<string,number>, days: number }`
    - `ApiQuotaCard` component exports and renders: skeleton when `data === null`, empty state when all zeros, progress bars when data present
    - All CSS uses design system variables — no raw Tailwind color classes
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire ApiQuotaCard into PlatformPulse and admin page data fetching</name>
  <files>src/components/admin/platform-pulse.tsx, src/app/admin/page.tsx</files>
  <action>
**File 1: `src/components/admin/platform-pulse.tsx`** — Replace ComingSoonCard + ApiQuotaPlaceholder with live ApiQuotaCard.

1. Remove the `ComingSoonCard` import:
   ```diff
   - import { ComingSoonCard } from "@/components/admin/coming-soon-card";
   ```

2. Add the `ApiQuotaCard` import:
   ```diff
   + import { ApiQuotaCard } from "@/components/admin/api-quota-card";
   ```

3. Remove the entire `ApiQuotaPlaceholder` function component (lines ~71-102 in current file).

4. Update the `PlatformPulseProps` interface to accept `quotaData`:
   ```typescript
   interface PlatformPulseProps {
     data: {
       totalProspects: number;
       enrichmentCoverage: number;
       enrichmentFailed: number;
       activeUsersToday: number;
       activeUsers7dAvg: number;
     } | null;
     quotaData?: { totals: Record<string, number>; days: number } | null;
   }
   ```

5. Update the `PlatformPulse` function signature to accept `quotaData`:
   ```typescript
   export function PlatformPulse({ data, quotaData }: PlatformPulseProps) {
   ```

6. In the skeleton state (when `data === null`), keep 4 `SkeletonCard` elements — no change needed.

7. In the rendered grid, replace:
   ```tsx
   <ComingSoonCard>
     <ApiQuotaPlaceholder />
   </ComingSoonCard>
   ```
   with:
   ```tsx
   <ApiQuotaCard data={quotaData ?? null} />
   ```

8. Remove the `Activity` import from Lucide if it was only used by `ApiQuotaPlaceholder`. Check — `Activity` is still used by the Enrichment Pipeline StatCard icon, so keep it.

**File 2: `src/app/admin/page.tsx`** — Add quota data fetching.

1. Add `quotaData` state:
   ```typescript
   const [quotaData, setQuotaData] = useState<{ totals: Record<string, number>; days: number } | null>(null);
   ```

2. In the `fetchAll` callback, add the quota fetch to the `Promise.all`:
   ```typescript
   const [pulseRes, heatmapRes, enrichmentRes, funnelRes, errorRes, quotaRes] =
     await Promise.all([
       fetch("/api/admin/dashboard"),
       fetch("/api/admin/tenants/activity"),
       fetch("/api/admin/enrichment/health?days=14"),
       fetch("/api/admin/funnel?days=7"),
       fetch(`/api/admin/errors?limit=50&page=${errorPageRef.current}`),
       fetch("/api/admin/quota?days=7"),
     ]);
   ```

3. Parse the quota response:
   ```typescript
   const [pulse, heatmap, enrichment, funnel, errors, quota] = await Promise.all([
     pulseRes.ok ? pulseRes.json() : null,
     heatmapRes.ok ? heatmapRes.json() : null,
     enrichmentRes.ok ? enrichmentRes.json() : null,
     funnelRes.ok ? funnelRes.json() : null,
     errorRes.ok ? errorRes.json() : null,
     quotaRes.ok ? quotaRes.json() : null,
   ]);
   ```

4. Set the quota state:
   ```typescript
   if (quota) setQuotaData(quota);
   ```

5. Pass `quotaData` to PlatformPulse:
   ```tsx
   <PlatformPulse data={pulseData} quotaData={quotaData} />
   ```

Do NOT modify the 60-second polling interval logic, the error feed pagination, or the seconds-ago ticker — those are correct as-is.
  </action>
  <verify>
    <automated>cd /Users/aymanbaig/Desktop/Manual\ Library/Phronesis-main && pnpm build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - `PlatformPulse` renders `ApiQuotaCard` instead of `ComingSoonCard` wrapper
    - `PlatformPulse` accepts `quotaData` prop
    - Admin page fetches `/api/admin/quota?days=7` alongside other admin API calls
    - `quotaData` passed through to `PlatformPulse`
    - `ComingSoonCard` import removed from `platform-pulse.tsx`
    - `ApiQuotaPlaceholder` function deleted from `platform-pulse.tsx`
    - `pnpm build` passes with no errors
  </done>
</task>

</tasks>

<verification>
- `pnpm build` passes with no TypeScript or import errors
- `/api/admin/quota` route exists with GET export and `force-dynamic`
- `ApiQuotaCard` component renders: skeleton (null data), empty state (all zeros), progress bars (real data)
- `PlatformPulse` no longer imports `ComingSoonCard`
- `PlatformPulse` renders 4 cards: Total Prospects, Enrichment Pipeline, API Quota Burn, Active Users Today
- Admin page fetches 6 API endpoints (dashboard, tenants/activity, enrichment/health, funnel, errors, quota)
- No raw Tailwind color classes in new code — all CSS variables
</verification>

<success_criteria>
- `pnpm build` passes clean
- The admin dashboard PlatformPulse grid shows 4 real stat cards with no "Coming Soon" overlay
- Quota API route returns `{ totals, days }` JSON with graceful Redis fallback
- ApiQuotaCard displays per-provider bars with gold styling matching design system
</success_criteria>

<output>
After completion, create `.planning/phases/13-admin-dashboard/13-01-SUMMARY.md`
</output>
